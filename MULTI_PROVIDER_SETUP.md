# ๐ ะะฐัััะพะนะบะฐ Multi-Provider Architecture

Multi-provider ะฐััะธัะตะบัััะฐ **ะฟะพะปะฝะพัััั ัะตะฐะปะธะทะพะฒะฐะฝะฐ**! ะขะตะฟะตัั ะผะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะบะฐะบ Gemini (ะฑะตัะฟะปะฐัะฝะพ), ัะฐะบ ะธ Claude API.

## โ ะงัะพ ะณะพัะพะฒะพ

- โ **Claude Provider** - ัะตัะฐะบัะพัะธะฝะณ ะธะท ัััะตััะฒัััะตะณะพ ะบะพะดะฐ
- โ **Gemini Provider** - ะฝะพะฒะฐั ัะตะฐะปะธะทะฐัะธั ั ะฑะตัะฟะปะฐัะฝัะผ tier
- โ **Provider Factory** - ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะฑะพั ะธ fallback
- โ **ะะฝัะตะณัะฐัะธั** - ะพะฑะฝะพะฒะปัะฝ `/api/chat` ัะฝะดะฟะพะธะฝั
- โ **ะะพะฝัะธะณััะฐัะธั** - ะฟะพะดะดะตัะถะบะฐ `.env` ะฟะตัะตะผะตะฝะฝัั

## ๐ ะัััััะน ััะฐัั

### 1. ะะพะปััะธัั API ะบะปัั Gemini (ะฑะตัะฟะปะฐัะฝะพ)

1. ะะตัะตะนัะธ ะฝะฐ [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)
2. ะะพะนัะธ ั Google ะฐะบะบะฐัะฝัะพะผ
3. ะะฐะถะฐัั **"Create API Key"**
4. ะกะบะพะฟะธัะพะฒะฐัั ะบะปัั (ัะพัะผะฐั: `AIzaSy...`)

**ะะตัะฟะปะฐัะฝัะน ะปะธะผะธั:** 15 ะทะฐะฟัะพัะพะฒ ะฒ ะผะธะฝััั, ะดะพััะฐัะพัะฝะพ ะดะปั ัะฐะทัะฐะฑะพัะบะธ!

### 2. ะะฐัััะพะธัั `.env`

ะัะบัะพะนัะต `ai-consultant-api/.env` ะธ ะดะพะฑะฐะฒััะต:

```env
# ะัะฑะพั ะฟัะพะฒะฐะนะดะตัะฐ (gemini | claude)
AI_PROVIDER=gemini

# Gemini API (ะฑะตัะฟะปะฐัะฝัะน)
GEMINI_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXX
GEMINI_MODEL=gemini-2.0-flash-exp

# Claude API (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะตัะปะธ ะตััั ะดะตะฝัะณะธ)
ANTHROPIC_API_KEY=sk-ant-api03-xxxxx
CLAUDE_MODEL=claude-sonnet-4-20250514
```

**ะะฐะถะฝะพ:** ะัะถะตะฝ ัะพัั ะฑั **ะพะดะธะฝ** API ะบะปัั (Gemini ะธะปะธ Claude).

### 3. ะะฐะฟัััะธัั ัะตัะฒะตั

```bash
cd ai-consultant-api
npm install  # ะฃััะฐะฝะพะฒะธั @google/generative-ai
npm run dev
```

ะกะตัะฒะตั ะทะฐะฟัััะธััั ะฝะฐ `http://localhost:3001`

## ๐ ะะตัะตะบะปััะตะฝะธะต ะผะตะถะดั ะฟัะพะฒะฐะนะดะตัะฐะผะธ

### ะงะตัะตะท `.env` (ัะตะบะพะผะตะฝะดัะตััั)

ะะทะผะตะฝะธัะต `AI_PROVIDER` ะฒ `.env`:

```env
AI_PROVIDER=gemini   # ะัะฟะพะปัะทะพะฒะฐัั Gemini
AI_PROVIDER=claude   # ะัะฟะพะปัะทะพะฒะฐัั Claude
```

ะะตัะตะทะฐะฟัััะธัะต ัะตัะฒะตั.

### ะะฒัะพะผะฐัะธัะตัะบะธะน Fallback

ะัะปะธ ะฒัะฑัะฐะฝะฝัะน ะฟัะพะฒะฐะนะดะตั ะฝะตะดะพัััะฟะตะฝ (ะฝะตั API ะบะปััะฐ ะธะปะธ API ะฝะต ะพัะฒะตัะฐะตั), ัะธััะตะผะฐ **ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตะบะปััะธััั** ะฝะฐ ะดะพัััะฟะฝัะน ะฟัะพะฒะฐะนะดะตั.

ะัะธะผะตั ะปะพะณะพะฒ:

```
[ProviderFactory] Preferred provider claude is not configured, using fallback...
[ProviderFactory] Fallback to gemini provider
```

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะัะพะฒะตัะธัั ะดะพัััะฟะฝัะต ะฟัะพะฒะฐะนะดะตัั

```bash
cd ai-consultant-api
node -e "
const { ProviderFactory } = require('./dist/services/ai/index.js');
const available = ProviderFactory.getAvailableProviders();
console.log('ะะพัััะฟะฝัะต ะฟัะพะฒะฐะนะดะตัั:', available);
"
```

### ะขะตัั ัะตัะตะท API

```bash
curl -X POST http://localhost:3001/api/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "messages": [
      {"role": "user", "content": "ะัะธะฒะตั! ะะฐะนะดะธ ะฒัั ะพะฑะพััะดะพะฒะฐะฝะธะต"}
    ]
  }'
```

ะัะฒะตั ะฑัะดะตั ัะพะดะตัะถะฐัั:

```json
{
  "success": true,
  "data": {
    "message": "ะะฐะนะดะตะฝะพ 5 ะตะดะธะฝะธั ะพะฑะพััะดะพะฒะฐะฝะธั...",
    "toolsUsed": ["get_all_equipment"],
    "provider": "Gemini",
    "tokensUsed": {
      "input": 1234,
      "output": 567
    }
  }
}
```

ะะพะปะต `provider` ะฟะพะบะฐะถะตั ะบะฐะบะพะน ะฟัะพะฒะฐะนะดะตั ะฑัะป ะธัะฟะพะปัะทะพะฒะฐะฝ.

## ๐ ะกัะฐะฒะฝะตะฝะธะต ะฟัะพะฒะฐะนะดะตัะพะฒ

| ะัะพะฒะฐะนะดะตั | ะกัะพะธะผะพััั | ะะธะผะธัั (ะฑะตัะฟะปะฐัะฝะพ) | ะะพะดะตะปั ะฟะพ ัะผะพะปัะฐะฝะธั | ะกะบะพัะพััั |
|-----------|-----------|-------------------|---------------------|----------|
| **Gemini** | ๐ข ะะตัะฟะปะฐัะฝะพ | 15 req/min | gemini-2.0-flash-exp | โกโกโก ะััััะพ |
| **Claude** | ๐ด ะะปะฐัะฝะพ | - | claude-sonnet-4-5 | โกโก ะกัะตะดะฝะต |
| OpenAI | ๐ด ะะปะฐัะฝะพ | - | (ะฝะต ัะตะฐะปะธะทะพะฒะฐะฝ) | - |

**ะะตะบะพะผะตะฝะดะฐัะธั:** ะัะฟะพะปัะทัะนัะต Gemini ะดะปั ัะฐะทัะฐะฑะพัะบะธ, Claude ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ (ะตัะปะธ ะฝัะถะฝะฐ ะผะฐะบัะธะผะฐะปัะฝะฐั ัะพัะฝะพััั).

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/chat                                     โ
โ         โ                                           โ
โ  ProviderFactory.create()                           โ
โ         โโ ะัะพะฒะตัะบะฐ AI_PROVIDER ะฒ .env              โ
โ         โโ ะัะพะฒะตัะบะฐ isAvailable()                   โ
โ         โโ Fallback ะฝะฐ ะดะพัััะฟะฝัะน ะฟัะพะฒะฐะนะดะตั          โ
โ         โ                                           โ
โ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ         โ
โ  โ ClaudeProvider   โ  โ GeminiProvider   โ         โ
โ  โ (anthropic SDK)  โ  โ (generative-ai)  โ         โ
โ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ         โ
โ         โ                      โ                    โ
โ  ะะณะตะฝัะฝัะน ัะธะบะป ั tool calling                       โ
โ         โ                                           โ
โ  ะะพะทะฒัะฐั { message, toolsUsed, provider }           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## โ๏ธ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

### ะะฑัะทะฐัะตะปัะฝัะต (ะพะดะฝะฐ ะธะท ะณััะฟะฟ)

**Gemini:**
- `GEMINI_API_KEY` - API ะบะปัั Google AI Studio

**Claude:**
- `ANTHROPIC_API_KEY` - API ะบะปัั Anthropic

### ะะฟัะธะพะฝะฐะปัะฝัะต

- `AI_PROVIDER` - ะัะตะดะฟะพัะธัะฐะตะผัะน ะฟัะพะฒะฐะนะดะตั (default: `gemini`)
- `GEMINI_MODEL` - ะะพะดะตะปั Gemini (default: `gemini-2.0-flash-exp`)
- `CLAUDE_MODEL` - ะะพะดะตะปั Claude (default: `claude-sonnet-4-20250514`)

### ะััะฐะปัะฝัะต (ะฝะต ะธะทะผะตะฝะธะปะธัั)

- `SUPABASE_URL`, `SUPABASE_SERVICE_KEY` - ะะปั JWT ะฐะฒัะพัะธะทะฐัะธะธ
- `GAS_API_URL` - URL Google Apps Script ะดะปั ัะฐะฑะพัั ั ะพะฑะพััะดะพะฒะฐะฝะธะตะผ
- `PORT`, `NODE_ENV`, `ALLOWED_ORIGINS` - ะะฐัััะพะนะบะธ ัะตัะฒะตัะฐ

## ๐ Troubleshooting

### ะัะธะฑะบะฐ: "No AI providers available"

**ะัะธัะธะฝะฐ:** ะะต ะฝะฐัััะพะตะฝ ะฝะธ ะพะดะธะฝ API ะบะปัั.

**ะะตัะตะฝะธะต:** ะะพะฑะฐะฒััะต `GEMINI_API_KEY` ะธะปะธ `ANTHROPIC_API_KEY` ะฒ `.env`.

---

### ะัะธะฑะบะฐ: "API_KEY_INVALID" (Gemini)

**ะัะธัะธะฝะฐ:** ะะตะฒะตัะฝัะน ัะพัะผะฐั ะธะปะธ ัััะฐัะตะฒัะธะน API ะบะปัั.

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ัะพัะผะฐั ะบะปััะฐ (ะดะพะปะถะตะฝ ะฝะฐัะธะฝะฐัััั ั `AIzaSy`)
2. ะกะพะทะดะฐะนัะต ะฝะพะฒัะน ะบะปัั ะฝะฐ [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)

---

### ะัะธะฑะบะฐ: "RESOURCE_EXHAUSTED" (Gemini)

**ะัะธัะธะฝะฐ:** ะัะตะฒััะตะฝ ะปะธะผะธั 15 ะทะฐะฟัะพัะพะฒ ะฒ ะผะธะฝััั.

**ะะตัะตะฝะธะต:**
- ะะพะดะพะถะดะธัะต ะผะธะฝััั
- ะะปะธ ะฝะฐัััะพะนัะต Claude API ะบะฐะบ fallback

---

### ะัะพะฒะฐะนะดะตั ะฟะพััะพัะฝะฝะพ ะฟะตัะตะบะปััะฐะตััั ะฝะฐ fallback

**ะัะธัะธะฝะฐ:** ะัะฝะพะฒะฝะพะน ะฟัะพะฒะฐะนะดะตั ะฝะต ะฟัะพัะพะดะธั ะฟัะพะฒะตัะบั `isAvailable()`.

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ะธะฝัะตัะฝะตั ัะพะตะดะธะฝะตะฝะธะต
2. ะัะพะฒะตัััะต ะฟัะฐะฒะธะปัะฝะพััั API ะบะปััะฐ
3. ะัะพะฒะตัััะต ะปะพะณะธ: `[ProviderFactory] ...`

## ๐ ะะพะฟะพะปะฝะธัะตะปัะฝะพ

- **ะะพะปะฝัะน ะฟะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ:** `doc/multi-provider-implementation-plan.md`
- **ะััะพะดะฝัะน ะบะพะด ะฟัะพะฒะฐะนะดะตัะพะฒ:** `ai-consultant-api/src/services/ai/providers/`
- **ะะดะฐะฟัะตัั ะดะปั tool calling:** `ai-consultant-api/src/services/ai/adapters/`

## ๐ ะะพัะพะฒะพ!

ะขะตะฟะตัั ั ะฒะฐั ะตััั:
- โ ะะตัะฟะปะฐัะฝัะน AI ะฟัะพะฒะฐะนะดะตั (Gemini)
- โ ะะฒัะพะผะฐัะธัะตัะบะธะน fallback
- โ ะะพะทะผะพะถะฝะพััั ะดะพะฑะฐะฒะธัั ะดััะณะธะต ะฟัะพะฒะฐะนะดะตัั (OpenAI, Ollama)
- โ ะกะพััะฐะฝัะฝะฝัะน ััะฐััะน ะบะพะด (anthropic.ts) ะฝะฐ ัะปััะฐะน ะพัะบะฐัะฐ

**ะัะพัะตััะธััะนัะต ัะธััะตะผั ะธ ะฝะฐัะธะฝะฐะนัะต ัะฐะทัะฐะฑะพัะบั!** ๐
