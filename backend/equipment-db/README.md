# API для базы данных оборудования

Google Apps Script веб-приложение для работы с базой данных оборудования в Google Sheets.

## Установка

### Шаг 1: Откройте Google Apps Script

1. Откройте вашу Google Sheets таблицу **"База данных оборудования"**
2. В меню выберите: **Расширения → Apps Script**
3. Откроется редактор Google Apps Script

### Шаг 2: Скопируйте код

1. Удалите весь код по умолчанию (функция `myFunction`)
2. Откройте файл `Code.gs` из папки `backend/equipment-db/`
3. Скопируйте весь код
4. Вставьте в редактор Google Apps Script
5. Сохраните проект: **Ctrl+S** или кнопка **Сохранить**
6. Назовите проект: **"API для базы данных оборудования"** (вверху слева)

### Шаг 3: Google Drive API (для создания папок)

**Хорошая новость:** `DriveApp` доступен в Google Apps Script по умолчанию, отдельное включение не требуется!

**Что нужно сделать для предоставления разрешений:**

#### Вариант 1: Авторизация через выполнение функции (РЕКОМЕНДУЕТСЯ)
1. После копирования кода в Google Apps Script, найдите функцию `requestDrivePermissions` в конце файла
2. В меню выберите: **Выполнить → requestDrivePermissions**
3. Google покажет окно авторизации:
   - Нажмите **Разрешить**
   - Выберите ваш аккаунт Google
   - Нажмите **Продолжить**
   - Нажмите **Разрешить** для доступа к Google Drive
4. После авторизации проверьте работу: **Выполнить → testCreateDriveFolder**

#### Вариант 2: Авторизация через развертывание
1. При развертывании веб-приложения (Шаг 4) Google автоматически запросит доступ
2. Нажмите **Разрешить** когда появится запрос
3. Обязательно разрешите доступ к **Google Drive**

#### Вариант 3: Ручная авторизация
1. Откройте: https://myaccount.google.com/permissions
2. Найдите "Apps Script" в списке приложений
3. Нажмите на приложение и проверьте разрешения
4. Если Google Drive не указан, удалите приложение и авторизуйтесь заново

**Примечание:** Если окно авторизации не появляется, попробуйте:
- Обновить страницу Google Apps Script (F5)
- Очистить кеш браузера
- Использовать режим инкогнито
- Запустить функцию `requestDrivePermissions` еще раз

### Шаг 4: Опубликуйте как веб-приложение

1. Нажмите **Развернуть → Новое развертывание**
2. Нажмите на значок шестеренки ⚙️ рядом с "Тип"
3. Выберите **Веб-приложение**
4. Заполните настройки:
   - **Описание:** API для базы данных оборудования
   - **Выполнять от имени:** **Меня** ⚠️ (ВАЖНО для создания папок!)
     - Если выбрать "Меня" - папки будут создаваться в Google Drive автора скрипта (вашего аккаунта)
     - Если выбрать "Пользователя, открывающего веб-приложение" - папки будут создаваться в Drive каждого пользователя (требует авторизации)
   - **У кого есть доступ:** **Все** ⚠️ (ОБЯЗАТЕЛЬНО для работы CORS!)
5. Нажмите **Развернуть**
6. При первом развертывании Google запросит авторизацию:
   - Нажмите **Разрешить**
   - Выберите ваш аккаунт (тот, в чьем Drive должны создаваться папки)
   - Нажмите **Продолжить**
   - Нажмите **Разрешить** для доступа к:
     - ✅ Google Sheets (для работы с таблицей)
     - ✅ Google Drive (для создания папок) ⚠️ **ОБЯЗАТЕЛЬНО!**
7. **ВАЖНО:** Скопируйте **URL веб-приложения** (он появится после развертывания)

**⚠️ ВАЖНО для создания папок:**
- Убедитесь, что вы разрешили доступ к **Google Drive** при авторизации
- Если папки не создаются, проверьте логи в Google Apps Script: **Вид → Логи**
- Папки будут создаваться в корне Google Drive аккаунта, указанного в "Выполнять от имени"

**Примечание:** Если вы обновили код, нужно обновить развертывание:
- **Развернуть → Управление развертываниями**
- Нажмите на карандаш ✏️ рядом с существующим развертыванием
- **Проверьте, что "У кого есть доступ" установлено в "Все"** ⚠️
- Нажмите **Развернуть** (версия обновится автоматически)

**⚠️ КРИТИЧЕСКИ ВАЖНО для CORS:**
Если вы видите ошибки CORS в консоли браузера:
1. **Убедитесь, что "У кого есть доступ" = "Все"** (не "Только я"!)
2. Если это не помогло, **удалите старое развертывание** и создайте новое
3. При создании нового развертывания обязательно выберите **"Все"** в поле "У кого есть доступ"
4. После создания нового развертывания скопируйте новый URL и обновите его в `src/config/api.ts`

**⚠️ ВАЖНО для CORS:**
- Доступ установлен как **"Все"** (не "Только я" или "Пользователи организации")
- Развертывание обновлено после изменения кода
- Если все еще возникают CORS ошибки:
  1. Удалите старое развертывание
  2. Создайте новое развертывание с настройками:
     - **Выполнять от имени:** Меня
     - **У кого есть доступ:** **Все** (обязательно!)
  3. Скопируйте новый URL и обновите его в `src/config/api.ts`

### Шаг 5: Сохраните URL

Скопированный URL понадобится для настройки frontend приложения.

Пример URL:
```
https://script.google.com/macros/s/AKfycby.../exec
```

## Тестирование API

### Тест 1: Проверка работы

1. Откройте скопированный URL веб-приложения в браузере
2. Добавьте к URL: `?action=getAll`
3. Должен вернуться JSON:
   ```json
   {
     "success": true,
     "data": []
   }
   ```
   (Пустой массив, если в таблице еще нет данных)

### Тест 2: Через консоль браузера

Откройте консоль браузера (F12) и выполните:
```javascript
fetch('ВАШ_URL?action=getAll')
  .then(r => r.json())
  .then(console.log);
```

## API Endpoints

### GET запросы

#### Получить все оборудование
```
GET ?action=getAll
```

#### Получить по ID
```
GET ?action=getById&id=UUID
```

#### Получить по типу
```
GET ?action=getByType&type=filter
```

### POST запросы

#### Добавить оборудование
```
POST
Content-Type: application/json

{
  "action": "add",
  "name": "Фильтр обезжелезивания ФО-0,8-1,5 №1",
  "type": "filter",
  "specs": {
    "height": "1,5 м",
    "diameter": "0,8 м"
  },
  "googleDriveUrl": "https://...",
  "qrCodeUrl": "https://...",
  "status": "active"
}
```

#### Обновить оборудование
```
POST
Content-Type: application/json

{
  "action": "update",
  "id": "UUID",
  "name": "Новое название",
  "lastMaintenanceDate": "2024-01-25"
}
```

#### Создать папку в Google Drive
```
POST
Content-Type: application/json

{
  "action": "createFolder",
  "name": "Фильтр обезжелезивания ФО-0,8-1,5 №1",
  "parentFolderId": "опционально - ID родительской папки"
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "folderId": "1a2b3c4d5e6f7g8h9i0j",
    "folderUrl": "https://drive.google.com/drive/folders/1a2b3c4d5e6f7g8h9i0j",
    "folderName": "Фильтр обезжелезивания ФО-0,8-1,5 №1"
  }
}
```

#### Удалить оборудование (архивировать)
```
POST
Content-Type: application/json

{
  "action": "delete",
  "id": "UUID"
}
```

## Формат данных

### Типы оборудования
- `filter` - Фильтр
- `pump` - Насос
- `tank` - Резервуар
- `valve` - Клапан
- `other` - Другое

### Статусы
- `active` - Активен
- `inactive` - Неактивен
- `archived` - Архивирован

## Обработка ошибок

Все ответы имеют формат:
```json
{
  "success": true/false,
  "data": {...} или "error": "Сообщение об ошибке"
}
```

## Просмотр логов

Если что-то не работает:
1. В Google Apps Script: **Вид → Логи**
2. Выполните запрос к API
3. Проверьте логи на наличие ошибок

## Устранение проблем

### Папки не создаются в Google Drive

**Симптомы:**
- Оборудование создается, но поле `googleDriveUrl` остается пустым
- В логах появляются ошибки о доступе к Google Drive

**Решения:**

1. **Проверьте авторизацию:**
   - Откройте **Развернуть → Управление развертываниями**
   - Нажмите на карандаш ✏️ рядом с развертыванием
   - Убедитесь, что **"Выполнять от имени"** установлено в **"Меня"**
   - Это означает, что папки будут создаваться в Google Drive аккаунта, под которым вы развернули скрипт

2. **Проверьте разрешения:**
   - При развертывании веб-приложения Google должен был запросить доступ к Google Drive
   - Если вы не разрешили доступ, нужно переразвернуть:
     - **Развернуть → Управление развертываниями**
     - Удалите старое развертывание
     - Создайте новое развертывание и **обязательно разрешите доступ к Google Drive**

3. **Проверьте логи:**
   - Откройте **Вид → Логи** в Google Apps Script
   - Создайте новое оборудование через API
   - Проверьте логи на наличие ошибок:
     - Если видите "Нет доступа к Google Drive" - проблема с авторизацией
     - Если видите "Нет прав на создание папок" - проблема с настройками развертывания
     - Если видите "Недостаточно места" - освободите место в Google Drive

4. **Проверьте аккаунт:**
   - Убедитесь, что вы используете правильный Google аккаунт
   - Папки создаются в Drive того аккаунта, который указан в "Выполнять от имени"
   - Проверьте, что у этого аккаунта есть доступ к Google Drive и достаточно места

5. **Ручная проверка:**
   - Откройте Google Apps Script редактор
   - Создайте временную функцию для теста:
     ```javascript
     function testDriveAccess() {
       try {
         const folder = DriveApp.createFolder('Тестовая папка');
         Logger.log('✅ Успешно! Папка создана: ' + folder.getUrl());
         folder.setTrashed(true); // Удаляем тестовую папку
       } catch (error) {
         Logger.log('❌ Ошибка: ' + error.toString());
       }
     }
     ```
   - Запустите функцию: **Выполнить → testDriveAccess**
   - Проверьте логи - если ошибка, значит проблема с доступом к Drive

## Следующий шаг

После успешного развертывания и тестирования API:
- Сохраните URL веб-приложения
- Переходите к Шагу 3: Обновление TypeScript типов и создание API клиента

