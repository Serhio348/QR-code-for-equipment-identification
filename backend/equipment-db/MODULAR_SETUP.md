# Инструкция по развертыванию модульной структуры в Google Apps Script

## Как работают модули в Google Apps Script

### Важно понимать:

1. **Все файлы .gs в одном проекте автоматически доступны глобально**
   - Функции из `Utils.gs` доступны в `Code.gs`
   - Функции из `ResponseHelpers.gs` доступны везде
   - Не нужно импортировать или подключать файлы

2. **Проект привязан к Google Sheets таблице**
   - Когда вы открываете Google Sheets и создаете скрипт через "Расширения → Apps Script"
   - Проект автоматически привязан к этой таблице
   - `SpreadsheetApp.getActiveSpreadsheet()` работает с этой таблицей

3. **Все модули работают с одной и той же таблицей**
   - Все функции используют `SpreadsheetApp.getActiveSpreadsheet()`
   - Это означает, что все модули работают с таблицей, к которой привязан проект

---

## Пошаговая инструкция по развертыванию модулей

### Шаг 1: Откройте Google Apps Script

1. Откройте вашу Google Sheets таблицу **"База данных оборудования"**
2. В меню выберите: **Расширения → Apps Script**
3. Откроется редактор Google Apps Script

**Важно:** Проект уже привязан к этой таблице! Все функции будут работать с этой таблицей.

---

### Шаг 2: Создайте файлы модулей

В редакторе Google Apps Script:

1. **Создайте файл `Utils.gs`:**
   - Слева в панели файлов нажмите **+** (плюс) или **Файл → Создать → Скрипт**
   - Назовите файл: `Utils`
   - Скопируйте содержимое из `backend/equipment-db/Utils.gs`
   - Вставьте в редактор
   - Сохраните: **Ctrl+S**

2. **Создайте файл `ResponseHelpers.gs`:**
   - Создайте новый файл: **+** или **Файл → Создать → Скрипт**
   - Назовите файл: `ResponseHelpers`
   - Скопируйте содержимое из `backend/equipment-db/ResponseHelpers.gs`
   - Вставьте в редактор
   - Сохраните: **Ctrl+S**

3. **Обновите файл `Code.gs`:**
   - Откройте существующий файл `Code.gs`
   - Удалите функции, которые теперь в модулях:
     - `formatDate()` (строки ~1265-1318)
     - `generateId()` (строки ~1331-1334)
     - `createJsonResponse()` (строки ~1565-1574)
     - `createErrorResponse()` (строки ~1590-1599)
   - Сохраните: **Ctrl+S**

**Проверка:** Функции из модулей автоматически доступны в `Code.gs` - они будут работать!

---

### Шаг 3: Проверьте работу модулей

1. **Тест функции из Utils.gs:**
   - В редакторе создайте временную функцию:
     ```javascript
     function testUtils() {
       const id = generateId();
       Logger.log('Generated ID: ' + id);
       
       const date = formatDate(new Date());
       Logger.log('Formatted date: ' + date);
     }
     ```
   - Запустите: **Выполнить → testUtils**
   - Проверьте логи: **Вид → Логи**
   - Если видите ID и дату - модуль работает! ✅

2. **Тест функции из ResponseHelpers.gs:**
   - Создайте временную функцию:
     ```javascript
     function testResponseHelpers() {
       const response = createJsonResponse({ test: 'data' });
       Logger.log('Response: ' + response.getContent());
     }
     ```
   - Запустите: **Выполнить → testResponseHelpers**
   - Проверьте логи
   - Если видите JSON ответ - модуль работает! ✅

---

### Шаг 4: Проверьте работу с Google Sheets

1. **Тест работы с таблицей:**
   - Создайте временную функцию:
     ```javascript
     function testSheetAccess() {
       const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
       const sheet = spreadsheet.getSheetByName('Оборудование');
       
       if (sheet) {
         Logger.log('✅ Лист "Оборудование" найден');
         Logger.log('Количество строк: ' + sheet.getLastRow());
       } else {
         Logger.log('⚠️ Лист "Оборудование" не найден');
       }
     }
     ```
   - Запустите: **Выполнить → testSheetAccess**
   - Проверьте логи
   - Если видите информацию о листе - таблица привязана! ✅

---

### Шаг 5: Обновите развертывание

После добавления модулей нужно обновить развертывание:

1. **Развернуть → Управление развертываниями**
2. Нажмите на **карандаш** ✏️ рядом с существующим развертыванием
3. **ВАЖНО:** Проверьте настройки:
   - **Выполнять от имени:** Меня
   - **У кого есть доступ:** **Все** ⚠️ (обязательно для CORS!)
4. Нажмите **Развернуть**
5. Версия обновится автоматически

**Примечание:** URL веб-приложения не изменится, но код будет обновлен.

---

## Структура файлов в Google Apps Script

После развертывания модулей структура будет такой:

```
Проект: "API для базы данных оборудования"
├── Code.gs                    (HTTP обработчики)
├── Utils.gs                   (утилиты)
├── ResponseHelpers.gs         (формирование ответов)
└── ... (другие модули по мере добавления)
```

**Все файлы работают с одной таблицей:**
- `SpreadsheetApp.getActiveSpreadsheet()` → ваша таблица "База данных оборудования"
- Все модули используют эту таблицу автоматически

---

## Как добавить новые модули

Когда мы будем добавлять следующие модули (SheetHelpers.gs, EquipmentQueries.gs и т.д.):

1. **Создайте новый файл** в Google Apps Script редакторе
2. **Назовите файл** (например, `SheetHelpers`)
3. **Скопируйте код** из соответствующего файла в `backend/equipment-db/`
4. **Сохраните** (Ctrl+S)
5. **Обновите развертывание** (Шаг 5 выше)

**Функции автоматически станут доступны:**
- В `Code.gs`
- В других модулях
- Везде в проекте

---

## Проверка привязки к таблице

### Как убедиться, что проект привязан к правильной таблице:

1. **В редакторе Google Apps Script:**
   - Посмотрите вверху страницы - должно быть название проекта
   - Рядом должна быть ссылка на Google Sheets таблицу

2. **Проверьте через код:**
   ```javascript
   function checkSpreadsheet() {
     const ss = SpreadsheetApp.getActiveSpreadsheet();
     Logger.log('Название таблицы: ' + ss.getName());
     Logger.log('URL таблицы: ' + ss.getUrl());
   }
   ```
   - Запустите функцию
   - Проверьте логи - должно быть название вашей таблицы

3. **Если проект не привязан:**
   - Откройте Google Sheets таблицу
   - **Расширения → Apps Script**
   - Проект автоматически привяжется к этой таблице

---

## Важные замечания

### ✅ Что работает автоматически:

- Все функции из всех файлов доступны везде
- `SpreadsheetApp.getActiveSpreadsheet()` работает с привязанной таблицей
- Не нужно импортировать или подключать модули
- Порядок файлов в редакторе не важен

### ⚠️ Что нужно помнить:

- Все модули должны быть в **одном проекте** Google Apps Script
- Проект должен быть привязан к **правильной таблице**
- После изменения кода нужно **обновить развертывание**
- Настройки развертывания: **"У кого есть доступ" = "Все"** (для CORS)

---

## Следующие шаги

После успешного развертывания `Utils.gs` и `ResponseHelpers.gs`:

1. ✅ Убедитесь, что все работает
2. ✅ Протестируйте API endpoints
3. ⏳ Переходим к следующему этапу: `SheetHelpers.gs`

---

## Устранение проблем

### Проблема: "Функция не найдена"

**Решение:**
- Убедитесь, что файл сохранен (Ctrl+S)
- Проверьте, что функция названа правильно
- Обновите развертывание

### Проблема: "Таблица не найдена"

**Решение:**
- Убедитесь, что проект открыт через "Расширения → Apps Script" из таблицы
- Проверьте, что используете `SpreadsheetApp.getActiveSpreadsheet()`
- Убедитесь, что лист "Оборудование" существует в таблице

### Проблема: "CORS ошибки"

**Решение:**
- Проверьте настройки развертывания: **"У кого есть доступ" = "Все"**
- Обновите развертывание
- Если не помогло - создайте новое развертывание

