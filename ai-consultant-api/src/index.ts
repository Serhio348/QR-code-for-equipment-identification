/**
 * index.ts
 *
 * Ð¢Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° (entry point) AI Consultant API ÑÐµÑ€Ð²ÐµÑ€Ð°.
 *
 * Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚ Express-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ,
 * Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ middleware Ð¸ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹, Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ HTTP-ÑÐµÑ€Ð²ÐµÑ€.
 *
 * ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  index.ts (ÑÑ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð») â€” Ñ‚Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°                        â”‚
 * â”‚       â†“                                                     â”‚
 * â”‚  validateConfig() â€” Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° .env Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…                â”‚
 * â”‚       â†“                                                     â”‚
 * â”‚  Middleware pipeline:                                       â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
 * â”‚  â”‚  helmet()        â€” HTTP-Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸        â”‚  â”‚
 * â”‚  â”‚  cors()          â€” Cross-Origin Resource Sharing      â”‚  â”‚
 * â”‚  â”‚  express.json()  â€” Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ JSON body                  â”‚  â”‚
 * â”‚  â”‚  request logger  â€” Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²      â”‚  â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
 * â”‚       â†“                                                     â”‚
 * â”‚  ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹:                                                  â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
 * â”‚  â”‚  /health     â†’ healthRouter  (GET â€” health-check)     â”‚  â”‚
 * â”‚  â”‚  /api/chat   â†’ chatRouter    (POST â€” Claude AI Ñ‡Ð°Ñ‚)   â”‚  â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
 * â”‚       â†“                                                     â”‚
 * â”‚  404 handler  â€” Ð½ÐµÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹                     â”‚
 * â”‚  Error handler â€” Ð½ÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸                      â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * ÐŸÐ¾Ñ€ÑÐ´Ð¾Ðº middleware Ð’ÐÐ–Ð•Ð:
 * Express Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ middleware Ð² Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ Ð¸Ñ… Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ (app.use).
 * Helmet Ð¸ CORS Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð”Ðž Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð², Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸
 * Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ»Ð¸ÑÑŒ ÐºÐ¾ Ð²ÑÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ð¼.
 * 404 Ð¸ Error handler Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÐŸÐžÐ¡Ð›Ð• Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²,
 * Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹.
 */

// ============================================
// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹
// ============================================

// Express â€” HTTP-Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€Ðº Ð´Ð»Ñ Node.js
import express from 'express';

// cors â€” middleware Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Cross-Origin Resource Sharing.
// Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÑ‚ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ñƒ (localhost:5173 Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð´Ð¾Ð¼ÐµÐ½)
// Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº API Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð¿Ð¾Ñ€Ñ‚Ñƒ/Ð´Ð¾Ð¼ÐµÐ½Ðµ
import cors from 'cors';

// helmet â€” middleware Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸.
// Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ HTTP-Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸: X-Content-Type-Options, X-Frame-Options,
// Strict-Transport-Security, Content-Security-Policy Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ.
// Ð—Ð°Ñ‰Ð¸Ñ‰Ð°ÐµÑ‚ Ð¾Ñ‚ XSS, clickjacking, MIME-sniffing Ð°Ñ‚Ð°Ðº
import helmet from 'helmet';

// config â€” Ð¾Ð±ÑŠÐµÐºÑ‚ Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹ Ð¸Ð· .env (Ð¿Ð¾Ñ€Ñ‚, ÐºÐ»ÑŽÑ‡Ð¸ API, CORS origins)
// validateConfig â€” Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
import { config, validateConfig, logProviderConfig } from './config/env.js';

// chatRouter â€” Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ñ‡Ð°Ñ‚Ð° Ñ Claude AI (POST /api/chat)
import chatRouter from './routes/chat.js';

// healthRouter â€” health-check ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ (GET /health)
import healthRouter from './routes/health.js';

// equipmentRouter â€” Ð¿Ñ€Ð¾ÐºÑÐ¸ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² Google Drive (POST /api/equipment/*)
import equipmentRouter from './routes/equipment.js';

// ============================================
// Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
// ============================================

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ð½Ñ‹ Ð² .env:
// - anthropicApiKey (Claude API)
// - supabaseUrl, supabaseServiceKey (Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ)
// - gasApiUrl (Google Apps Script API)
// Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ³Ð¾-Ñ‚Ð¾ Ð½Ðµ Ñ…Ð²Ð°Ñ‚Ð°ÐµÑ‚ â€” Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÐ¿Ð°Ð´Ñ‘Ñ‚ Ñ Ð¿Ð¾Ð½ÑÑ‚Ð½Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹
// Ð”Ðž Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°, Ð° Ð½Ðµ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
validateConfig();
logProviderConfig();

// ============================================
// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Express Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
// ============================================

const app = express();

// ============================================
// Middleware
// ============================================

// --- CORS (Ð’ÐÐ–ÐÐž: Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÐŸÐ•Ð Ð•Ð” helmet) ---
// Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ Ð´Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… origins (Ð¸Ð· .env ALLOWED_ORIGINS).
// credentials: true â€” Ñ€Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ cookies Ð¸ Authorization Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð².
// Ð‘ÐµÐ· CORS Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð° Ðº API,
// ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð½Ð° Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¿Ð¾Ñ€Ñ‚Ð°Ñ… (5173 vs 3001)
const corsOptions = {
  origin: (origin: string | undefined, callback: (err: Error | null, allow?: boolean) => void) => {
    // Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð±ÐµÐ· origin (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Postman, curl)
    if (!origin) {
      console.log('âœ… CORS: Request without origin (Postman/curl) - allowed');
      return callback(null, true);
    }

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ origin Ð² ÑÐ¿Ð¸ÑÐºÐµ Ñ€Ð°Ð·Ñ€ÐµÑˆÑ‘Ð½Ð½Ñ‹Ñ…
    if (config.allowedOrigins.includes(origin)) {
      console.log(`âœ… CORS: Allowed origin: ${origin}`);
      callback(null, true);
    } else {
      console.warn(`âŒ CORS: Blocked origin: ${origin}`);
      console.warn(`   Allowed origins: ${config.allowedOrigins.join(', ')}`);
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  exposedHeaders: ['Content-Length', 'Content-Type'],
  maxAge: 86400, // 24 hours - ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ preflight Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
};

app.use(cors(corsOptions));

// Ð¯Ð²Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° OPTIONS Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð´Ð»Ñ CORS pre-flight
app.options('*', cors(corsOptions));

// --- Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ ---
// helmet() Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ ~15 HTTP-Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð² Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸.
// ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ: https://helmetjs.github.io/
// Ð’ÐÐ–ÐÐž: Ð¿Ð¾ÑÐ»Ðµ CORS, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ CORS Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸
app.use(helmet({
  crossOriginResourcePolicy: false, // ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¼ÐµÑˆÐ°Ð» CORS
}));

// --- ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ JSON ---
// ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ð°Ñ€ÑÐ¸Ñ‚ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ñ Content-Type: application/json.
// limit: '1mb' â€” Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ‚ÐµÐ»Ð° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°.
// Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Express Ñ€Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÑ‚ 100kb)
app.use(express.json({ limit: '15mb' }));

// --- Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² ---
// ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ request logger â€” Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ.
// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: "2025-01-15T10:30:00.000Z GET /health"
// Ð’ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð° morgan Ð¸Ð»Ð¸ winston
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} ${req.method} ${req.path}`);
  next();
});

// ============================================
// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ (Routes)
// ============================================

// Health-check â€” GET /health
// ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ (Ð±ÐµÐ· Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸) Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
app.use('/health', healthRouter);

// Ð§Ð°Ñ‚ Ñ AI â€” POST /api/chat
// Ð—Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½ authMiddleware Ð²Ð½ÑƒÑ‚Ñ€Ð¸ chatRouter.
// ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚ Claude
app.use('/api/chat', chatRouter);

// ÐŸÑ€Ð¾ÐºÑÐ¸ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð² â€” POST /api/equipment/*
// Ð¤Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ POST Ð½Ð° GAS (CORS preflight Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚ÑÑ).
// Ð­Ñ‚Ð¾Ñ‚ Ñ€Ð¾ÑƒÑ‚ÐµÑ€ Ð¿Ñ€Ð¾ÐºÑÐ¸Ñ€ÑƒÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ñ‡ÐµÑ€ÐµÐ· Node.js Ð±ÑÐºÐµÐ½Ð´.
app.use('/api/equipment', equipmentRouter);

// ============================================
// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° 404 (Not Found)
// ============================================

// Ð­Ñ‚Ð¾Ñ‚ middleware ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚, ÐµÑÐ»Ð¸ Ð½Ð¸ Ð¾Ð´Ð¸Ð½ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ Ð²Ñ‹ÑˆÐµ Ð½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ð·Ð°Ð¿Ñ€Ð¾Ñ.
// ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: GET /api/users â†’ 404, Ð¿Ð¾Ñ‚Ð¾Ð¼Ñƒ Ñ‡Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ð³Ð¾ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð° Ð½ÐµÑ‚.
// Ð’Ð°Ð¶Ð½Ð¾: Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ ÐŸÐžÐ¡Ð›Ð• Ð²ÑÐµÑ… Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
app.use((_req, res) => {
  res.status(404).json({ error: 'Not found' });
});

// ============================================
// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº (Error Handler)
// ============================================

// Express Error Handler â€” Ð¿ÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸.
// Ð¡Ð¸Ð³Ð½Ð°Ñ‚ÑƒÑ€Ð° Ñ 4 Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸ (err, req, res, next) â€” Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°,
// Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð¿Ð¾ Ð½ÐµÐ¹ Express Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ error handler Ð¾Ñ‚ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð³Ð¾ middleware.
//
// Ð¡Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ ÐºÐ¾Ð³Ð´Ð°:
// - Middleware Ð¸Ð»Ð¸ route Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ next(error)
// - Ð’ async route Ð²Ð¾Ð·Ð½Ð¸ÐºÐ°ÐµÑ‚ Ð½ÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð¾Ðµ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ (Express 5+)
// - JSON body Ð½ÐµÐ²Ð°Ð»Ð¸Ð´ÐµÐ½ (SyntaxError Ð¾Ñ‚ express.json())
app.use((err: Error, _req: express.Request, res: express.Response, _next: express.NextFunction) => {
  console.error('Unhandled error:', err);
  res.status(500).json({ error: 'Internal server error' });
});

// ============================================
// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
// ============================================

// app.listen() ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ HTTP-ÑÐµÑ€Ð²ÐµÑ€ Ð¸ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ ÑÐ»ÑƒÑˆÐ°Ñ‚ÑŒ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ€Ñ‚.
// Callback Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ ÐºÐ¾Ð³Ð´Ð° ÑÐµÑ€Ð²ÐµÑ€ Ð³Ð¾Ñ‚Ð¾Ð² Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
app.listen(config.port, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   AI Consultant API Server                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘   Port: ${config.port.toString().padEnd(37)}â•‘
â•‘   Environment: ${config.nodeEnv.padEnd(30)}â•‘
â•‘   Allowed origins: ${config.allowedOrigins.length.toString().padEnd(25)}â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
  console.log('ðŸ“‹ Configured allowed origins:');
  config.allowedOrigins.forEach((origin, index) => {
    console.log(`   ${index + 1}. ${origin}`);
  });
  console.log('');
});
