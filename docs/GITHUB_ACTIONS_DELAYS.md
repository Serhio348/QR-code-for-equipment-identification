# Задержки запуска GitHub Actions

## Проблема

GitHub Actions может запускаться с задержкой относительно запланированного времени. Например:
- Запланировано: 15:50
- Фактический запуск: 16:21 (задержка 31 минута)

Это **нормальное поведение** GitHub Actions и не является ошибкой.

## Причины задержек

1. **Нагрузка на серверы GitHub** - в пиковые часы может быть очередь
2. **Ограничения бесплатного плана** - бесплатные аккаунты имеют более низкий приоритет
3. **Очередь выполнения** - если много workflow запускаются одновременно
4. **Технические задержки** - GitHub не гарантирует точное время выполнения

## Почему это не критично

### 1. Защита от дублирования

База данных использует `ON CONFLICT DO UPDATE`, что означает:
- Если запись с таким же `device_id`, `reading_date` и `reading_type` уже существует
- Она будет обновлена, а не создана дубликат
- Это защищает от проблем, даже если скрипт запустится дважды

### 2. Умная логика определения времени

Скрипт использует приоритетную логику для определения часа записи:

1. **Приоритет 1:** Время из API (если валидно и свежее)
   - Это наиболее точный способ
   - Используется время самого показания из Beliot API

2. **Приоритет 2:** Текущий час (если опрос в 45-59 минут)
   - Нормальный случай, когда скрипт запускается вовремя

3. **Приоритет 3:** Предыдущий час (если опрос в 0-44 минуты)
   - Учитывает задержки GitHub Actions
   - Если скрипт запустился в 16:21, записывает за 15:00

### 3. Регулярность записи

- Данные записываются каждый час
- Задержка в 30 минут не влияет на регулярность
- Важно, что данные записываются, а не точное время запуска

## Пример работы

**Сценарий 1: Запуск вовремя**
- Запланировано: 15:50
- Фактический запуск: 15:50
- Результат: Запись за 15:00 (текущий час, так как minute >= 45)

**Сценарий 2: Задержка**
- Запланировано: 15:50
- Фактический запуск: 16:21
- Результат: Запись за 15:00 (предыдущий час, так как minute < 45)
- Это правильно, так как данные относятся к часу 15:00

**Сценарий 3: Использование времени из API**
- Запланировано: 15:50
- Фактический запуск: 16:21
- Время из API: 15:23:50
- Результат: Запись за 15:00 (время из API, округлено до начала часа)
- Это наиболее точный вариант

## Рекомендации

1. **Не беспокойтесь о задержках** - они не влияют на корректность данных
2. **Проверяйте данные в Supabase** - убедитесь, что записи создаются регулярно
3. **Используйте SQL запросы** для проверки полноты данных (см. `docs/queries/`)
4. **Мониторьте логи** - если задержки превышают 1 час, проверьте статус GitHub Actions

## Альтернативные решения

Если задержки критичны, можно рассмотреть:

1. **Railway Cron Jobs** - более точное расписание (но ранее были проблемы с настройкой)
2. **Внешний сервис cron** - например, cron-job.org
3. **Увеличение частоты опроса** - например, каждые 30 минут (но это увеличит нагрузку)

## Проверка работы

Для проверки, что скрипт работает правильно:

```sql
-- Проверка последних записей
SELECT 
  device_id,
  reading_date,
  reading_value,
  created_at,
  updated_at
FROM beliot_device_readings
WHERE reading_date >= NOW() - INTERVAL '24 hours'
ORDER BY reading_date DESC, device_id
LIMIT 100;
```

## Заключение

Задержки GitHub Actions - это нормально и не влияют на работу системы. Скрипт корректно обрабатывает задержки и записывает данные за правильный час.

