# План разработки мобильного приложения

## Обзор

План по адаптации веб-приложения для мобильных устройств с упрощенным интерфейсом для обычных пользователей, включая главное меню и сканер QR-кодов для доступа к журналу обслуживания оборудования.

---

## Цель

Создать мобильное приложение, где:
- **Обычные пользователи** видят главное меню с опцией "Оборудование"
- При нажатии на "Оборудование" открывается сканер QR-кода
- После сканирования QR-кода пользователь попадает на страницу журнала обслуживания оборудования
- **Администраторы** видят полный функционал (как в веб-версии)

---

## Этап 1: Определение мобильного устройства и адаптация интерфейса

### 1.1. Определение типа устройства

**Файлы для модификации:**
- `src/utils/deviceDetection.ts` (новый файл)
- `src/hooks/useDeviceDetection.ts` (новый файл)

**Логика:**
1. Определение мобильного устройства через `user-agent` или размер экрана
2. Определение типа приложения (PWA, веб-браузер, нативное приложение)
3. Сохранение информации о типе устройства в контексте

**Реализация:**
```typescript
// src/utils/deviceDetection.ts
export function isMobileDevice(): boolean {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
    navigator.userAgent
  ) || window.innerWidth < 768;
}

export function isPWA(): boolean {
  return window.matchMedia('(display-mode: standalone)').matches ||
         (window.navigator as any).standalone === true;
}
```

---

## Этап 2: Создание главного меню для обычных пользователей

### 2.1. Компонент главного меню

**Файлы для создания:**
- `src/components/MobileMenu/MobileMenu.tsx` (новый файл)
- `src/components/MobileMenu/MobileMenu.css` (новый файл)

**Структура меню:**
- Заголовок с информацией о пользователе
- Кнопка "Оборудование" (открывает сканер QR-кода)
- Кнопка "Документация" (опционально, для просмотра документации)
- Кнопка "Выйти"

**Логика:**
- Показывается только для обычных пользователей (не администраторов)
- Для администраторов показывается стандартный интерфейс

### 2.2. Обновление HomePage

**Файлы для модификации:**
- `src/pages/HomePage.tsx`

**Логика:**
- Если пользователь не администратор И мобильное устройство → показать `MobileMenu`
- Если администратор → показать стандартный список оборудования
- Если администратор на мобильном → показать список оборудования с адаптивным дизайном

---

## Этап 3: Интеграция сканера QR-кодов

### 3.1. Выбор библиотеки для сканирования QR-кодов

**Варианты:**
1. **html5-qrcode** (рекомендуется)
   - Легковесная библиотека
   - Поддержка камеры и загрузки изображений
   - Хорошая документация
   - Работает в браузере и PWA

2. **react-qr-reader** (альтернатива)
   - React-компонент
   - Простая интеграция
   - Меньше функций

3. **zxing-js** (для продвинутых случаев)
   - Полный контроль над процессом сканирования
   - Больше возможностей настройки

**Рекомендация:** Использовать `html5-qrcode` для максимальной совместимости.

### 3.2. Установка зависимостей

```bash
npm install html5-qrcode
```

### 3.3. Компонент сканера QR-кодов

**Файлы для создания:**
- `src/components/QRScanner/QRScanner.tsx` (новый файл)
- `src/components/QRScanner/QRScanner.css` (новый файл)

**Функциональность:**
- Запуск камеры устройства
- Сканирование QR-кода в реальном времени
- Обработка результата сканирования
- Закрытие сканера
- Обработка ошибок (нет камеры, нет разрешений)

**Логика:**
1. При открытии сканера запрашивать разрешение на использование камеры
2. Отображать видео-поток с камеры
3. Распознавать QR-коды в реальном времени
4. При успешном сканировании:
   - Извлечь URL из QR-кода
   - Извлечь ID оборудования из URL
   - Перенаправить на страницу журнала обслуживания

### 3.4. Извлечение ID оборудования из QR-кода

**Файлы для создания:**
- `src/utils/qrCodeParser.ts` (новый файл)

**Логика:**
- QR-код содержит URL вида: `https://drive.google.com/drive/folders/FOLDER_ID` или `/equipment/EQUIPMENT_ID`
- Извлечь ID оборудования из URL
- Валидировать формат ID

**Реализация:**
```typescript
// src/utils/qrCodeParser.ts
export function extractEquipmentIdFromQR(qrData: string): string | null {
  // Вариант 1: Прямой URL оборудования
  const equipmentMatch = qrData.match(/\/equipment\/([a-zA-Z0-9-]+)/);
  if (equipmentMatch) {
    return equipmentMatch[1];
  }
  
  // Вариант 2: Google Drive URL (нужно найти оборудование по folderId)
  const driveMatch = qrData.match(/\/folders\/([a-zA-Z0-9-_]+)/);
  if (driveMatch) {
    // Вернуть folderId для поиска оборудования
    return driveMatch[1];
  }
  
  return null;
}
```

---

## Этап 4: Навигация к журналу обслуживания

### 4.1. Обновление маршрутизации

**Файлы для модификации:**
- `src/utils/routes.ts`
- `src/App.tsx`

**Новые маршруты:**
- `/mobile` - главное меню для мобильных устройств
- `/scanner` - страница сканера QR-кодов
- `/equipment/:id/maintenance` - журнал обслуживания (для мобильных)

### 4.2. Страница журнала обслуживания для мобильных

**Файлы для создания:**
- `src/pages/MobileMaintenancePage.tsx` (новый файл)
- `src/pages/MobileMaintenancePage.css` (новый файл)

**Функциональность:**
- Отображение информации об оборудовании (название, тип)
- Отображение журнала обслуживания
- Возможность добавления новой записи
- Упрощенный интерфейс для мобильных устройств

**Логика:**
- Использовать существующий компонент `MaintenanceLog`
- Адаптировать стили для мобильных устройств
- Упростить форму добавления записи

---

## Этап 5: Обработка разрешений камеры

### 5.1. Запрос разрешений

**Файлы для создания:**
- `src/utils/cameraPermissions.ts` (новый файл)

**Логика:**
- Проверка доступности API камеры
- Запрос разрешений через `navigator.mediaDevices.getUserMedia()`
- Обработка отказа в разрешениях
- Инструкции для пользователя при отказе

### 5.2. Обработка ошибок

**Сценарии:**
1. Камера недоступна
2. Пользователь отказал в разрешениях
3. Камера занята другим приложением
4. Неподдерживаемый браузер

**Решение:**
- Показывать понятные сообщения об ошибках
- Предлагать альтернативу (ввод ID оборудования вручную)
- Инструкции по предоставлению разрешений

---

## Этап 6: Адаптация для PWA (Progressive Web App)

### 6.1. Манифест приложения

**Файлы для создания/модификации:**
- `public/manifest.json` (обновить)
- `public/icons/` (иконки для разных размеров)

**Требования:**
- Иконки для разных размеров экранов
- Название приложения
- Цвета темы
- Режим отображения (standalone)

### 6.2. Service Worker

**Файлы для создания:**
- `public/sw.js` (новый файл)
- `src/utils/registerServiceWorker.ts` (новый файл)

**Функциональность:**
- Кэширование статических ресурсов
- Офлайн-режим (базовая функциональность)
- Обновление кэша при обновлении приложения

### 6.3. Установка PWA

**Логика:**
- Показывать баннер "Установить приложение" для мобильных устройств
- Сохранить состояние установки
- После установки открывать в standalone режиме

---

## Этап 7: Оптимизация для мобильных устройств

### 7.1. Адаптивные стили

**Файлы для модификации:**
- Все CSS файлы компонентов
- `src/App.css`

**Требования:**
- Увеличенные области нажатия (минимум 44x44px)
- Упрощенная навигация
- Оптимизация для вертикальной ориентации
- Поддержка жестов (swipe, pull-to-refresh)

### 7.2. Производительность

**Оптимизации:**
- Ленивая загрузка компонентов (React.lazy)
- Оптимизация изображений
- Минимизация запросов к API
- Кэширование данных

---

## Этап 8: Альтернатива сканированию (ввод вручную)

### 8.1. Компонент ввода ID оборудования

**Файлы для создания:**
- `src/components/ManualEquipmentInput.tsx` (новый файл)

**Функциональность:**
- Поле ввода ID оборудования
- Кнопка "Открыть журнал"
- Валидация формата ID
- Поиск оборудования по ID

**Логика:**
- Если сканирование недоступно или не работает → показать форму ввода
- Валидация ID перед переходом
- Обработка ошибок (оборудование не найдено)

---

## Этап 9: Тестирование

### 9.1. Тестирование на устройствах

**Платформы:**
- iOS (Safari, Chrome)
- Android (Chrome, Firefox, Samsung Internet)
- PWA режим

### 9.2. Тестирование функциональности

**Сценарии:**
1. Регистрация нового пользователя на мобильном
2. Вход в систему
3. Открытие главного меню
4. Сканирование QR-кода
5. Просмотр журнала обслуживания
6. Добавление записи в журнал
7. Выход из системы

### 9.3. Тестирование разрешений

**Сценарии:**
1. Предоставление разрешений на камеру
2. Отказ в разрешениях
3. Повторный запрос разрешений
4. Работа без разрешений (ввод вручную)

---

## Этап 10: Документация и инструкции

### 10.1. Инструкции для пользователей

**Создать:**
- `docs/MOBILE_USER_GUIDE.md` - руководство пользователя
- Скриншоты основных экранов
- Видео-инструкция (опционально)

### 10.2. Инструкции для разработчиков

**Обновить:**
- `README.md` - добавить раздел о мобильной версии
- `docs/ARCHITECTURE.md` - описать архитектуру мобильного приложения

---

## Порядок реализации

### Фаза 1: Базовая функциональность (Этапы 1-4)
1. Определение мобильного устройства
2. Создание главного меню
3. Интеграция сканера QR-кодов
4. Навигация к журналу обслуживания

### Фаза 2: Оптимизация (Этапы 5-7)
5. Обработка разрешений камеры
6. Адаптация для PWA
7. Оптимизация для мобильных устройств

### Фаза 3: Дополнительные функции (Этапы 8-10)
8. Альтернатива сканированию
9. Тестирование
10. Документация

---

## Технические детали

### Зависимости для установки

```bash
# Сканер QR-кодов
npm install html5-qrcode

# Типы для TypeScript (если нужно)
npm install --save-dev @types/html5-qrcode
```

### Структура новых файлов

```
src/
├── components/
│   ├── MobileMenu/
│   │   ├── MobileMenu.tsx
│   │   └── MobileMenu.css
│   └── QRScanner/
│       ├── QRScanner.tsx
│       └── QRScanner.css
├── pages/
│   ├── MobileMaintenancePage.tsx
│   └── MobileMaintenancePage.css
├── utils/
│   ├── deviceDetection.ts
│   ├── qrCodeParser.ts
│   └── cameraPermissions.ts
└── hooks/
    └── useDeviceDetection.ts
```

---

## Риски и решения

### Риск 1: Камера недоступна
**Решение:** Предоставить альтернативу ввода ID вручную

### Риск 2: Разрешения отклонены
**Решение:** Показать инструкции и возможность повторного запроса

### Риск 3: Неподдерживаемый браузер
**Решение:** Определить браузер и показать предупреждение или альтернативу

### Риск 4: Производительность на слабых устройствах
**Решение:** Оптимизация кода, ленивая загрузка, кэширование

---

## Метрики успеха

1. ✅ Обычные пользователи видят главное меню вместо "Доступ запрещен"
2. ✅ Сканер QR-кодов работает на основных мобильных платформах
3. ✅ После сканирования пользователь попадает на журнал обслуживания
4. ✅ Приложение работает в PWA режиме
5. ✅ Альтернатива сканированию (ввод вручную) доступна

---

## Следующие шаги

1. **Начать с Этапа 1** - определение мобильного устройства
2. **Создать главное меню** (Этап 2)
3. **Интегрировать сканер QR-кодов** (Этап 3)
4. **Протестировать на реальных устройствах** (Этап 9)

---

## Примечания

- План можно реализовывать поэтапно
- Каждый этап можно тестировать отдельно
- Возможны изменения в плане на основе тестирования
- Приоритет - базовая функциональность (Фаза 1)

