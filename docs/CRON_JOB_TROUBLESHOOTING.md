# Диагностика: Cron Job не работает

## Быстрая проверка:

### 1. Проверьте GitHub Actions

1. Откройте репозиторий на GitHub
2. Перейдите в **Actions**
3. Найдите workflow **"Collect Beliot Readings"**
4. Проверьте последние запуски

**Если workflow не запускается:**
- Проверьте, что файл `.github/workflows/collect-readings.yml` существует
- Проверьте, что он загружен в репозиторий
- Проверьте, что workflow включен

**Если workflow запускается, но падает:**
- Откройте последний запуск
- Проверьте логи на наличие ошибок

### 2. Проверьте секреты в GitHub

1. Откройте репозиторий на GitHub
2. Перейдите в **Settings** → **Secrets and variables** → **Actions**
3. Проверьте, что установлены следующие секреты:

**Обязательные:**
- ✅ `SUPABASE_URL`
- ✅ `SUPABASE_SERVICE_ROLE_KEY`
- ✅ `BELIOT_LOGIN`
- ✅ `BELIOT_PASSWORD`

**Опциональные:**
- `BELIOT_API_BASE_URL` (по умолчанию: `https://beliot.by:4443/api`)

**Если секретов нет:**
- Добавьте их через **New repository secret**
- Убедитесь, что имена совпадают с именами в workflow

### 3. Проверьте расписание

Workflow настроен на запуск каждый час:
```yaml
schedule:
  - cron: '0 * * * *'  # Каждый час в начале часа
```

**Важно:** GitHub Actions может задерживать scheduled workflows до 15 минут.

### 4. Запустите вручную

1. Откройте **Actions** → **Collect Beliot Readings**
2. Нажмите **Run workflow**
3. Выберите ветку (обычно `develop` или `main`)
4. Нажмите **Run workflow**
5. Проверьте логи выполнения

## Типичные проблемы:

### Проблема 1: Workflow не запускается автоматически

**Причина:** GitHub Actions может не запускать scheduled workflows для неактивных репозиториев.

**Решение:**
- Убедитесь, что репозиторий не в режиме "archived"
- Попробуйте запустить вручную хотя бы раз
- Проверьте, что последний коммит был недавно

### Проблема 2: Ошибка "Secret not found"

**Причина:** Секреты не установлены или названы неправильно.

**Решение:**
- Проверьте, что все секреты установлены
- Убедитесь, что имена совпадают с workflow
- Проверьте, что секреты не пустые

### Проблема 3: Ошибка при установке зависимостей

**Причина:** Проблемы с `package.json` или `npm ci`.

**Решение:**
- Проверьте, что `package.json` валиден
- Проверьте, что скрипт `collect-readings` существует
- Проверьте логи установки зависимостей

### Проблема 4: Ошибка при выполнении скрипта

**Причина:** Проблемы с переменными окружения или подключением к API.

**Решение:**
- Проверьте логи выполнения скрипта
- Проверьте, что все переменные окружения установлены
- Проверьте подключение к Supabase и Beliot API

## Проверка логов:

### Что искать в логах:

1. **Успешный запуск:**
   ```
   ✅ Успешно: {count}
   ✅ Сбор показаний завершен
   ```

2. **Ошибки:**
   ```
   ❌ Ошибка получения токена
   ❌ Ошибка получения устройств
   ❌ Ошибка RPC для устройства
   ```

3. **Пропущенные устройства:**
   ```
   ⚠️ Пропущено: {count}
   ⚠️ Текущее показание не найдено
   ```

## Альтернатива: Railway Cron

Если GitHub Actions не работает, можно использовать Railway:

1. Создайте отдельный сервис в Railway
2. Установите переменные окружения
3. Установите Cron Schedule: `0 * * * *`
4. Установите Start Command: `cd /app && npm run collect-readings`

## Проверка работы:

### После настройки:

1. **Подождите час** (или запустите вручную)
2. **Проверьте логи** в GitHub Actions или Railway
3. **Проверьте данные в Supabase:**
   ```sql
   SELECT 
     device_id,
     reading_date,
     reading_value,
     created_at
   FROM beliot_device_readings
   WHERE reading_date >= CURRENT_DATE
   ORDER BY reading_date DESC
   LIMIT 10;
   ```

## Быстрый тест:

Запустите скрипт локально для проверки:

```bash
# Установите переменные окружения
export SUPABASE_URL="your_url"
export SUPABASE_SERVICE_ROLE_KEY="your_key"
export BELIOT_LOGIN="your_login"
export BELIOT_PASSWORD="your_password"

# Запустите скрипт
npm run collect-readings
```

Если скрипт работает локально, но не работает в GitHub Actions, проблема в настройке секретов или workflow.

## Итоговый чеклист:

- [ ] Файл `.github/workflows/collect-readings.yml` существует
- [ ] Workflow включен в GitHub Actions
- [ ] Все секреты установлены в GitHub
- [ ] Имена секретов совпадают с workflow
- [ ] Workflow запускается (проверьте в Actions)
- [ ] Логи не показывают ошибок
- [ ] Данные появляются в Supabase

## Если ничего не помогает:

1. Проверьте, что скрипт работает локально
2. Проверьте логи GitHub Actions на наличие ошибок
3. Попробуйте запустить workflow вручную
4. Проверьте, что все зависимости установлены
5. Проверьте подключение к Supabase и Beliot API

