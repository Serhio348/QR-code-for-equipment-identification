# Система управления доступом к приложениям

## Обзор

Система управления доступом позволяет администраторам контролировать, какие пользователи имеют доступ к различным приложениям/вкладкам системы.

## Доступные приложения

- **Оборудование** (`equipment`) - Управление оборудованием по QR-кодам
- **Вода** (`water`) - Счётчики воды

## Функциональность

### Для администраторов

1. **Страница настроек доступа** (`/admin/access-settings`)
   - Просмотр всех пользователей и их настроек доступа
   - Включение/отключение доступа к приложениям для каждого пользователя
   - Поиск пользователей по email или ID
   - Просмотр истории обновлений (кто и когда обновил настройки)

2. **Автоматический доступ**
   - Администраторы имеют доступ ко всем приложениям автоматически
   - Не требуют настройки доступа

### Для обычных пользователей

1. **Главное меню**
   - Показываются только те приложения, к которым у пользователя есть доступ
   - Если доступа нет, приложение не отображается в меню

2. **Защита маршрутов**
   - При попытке прямого доступа к приложению без прав, пользователь перенаправляется на главное меню
   - Проверка доступа выполняется автоматически при переходе на страницу

## Установка и настройка

### Backend (Google Apps Script)

1. Добавьте файл `AccessManagement.gs` в ваш проект Google Apps Script
2. Обновите файл `Code.gs`, добавив обработчики для действий:
   - `getAllUserAccess` - получение всех настроек доступа
   - `getUserAccess` - получение настроек доступа пользователя
   - `updateUserAccess` - обновление настроек доступа

3. Лист "Доступ к приложениям" будет создан автоматически при первом обращении

### Frontend

Все необходимые компоненты уже включены в проект:
- `src/types/access.ts` - типы данных
- `src/services/api/accessApi.ts` - API клиент
- `src/pages/AccessSettingsPage.tsx` - страница настроек
- `src/components/AppAccessGuard.tsx` - компонент проверки доступа

## Использование

### Настройка доступа для пользователя

1. Войдите в систему как администратор
2. Перейдите в главное меню
3. Нажмите кнопку "Настройки доступа" (⚙️)
4. Найдите пользователя в таблице (можно использовать поиск)
5. Включите/отключите доступ к нужным приложениям с помощью переключателей
6. Изменения сохраняются автоматически

### Проверка доступа

Доступ проверяется автоматически:
- При загрузке главного меню (показываются только доступные приложения)
- При переходе на страницу приложения (если доступа нет, происходит редирект)

## Структура данных

### Лист "Доступ к приложениям" в Google Sheets

| Колонка | Название | Описание |
|---------|----------|----------|
| A | Email | Email пользователя |
| B | ID пользователя | Уникальный ID пользователя |
| C | Оборудование | Доступ к приложению "Оборудование" (true/false) |
| D | Вода | Доступ к приложению "Вода" (true/false) |
| E | Дата обновления | Дата и время последнего обновления |
| F | Обновлено пользователем | Email администратора, который обновил настройки |

## API Endpoints

### Получить все настройки доступа

```
POST /exec
action=getAllUserAccess
```

**Ответ:**
```json
{
  "success": true,
  "data": [
    {
      "email": "user@example.com",
      "userId": "12345",
      "equipment": true,
      "water": false,
      "updatedAt": "2024-01-01T12:00:00.000Z",
      "updatedBy": "admin@example.com"
    }
  ]
}
```

### Получить настройки доступа пользователя

```
POST /exec
action=getUserAccess
email=user@example.com
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "email": "user@example.com",
    "userId": "12345",
    "equipment": true,
    "water": false,
    "updatedAt": "2024-01-01T12:00:00.000Z",
    "updatedBy": "admin@example.com"
  }
}
```

### Обновить настройки доступа

```
POST /exec
action=updateUserAccess
email=user@example.com
equipment=true
water=false
adminEmail=admin@example.com
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "email": "user@example.com",
    "userId": "12345",
    "equipment": true,
    "water": false,
    "updatedAt": "2024-01-01T12:00:00.000Z",
    "updatedBy": "admin@example.com"
  }
}
```

## Примечания

- По умолчанию новые пользователи не имеют доступа ни к одному приложению
- Администраторы имеют доступ ко всем приложениям автоматически
- Настройки доступа хранятся в Google Sheets и синхронизируются в реальном времени
- При отсутствии настроек доступа для пользователя, доступ считается запрещенным

