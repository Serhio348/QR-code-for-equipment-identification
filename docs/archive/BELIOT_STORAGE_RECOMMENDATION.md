# Рекомендация по хранению данных счетчиков Beliot

## Ваш вопрос

> Разрабатываю систему клиента, который по API снимает данные со счетчиков, обрабатывает их. 
> Что правильнее: создать отдельную базу данных или использовать существующую?

---

## Анализ текущей архитектуры

### Что у вас уже есть:

1. **Google Sheets + Google Apps Script API** 
   - ✅ Уже работает для оборудования
   - ✅ Есть инфраструктура (backend/equipment-db/)
   - ✅ Есть API endpoints
   - ✅ Есть опыт работы с этой системой

2. **Beliot API** 
   - ✅ Источник данных счетчиков
   - ✅ Данные обновляются в реальном времени
   - ✅ Полная информация об устройствах

3. **Пользовательские изменения**
   - Имя (`name`)
   - Место расположения (`address`)
   - Серийный номер (`serialNumber`)

---

## Рекомендация: **Гибридный подход** ⭐⭐⭐

### Стратегия: Расширить существующую БД + Кэширование

```
┌─────────────────────────────────────────────────────────┐
│              Beliot API (Источник данных)               │
│         Получение актуальных данных счетчиков           │
└────────────────────┬──────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│         Слой обработки и кэширования                     │
│                                                          │
│  1. Получение данных из Beliot API                      │
│  2. Обработка данных (извлечение серийных номеров и т.д.)│
│  3. Применение пользовательских изменений               │
│  4. Кэширование в localStorage (быстрый доступ)        │
└────────────────────┬──────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│      Google Sheets (Расширенная таблица)                 │
│                                                          │
│  Таблица "Счетчики Beliot"                              │
│  - deviceId (ID из Beliot API)                          │
│  - name (пользовательское имя)                          │
│  - address (пользовательский адрес)                     │
│  - serialNumber (серийный номер)                        │
│  - lastSync (дата последней синхронизации)             │
│  - lastModified (дата изменения)                        │
│  - modifiedBy (кто изменил)                             │
└─────────────────────────────────────────────────────────┘
```

---

## Почему НЕ создавать отдельную БД?

### ❌ Проблемы отдельной БД:

1. **Дублирование инфраструктуры**
   - Нужно создавать новую таблицу/БД
   - Нужно создавать новый API
   - Нужно поддерживать два места хранения

2. **Сложность синхронизации**
   - Две БД = два источника правды
   - Сложнее поддерживать консистентность
   - Больше точек отказа

3. **Избыточность**
   - У вас уже есть рабочая система Google Sheets
   - Зачем создавать новую, если можно расширить существующую?

---

## Почему расширить существующую БД?

### ✅ Преимущества:

1. **Единая инфраструктура**
   - Один Google Apps Script проект
   - Одна система авторизации
   - Один API endpoint
   - Проще поддерживать

2. **Переиспользование кода**
   - Можно использовать существующие утилиты
   - Можно использовать существующие паттерны
   - Меньше кода для написания

3. **Единая точка доступа**
   - Все данные в одном месте
   - Проще делать отчеты
   - Проще анализировать данные

4. **Уже работает**
   - Инфраструктура проверена
   - Есть опыт работы
   - Меньше рисков

---

## Предлагаемая архитектура

### Вариант 1: Расширить существующую таблицу "Оборудование" ⭐⭐

**Структура:**

| ID | Название | Тип | ... | BeliotDeviceId | BeliotName | BeliotAddress | BeliotSerialNumber | LastSync |
|----|----------|-----|-----|----------------|------------|---------------|-------------------|----------|
| uuid | Фильтр №1 | filter | ... | 10596 | MTK-40N | ул. Мицкевича | 13001660 | 2024-01-15 |

**Преимущества:**
- ✅ Связь между оборудованием и счетчиками
- ✅ Единая таблица для всего
- ✅ Проще делать отчеты

**Недостатки:**
- ❌ Смешивание разных сущностей
- ❌ Может быть избыточно, если не все оборудование связано со счетчиками

---

### Вариант 2: Отдельный лист "Счетчики Beliot" ⭐⭐⭐ **РЕКОМЕНДУЕТСЯ**

**Структура:**

Новый лист в той же Google Sheets таблице:

| deviceId | name | address | serialNumber | lastSync | lastModified | modifiedBy | group |
|----------|------|---------|--------------|----------|--------------|------------|-------|
| 10596 | MTK-40N | ул. Мицкевича | 13001660 | 2024-01-15 | 2024-01-15 | user@example.com | ХВО |
| 10597 | ... | ... | ... | ... | ... | ... | ХВО |

**Преимущества:**
- ✅ Отдельная сущность (счетчики ≠ оборудование)
- ✅ Чистая структура данных
- ✅ Легко расширять
- ✅ Можно связать с оборудованием через deviceId (если нужно)

**Недостатки:**
- ⚠️ Нужно создать новый лист (но это просто)

---

## Рекомендуемая реализация

### Этап 1: localStorage (Уже реализовано) ✅

**Цель:** Быстрый доступ, работа офлайн

**Что делает:**
- Хранит пользовательские изменения локально
- Работает без интернета
- Быстрый доступ

**Файлы:**
- ✅ `src/utils/beliotStorage.ts` - уже создан
- ✅ `src/hooks/useBeliotDevicesStorage.ts` - уже создан

---

### Этап 2: Google Sheets синхронизация ⭐ **РЕКОМЕНДУЕТСЯ СЛЕДУЮЩИМ**

**Цель:** Синхронизация между устройствами, резервное копирование

**Что нужно сделать:**

1. **Создать новый лист в Google Sheets:**
   - Название: "Счетчики Beliot"
   - Колонки: deviceId, name, address, serialNumber, lastSync, lastModified, modifiedBy, group

2. **Расширить Google Apps Script:**
   - Добавить модуль `BeliotDevicesOverrides.gs`
   - Endpoints:
     - `GET /beliot-devices-overrides` - получить все изменения
     - `POST /beliot-devices-overrides` - сохранить изменения
     - `PUT /beliot-devices-overrides/:deviceId` - обновить изменения для устройства
     - `DELETE /beliot-devices-overrides/:deviceId` - удалить изменения

3. **Создать API клиент:**
   - `src/services/api/beliotDevicesStorageApi.ts`
   - Функции для синхронизации с Google Sheets

4. **Интегрировать в компонент:**
   - Автоматическая синхронизация при сохранении
   - Периодическая синхронизация (каждые 5-10 минут)
   - Загрузка изменений при старте приложения

**Время реализации:** 4-6 часов

---

## Поток данных (Рекомендуемый)

```
┌─────────────────────────────────────────────────────────┐
│                    Приложение запускается                │
└────────────────────┬──────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│localStorage │ │Google Sheets│ │ Beliot API  │
│  (Быстро)   │ │(Синхронизация)│ │(Актуальные) │
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │                │                │
       └────────────────┼────────────────┘
                         │
                         ▼
              ┌──────────────────────┐
              │   Слой слияния данных │
              │   (Merge Strategy)    │
              └──────────┬─────────────┘
                         │
                         ▼
              ┌──────────────────────┐
              │   Отображение в UI    │
              └──────────────────────┘
```

### Алгоритм слияния:

1. **Загрузить данные из Beliot API** (актуальные данные счетчиков)
2. **Загрузить изменения из localStorage** (быстро, локально)
3. **Загрузить изменения из Google Sheets** (синхронизация)
4. **Применить изменения:**
   - Приоритет 1: localStorage (самые свежие локальные изменения)
   - Приоритет 2: Google Sheets (синхронизированные изменения)
   - Приоритет 3: Beliot API (исходные данные)

---

## Итоговая рекомендация

### ✅ **Использовать существующую Google Sheets БД**

**Почему:**
1. У вас уже есть рабочая инфраструктура
2. Не нужно создавать новую БД
3. Проще поддерживать
4. Единая точка доступа
5. Можно связать с оборудованием (если нужно)

**Как:**
1. ✅ **Этап 1 (localStorage)** - уже реализовано
2. ⭐ **Этап 2 (Google Sheets)** - создать новый лист "Счетчики Beliot"
3. 🔮 **Этап 3 (IndexedDB)** - только если нужна история изменений

---

## Что НЕ делать

### ❌ Не создавать отдельную БД (Firebase, Supabase, PostgreSQL)

**Почему:**
- Избыточно для вашей задачи
- Дублирование инфраструктуры
- Сложнее поддерживать
- Дополнительные расходы (если платные)

### ❌ Не хранить полные данные счетчиков в Google Sheets

**Почему:**
- Beliot API - источник правды для данных счетчиков
- Google Sheets - только для пользовательских изменений
- Избегаем дублирования данных
- Меньше синхронизации

---

## Структура данных в Google Sheets

### Лист "Счетчики Beliot"

| Колонка | Название | Тип | Описание |
|---------|----------|-----|----------|
| A | deviceId | string | ID устройства из Beliot API (уникальный ключ) |
| B | name | string | Пользовательское имя (если изменено) |
| C | address | string | Пользовательский адрес (если изменен) |
| D | serialNumber | string | Серийный номер (если введен вручную) |
| E | group | string | Группа устройства (ХВО, АБК и т.д.) |
| F | lastSync | datetime | Дата последней синхронизации с Beliot API |
| G | lastModified | datetime | Дата последнего изменения пользователем |
| H | modifiedBy | string | Email пользователя, который изменил |

**Примечание:** 
- Если поле пустое - используется значение из Beliot API
- Если поле заполнено - используется пользовательское значение

---

## Пример кода (Google Apps Script)

```javascript
// backend/equipment-db/BeliotDevicesOverrides.gs

/**
 * Получить все пользовательские изменения счетчиков
 */
function getBeliotDevicesOverrides() {
  const sheet = getBeliotDevicesSheet();
  const data = sheet.getDataRange().getValues();
  
  if (data.length <= 1) {
    return {};
  }
  
  const headers = data[0];
  const overrides = {};
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const deviceId = String(row[0]); // Колонка A
    
    if (deviceId) {
      overrides[deviceId] = {
        name: row[1] || undefined,        // Колонка B
        address: row[2] || undefined,     // Колонка C
        serialNumber: row[3] || undefined, // Колонка D
        group: row[4] || undefined,        // Колонка E
        lastModified: row[6] ? new Date(row[6]).getTime() : undefined,
        modifiedBy: row[7] || undefined,
      };
    }
  }
  
  return overrides;
}

/**
 * Сохранить изменения для устройства
 */
function saveBeliotDeviceOverride(deviceId, data) {
  const sheet = getBeliotDevicesSheet();
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  
  // Ищем существующую строку
  let rowIndex = -1;
  for (let i = 1; i < values.length; i++) {
    if (String(values[i][0]) === String(deviceId)) {
      rowIndex = i + 1;
      break;
    }
  }
  
  const now = new Date();
  
  if (rowIndex > 0) {
    // Обновляем существующую строку
    if (data.name !== undefined) {
      sheet.getRange(rowIndex, 2).setValue(data.name);
    }
    if (data.address !== undefined) {
      sheet.getRange(rowIndex, 3).setValue(data.address);
    }
    if (data.serialNumber !== undefined) {
      sheet.getRange(rowIndex, 4).setValue(data.serialNumber);
    }
    sheet.getRange(rowIndex, 6).setValue(now); // lastSync
    sheet.getRange(rowIndex, 7).setValue(now); // lastModified
    sheet.getRange(rowIndex, 8).setValue(data.modifiedBy || '');
  } else {
    // Создаем новую строку
    sheet.appendRow([
      deviceId,                    // A: deviceId
      data.name || '',             // B: name
      data.address || '',          // C: address
      data.serialNumber || '',     // D: serialNumber
      data.group || '',            // E: group
      now,                         // F: lastSync
      now,                         // G: lastModified
      data.modifiedBy || '',       // H: modifiedBy
    ]);
  }
}

/**
 * Получить или создать лист "Счетчики Beliot"
 */
function getBeliotDevicesSheet() {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = spreadsheet.getSheetByName('Счетчики Beliot');
  
  if (!sheet) {
    sheet = spreadsheet.insertSheet('Счетчики Beliot');
    
    // Заголовки
    sheet.getRange(1, 1, 1, 8).setValues([[
      'deviceId',
      'name',
      'address',
      'serialNumber',
      'group',
      'lastSync',
      'lastModified',
      'modifiedBy'
    ]]);
    
    // Форматирование заголовков
    const headerRange = sheet.getRange(1, 1, 1, 8);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('#ffffff');
  }
  
  return sheet;
}
```

---

## Вывод

### ✅ **Рекомендация: Расширить существующую Google Sheets БД**

**Что делать:**
1. ✅ Использовать localStorage для быстрого доступа (уже реализовано)
2. ⭐ Создать новый лист "Счетчики Beliot" в существующей Google Sheets
3. ⭐ Расширить Google Apps Script для работы с этим листом
4. ⭐ Реализовать синхронизацию между localStorage и Google Sheets

**Что НЕ делать:**
- ❌ Создавать отдельную БД
- ❌ Дублировать инфраструктуру
- ❌ Хранить полные данные счетчиков (только пользовательские изменения)

**Результат:**
- ✅ Единая инфраструктура
- ✅ Синхронизация между устройствами
- ✅ Резервное копирование
- ✅ Простота поддержки

