-- ============================================================================
-- Миграция: Создание таблицы workshops (участки)
-- ============================================================================
-- 
-- Таблица для хранения участков предприятия
-- Заменяет Google Sheets таблицу "Участки"
--
-- ВАЖНО: Порядок выполнения имеет значение!
-- 1. Удаление существующих объектов (политики, триггеры)
-- 2. Создание таблицы и индексов
-- 3. Создание RLS политик
-- 4. Создание триггеров
--
-- Скрипт полностью идемпотентен: можно выполнять многократно без ошибок
-- ============================================================================

-- ============================================================================
-- ТАБЛИЦА: workshops
-- Участки предприятия
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.workshops (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Индексы
DROP INDEX IF EXISTS idx_workshops_name;
CREATE INDEX idx_workshops_name ON public.workshops(name);

-- ============================================================================
-- ОЧИСТКА: Удаление существующих объектов (после создания таблицы)
-- ============================================================================

-- Удаляем существующие политики
DROP POLICY IF EXISTS "Authenticated users can view workshops" ON public.workshops;
DROP POLICY IF EXISTS "Only admins can modify workshops" ON public.workshops;

-- Удаляем существующие триггеры
DROP TRIGGER IF EXISTS update_workshops_updated_at ON public.workshops;

-- ============================================================================
-- RLS ПОЛИТИКИ (Row Level Security)
-- ============================================================================

-- Включаем RLS на таблице
ALTER TABLE public.workshops ENABLE ROW LEVEL SECURITY;

-- Все авторизованные пользователи могут просматривать участки
CREATE POLICY "Authenticated users can view workshops"
  ON public.workshops FOR SELECT
  USING (auth.role() = 'authenticated');

-- Только администраторы могут изменять участки
CREATE POLICY "Only admins can modify workshops"
  ON public.workshops FOR ALL
  USING (public.is_admin())
  WITH CHECK (public.is_admin());

-- ============================================================================
-- ТРИГГЕРЫ
-- ============================================================================

-- Триггер для автоматического обновления updated_at
CREATE TRIGGER update_workshops_updated_at
  BEFORE UPDATE ON public.workshops
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

-- ============================================================================
-- КОММЕНТАРИИ
-- ============================================================================

COMMENT ON TABLE public.workshops IS 'Участки предприятия. Используется для фильтрации и группировки оборудования.';
COMMENT ON COLUMN public.workshops.name IS 'Название участка (уникальное)';
COMMENT ON COLUMN public.workshops.description IS 'Описание участка (опционально)';

-- ============================================================================
-- НАЧАЛЬНЫЕ ДАННЫЕ
-- ============================================================================
-- 
-- Добавляем начальные данные об участках предприятия
-- ON CONFLICT предотвращает дубликаты при повторном выполнении миграции

INSERT INTO public.workshops (name, description) VALUES
  ('Водочный участок', ''),
  ('Водочный участок экспортное отделение', ''),
  ('Посудо-тарный участок', ''),
  ('Ликерный участок', ''),
  ('Ликерный участок напорное отделение', ''),
  ('Бар', ''),
  ('АБК по ул.Советская, 1', ''),
  ('АБК по ул.Советская, 2/1', ''),
  ('Отпускной участок', ''),
  ('Спиртоприёмный участок', ''),
  ('Хранилище(музей)', ''),
  ('Хранилище', '')
ON CONFLICT (name) DO NOTHING;
