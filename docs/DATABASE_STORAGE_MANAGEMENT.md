# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –î–ª—è —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã —Å 20 —Å—á–µ—Ç—á–∏–∫–∞–º–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞. 
> –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≥–æ–¥ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ~28.6 –ú–ë, –∑–∞ 10 –ª–µ—Ç ~286 –ú–ë.
> –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –ø–ª–∞–Ω—ã –¥–ª—è –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –µ–∂–µ—á–∞—Å–Ω–æ–º —Å–±–æ—Ä–µ –ø–æ–∫–∞–∑–∞–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ `beliot_device_readings` –±—É–¥–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞—Å—Ç–∏. –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –≤ Supabase.

## –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏

### –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

- **–¢–∞–±–ª–∏—Ü–∞**: `beliot_device_readings`
- **–ß–∞—Å—Ç–æ—Ç–∞ —Å–±–æ—Ä–∞**: –ö–∞–∂–¥—ã–π —á–∞—Å (GitHub Actions cron: `50 * * * *`)
- **–ü–µ—Ä–∏–æ–¥ —Å–±–æ—Ä–∞**: –ü–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
- **–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö**: –ü–æ—á–∞—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è (`reading_type = 'hourly'`)
- **–†–∞–∑–º–µ—Ä –∑–∞–ø–∏—Å–∏**: ~100-150 –±–∞–π—Ç (UUID, device_id, reading_date, reading_value, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)

### –†–∞—Å—á–µ—Ç —Ä–æ—Å—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

**–î–ª—è 20 —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—Ç–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞):**
- 20 —É—Å—Ç—Ä–æ–π—Å—Ç–≤ √ó 24 –ø–æ–∫–∞–∑–∞–Ω–∏—è/–¥–µ–Ω—å √ó 365 –¥–Ω–µ–π = **175,200 –∑–∞–ø–∏—Å–µ–π/–≥–æ–¥**
- 175,200 √ó 115 –±–∞–π—Ç = **~19.2 –ú–ë/–≥–æ–¥** (–¥–∞–Ω–Ω—ã–µ)
- –° —É—á–µ—Ç–æ–º –∏–Ω–¥–µ–∫—Å–æ–≤: **~28.6 –ú–ë/–≥–æ–¥**
- –ó–∞ 5 –ª–µ—Ç: **~143 –ú–ë** (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏)
- –ó–∞ 10 –ª–µ—Ç: **~286 –ú–ë** (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏)

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è 10 —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
- 10 —É—Å—Ç—Ä–æ–π—Å—Ç–≤ √ó 24 –ø–æ–∫–∞–∑–∞–Ω–∏—è/–¥–µ–Ω—å √ó 30 –¥–Ω–µ–π = **7,200 –∑–∞–ø–∏—Å–µ–π/–º–µ—Å—è—Ü**
- 7,200 √ó 115 –±–∞–π—Ç = **~0.83 –ú–ë/–º–µ—Å—è—Ü**
- –ó–∞ –≥–æ–¥: **~14.3 –ú–ë** (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏)

**–î–ª—è 100 —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
- 100 —É—Å—Ç—Ä–æ–π—Å—Ç–≤ √ó 24 –ø–æ–∫–∞–∑–∞–Ω–∏—è/–¥–µ–Ω—å √ó 30 –¥–Ω–µ–π = **72,000 –∑–∞–ø–∏—Å–µ–π/–º–µ—Å—è—Ü**
- 72,000 √ó 115 –±–∞–π—Ç = **~8.3 –ú–ë/–º–µ—Å—è—Ü**
- –ó–∞ –≥–æ–¥: **~143 –ú–ë** (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏)

**–î–ª—è 1000 —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
- –ó–∞ –≥–æ–¥: **~1.43 –ì–ë** (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏)

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è 20 —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–º. –≤ `STORAGE_CALCULATION_20_DEVICES.md`

## –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–µ—à–µ–Ω–∏—è

### 1. –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è**: –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å—Ç–∞—Ä—à–µ N –º–µ—Å—è—Ü–µ–≤) –ø–µ—Ä–µ–º–µ—â–∞—é—Ç—Å—è –≤ –∞—Ä—Ö–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ —É–¥–∞–ª—è—é—Ç—Å—è.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
- –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
- –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

### 2. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è**: –°—Ç–∞—Ä—ã–µ –ø–æ—á–∞—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –≤ –¥–Ω–µ–≤–Ω—ã–µ/–º–µ—Å—è—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º –≤–∏–¥–µ
- –£–º–µ–Ω—å—à–∞–µ—Ç –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö –≤ 24 —Ä–∞–∑–∞ (–ø–æ—á–∞—Å–æ–≤—ã–µ ‚Üí –¥–Ω–µ–≤–Ω—ã–µ)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢–µ—Ä—è–µ—Ç—Å—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —á–∞—Å–∞–º –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏

### 3. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è**: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –º–µ—Å—è—Ü–∞–º).

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –£–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
- –£–ø—Ä–æ—â–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è PostgreSQL/Supabase

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã
- –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 4. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π:**
1. **–ê–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3-6 –º–µ—Å—è—Ü–µ–≤): –•—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
2. **–ê—Ä—Ö–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (—Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤): –ê–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –≤ –¥–Ω–µ–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–º–µ—â–∞—é—Ç—Å—è –≤ –∞—Ä—Ö–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
3. **–û—á–µ–Ω—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ** (—Å—Ç–∞—Ä—à–µ 2 –ª–µ—Ç): –£–¥–∞–ª—è—é—Ç—Å—è –∏–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–∞–π–ª—ã

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

**–¶–µ–ª—å**: –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏ —Ä–æ—Å—Ç –¥–∞–Ω–Ω—ã—Ö.

**–ó–∞–¥–∞—á–∏:**
1. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
2. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

**SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
```sql
CREATE OR REPLACE FUNCTION public.get_storage_stats()
RETURNS TABLE (
  table_name TEXT,
  row_count BIGINT,
  table_size TEXT,
  oldest_record TIMESTAMPTZ,
  newest_record TIMESTAMPTZ
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    'beliot_device_readings'::TEXT,
    COUNT(*)::BIGINT,
    pg_size_pretty(pg_total_relation_size('public.beliot_device_readings'))::TEXT,
    MIN(reading_date),
    MAX(reading_date)
  FROM public.beliot_device_readings;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã

**–¶–µ–ª—å**: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

**–ó–∞–¥–∞—á–∏:**
1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `beliot_device_readings_archive`
2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: device_id, date (–¥–µ–Ω—å), daily_avg, daily_min, daily_max, hourly_count
3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

**SQL –º–∏–≥—Ä–∞—Ü–∏—è:**
```sql
-- –ê—Ä—Ö–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
CREATE TABLE IF NOT EXISTS public.beliot_device_readings_archive (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  device_id TEXT NOT NULL,
  archive_date DATE NOT NULL,
  daily_avg_value NUMERIC(12, 3),
  daily_min_value NUMERIC(12, 3),
  daily_max_value NUMERIC(12, 3),
  hourly_count INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  CONSTRAINT unique_device_archive_date UNIQUE (device_id, archive_date)
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_archive_device_date 
  ON public.beliot_device_readings_archive(device_id, archive_date DESC);
```

### –≠—Ç–∞–ø 3: –§—É–Ω–∫—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

**–¶–µ–ª—å**: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ—á–∞—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –¥–Ω–µ–≤–Ω—ã–µ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏–≤.

**–ó–∞–¥–∞—á–∏:**
1. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `archive_old_readings(months_to_keep INTEGER)`
2. –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º
3. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –∞—Ä—Ö–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
4. –£–¥–∞–ª–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏

**SQL —Ñ—É–Ω–∫—Ü–∏—è:**
```sql
CREATE OR REPLACE FUNCTION public.archive_old_readings(
  p_months_to_keep INTEGER DEFAULT 6
)
RETURNS TABLE (
  archived_count BIGINT,
  deleted_count BIGINT
) AS $$
DECLARE
  v_cutoff_date DATE;
  v_archived BIGINT;
  v_deleted BIGINT;
BEGIN
  -- –î–∞—Ç–∞ –æ—Ç—Å–µ—á–∫–∏: —Å—Ç–∞—Ä—à–µ N –º–µ—Å—è—Ü–µ–≤
  v_cutoff_date := CURRENT_DATE - (p_months_to_keep || ' months')::INTERVAL;
  
  -- –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –∞—Ä—Ö–∏–≤
  INSERT INTO public.beliot_device_readings_archive (
    device_id,
    archive_date,
    daily_avg_value,
    daily_min_value,
    daily_max_value,
    hourly_count
  )
  SELECT 
    device_id,
    reading_date::DATE,
    AVG(reading_value)::NUMERIC(12, 3),
    MIN(reading_value)::NUMERIC(12, 3),
    MAX(reading_value)::NUMERIC(12, 3),
    COUNT(*)::INTEGER
  FROM public.beliot_device_readings
  WHERE reading_date::DATE < v_cutoff_date
  GROUP BY device_id, reading_date::DATE
  ON CONFLICT (device_id, archive_date) 
  DO UPDATE SET
    daily_avg_value = EXCLUDED.daily_avg_value,
    daily_min_value = EXCLUDED.daily_min_value,
    daily_max_value = EXCLUDED.daily_max_value,
    hourly_count = EXCLUDED.hourly_count;
  
  GET DIAGNOSTICS v_archived = ROW_COUNT;
  
  -- –£–¥–∞–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏
  DELETE FROM public.beliot_device_readings
  WHERE reading_date::DATE < v_cutoff_date;
  
  GET DIAGNOSTICS v_deleted = ROW_COUNT;
  
  RETURN QUERY SELECT v_archived, v_deleted;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### –≠—Ç–∞–ø 4: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

**–¶–µ–ª—å**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏.

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
1. **GitHub Actions** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
2. **Supabase Cron Jobs**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ pg_cron (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
3. **Railway Cron**: –û—Ç–¥–µ–ª—å–Ω—ã–π cron job –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

**GitHub Actions workflow:**
```yaml
name: Archive Old Readings
on:
  schedule:
    - cron: '0 2 * * 0'  # –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 2:00
  workflow_dispatch:

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run archive-readings
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
```

### –≠—Ç–∞–ø 5: –°–∫—Ä–∏–ø—Ç –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

**–¶–µ–ª—å**: –°–æ–∑–¥–∞—Ç—å Node.js —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏.

**–§–∞–π–ª**: `scripts/archive-old-readings.ts`

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.SUPABASE_URL!;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;
const monthsToKeep = parseInt(process.env.MONTHS_TO_KEEP || '6');

const supabase = createClient(supabaseUrl, supabaseKey);

async function archiveReadings() {
  console.log(`üì¶ –ù–∞—á–∞–ª–æ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ä—à–µ ${monthsToKeep} –º–µ—Å—è—Ü–µ–≤...`);
  
  const { data, error } = await supabase.rpc('archive_old_readings', {
    p_months_to_keep: monthsToKeep
  });
  
  if (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏:', error);
    process.exit(1);
  }
  
  console.log('‚úÖ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:');
  console.log(`   - –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data[0].archived_count}`);
  console.log(`   - –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data[0].deleted_count}`);
}

archiveReadings();
```

### –≠—Ç–∞–ø 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞

**–¶–µ–ª—å**: –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—Ä—Ö–∏–≤–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

**–ó–∞–¥–∞—á–∏:**
1. –°–æ–∑–¥–∞—Ç—å API —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∞—Ä—Ö–∏–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–≤—É–º—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ü–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–∞–∫—Ç–∏–≤–Ω—ã–µ/–∞—Ä—Ö–∏–≤–Ω—ã–µ)

### –≠—Ç–∞–ø 7: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

**–¶–µ–ª—å**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.

**–ó–∞–¥–∞—á–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –≤ —Å–∫—Ä–∏–ø—Ç –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
2. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–æ–≤
3. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### –î–ª—è –æ—á–µ–Ω—å –º–∞–ª—ã—Ö —Å–∏—Å—Ç–µ–º (10-20 —É—Å—Ç—Ä–æ–π—Å—Ç–≤) ‚≠ê –¢–ï–ö–£–©–ê–Ø –°–ò–°–¢–ï–ú–ê
- **–ü–µ—Ä–∏–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: **5-10 –ª–µ—Ç** (–∞—Ä—Ö–∏–≤–∞—Ü–∏—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞)
- **–ß–∞—Å—Ç–æ—Ç–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–ª–∏ —Ä–∞–∑ –≤ –≥–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **–•—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
- **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**: –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≥–æ–¥ ~28.6 –ú–ë, –∑–∞ 10 –ª–µ—Ç ~286 –ú–ë. Supabase Free tier –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç 500 –ú–ë.

### –î–ª—è –º–∞–ª—ã—Ö —Å–∏—Å—Ç–µ–º (21-100 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- **–ü–µ—Ä–∏–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: 2-3 –≥–æ–¥–∞
- **–ß–∞—Å—Ç–æ—Ç–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏**: –†–∞–∑ –≤ –ø–æ–ª–≥–æ–¥–∞ –∏–ª–∏ —Ä–∞–∑ –≤ –≥–æ–¥
- **–•—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: 2 –≥–æ–¥–∞

### –î–ª—è —Å—Ä–µ–¥–Ω–∏—Ö —Å–∏—Å—Ç–µ–º (100-500 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- **–ü–µ—Ä–∏–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: 6 –º–µ—Å—è—Ü–µ–≤ - 1 –≥–æ–¥
- **–ß–∞—Å—Ç–æ—Ç–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏**: –ï–∂–µ–º–µ—Å—è—á–Ω–æ –∏–ª–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
- **–•—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: 1-2 –≥–æ–¥–∞

### –î–ª—è –±–æ–ª—å—à–∏—Ö —Å–∏—Å—Ç–µ–º (> 500 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- **–ü–µ—Ä–∏–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: 1-3 –º–µ—Å—è—Ü–∞
- **–ß–∞—Å—Ç–æ—Ç–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏**: –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
- **–•—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: 6 –º–µ—Å—è—Ü–µ–≤ - 1 –≥–æ–¥

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –°–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TOAST –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ JSONB –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

### 2. –ò–Ω–¥–µ–∫—Å—ã
- –†–µ–≥—É–ª—è—Ä–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
- –£–¥–∞–ª—è—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã

### 3. –í–∞–∫—É—É–º
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VACUUM –≤ Supabase
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é —Ç–∞–±–ª–∏—Ü

### 4. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Å–∏—Å—Ç–µ–º)
- –†–∞–∑–¥–µ–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ –º–µ—Å—è—Ü–∞–º
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π

## –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ `get_storage_stats()`
- [ ] –°–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `beliot_device_readings_archive`
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ `archive_old_readings()`
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç `archive-old-readings.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å GitHub Actions workflow –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—Ä—Ö–∏–≤–æ–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–í—ã—Å–æ–∫–∏–π**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
2. **–í—ã—Å–æ–∫–∏–π**: –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏
3. **–°—Ä–µ–¥–Ω–∏–π**: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
4. **–°—Ä–µ–¥–Ω–∏–π**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞
5. **–ù–∏–∑–∫–∏–π**: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
