# Telegram Bot для управления оборудованием

## Обзор проекта

AI-ассистент в Telegram для сотрудников, обслуживающих оборудование. Бот позволяет:
- Просматривать информацию об оборудовании
- Добавлять записи в журнал обслуживания
- Прикреплять фото к записям
- Использовать голосовые сообщения для ввода данных
- Получать уведомления о запланированном обслуживании

---

## Архитектура

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│    Telegram     │────▶│  Bot Server      │────▶│  Anthropic API  │
│    (Клиент)     │◀────│  (Railway)       │◀────│  (Claude)       │
└─────────────────┘     └────────┬─────────┘     └─────────────────┘
                                 │
                    ┌────────────┼────────────┐
                    ▼            ▼            ▼
            ┌───────────┐ ┌───────────┐ ┌───────────┐
            │  Supabase │ │  GAS API  │ │  Google   │
            │  (Auth)   │ │(Equipment)│ │  Drive    │
            └───────────┘ └───────────┘ └───────────┘
```

### Компоненты

1. **Telegram Bot Server** (Node.js на Railway)
   - Обработка webhook от Telegram
   - Интеграция с Anthropic API для AI
   - Whisper API для распознавания голоса
   - Управление сессиями пользователей

2. **Внешние сервисы**
   - **Supabase** — авторизация, проверка доступа
   - **GAS API** — CRUD оборудования и журнала
   - **Google Drive** — хранение фото
   - **Anthropic API** — AI-ассистент (Claude)
   - **OpenAI Whisper** или **Google Speech-to-Text** — распознавание голоса

---

## Функциональные требования

### 1. Авторизация

| Шаг | Действие |
|-----|----------|
| 1 | Пользователь отправляет `/start` |
| 2 | Бот запрашивает email |
| 3 | Бот проверяет email в Supabase (таблица `profiles`) |
| 4 | Если пользователь найден и имеет доступ к equipment — авторизация успешна |
| 5 | Telegram ID сохраняется в `profiles.telegram_id` |
| 6 | При повторном входе — автоматическая авторизация по Telegram ID |

### 2. Команды бота

```
/start      - Начало работы / авторизация
/help       - Справка по командам
/equipment  - Список всего оборудования
/search     - Поиск оборудования по названию
/maintenance [id] - Журнал обслуживания оборудования
/add        - Добавить запись обслуживания (интерактивный режим)
/settings   - Настройки уведомлений
/logout     - Выход из аккаунта
```

### 3. AI-ассистент (свободный текст)

Пользователь может писать на естественном языке:

```
"Покажи журнал обслуживания фильтра обезжелезивания №1"
"Добавь запись: провели очистку корпуса фильтра, работы выполнил Сидорович"
"Какое оборудование требует обслуживания на этой неделе?"
"Найди все котлы"
```

### 4. Голосовые сообщения (Self-hosted Whisper)

**Почему self-hosted:**
- OpenAI API имеет ограничения по странам
- Whisper — open-source модель, можно запускать локально
- Бесплатно (только ресурсы Railway)
- Данные не уходят третьим лицам

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Голосовое      │────▶│  faster-whisper │────▶│  Текст          │
│  сообщение      │     │  (на Railway)   │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
                                                ┌─────────────────┐
                                                │  Claude AI      │
                                                │  (обработка)    │
                                                └─────────────────┘
```

**Техническая реализация Whisper:**
```python
# whisper_service.py (Python микросервис)
from faster_whisper import WhisperModel

# Используем модель "small" - баланс скорости и качества
model = WhisperModel("small", device="cpu", compute_type="int8")

def transcribe(audio_path: str) -> str:
    segments, info = model.transcribe(audio_path, language="ru")
    return " ".join([segment.text for segment in segments])
```

**Модели Whisper (выбор по ресурсам):**
| Модель | RAM | Скорость | Качество |
|--------|-----|----------|----------|
| tiny | ~1GB | Очень быстро | Базовое |
| base | ~1GB | Быстро | Хорошее |
| small | ~2GB | Средне | Отличное ✓ |
| medium | ~5GB | Медленно | Превосходное |

**Сценарий:**
1. Пользователь записывает голосовое: "Сегодня заменили фильтрующий элемент на фильтре номер два, работы проводил Петров"
2. Whisper транскрибирует в текст
3. Claude извлекает данные:
   - Оборудование: "Фильтр №2"
   - Тип работ: "Замена фильтрующего элемента"
   - Исполнитель: "Петров"
   - Дата: сегодня
4. Бот показывает превью и просит подтверждение
5. После подтверждения — запись добавляется в журнал

### 5. Фото с привязкой к записям

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Фото от        │────▶│  Bot Server     │────▶│  Google Drive   │
│  пользователя   │     │  (загрузка)     │     │  (папка обор.)  │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
                                                ┌─────────────────┐
                                                │  GAS API        │
                                                │  (ссылка в лог) │
                                                └─────────────────┘
```

**Сценарий добавления фото:**
1. Пользователь выбирает оборудование или использует контекст
2. Отправляет фото с подписью (caption)
3. Бот загружает фото в папку оборудования на Google Drive
4. Создает запись в журнале с ссылкой на фото
5. Подтверждает успешное добавление

**Структура хранения фото:**
```
📁 Оборудование/
├── 📁 Фильтр обезжелезивания №1/
│   ├── 📁 Фото обслуживания/
│   │   ├── 2024-01-15_замена_фильтра.jpg
│   │   └── 2024-01-20_осмотр.jpg
│   └── ...
```

### 6. Уведомления

- **Напоминания о плановом ТО** — за 1 день и в день обслуживания
- **Уведомления о просроченном ТО** — если дата прошла
- **Настраиваемое время** — пользователь выбирает удобное время

---

## Техническая реализация

### Стек технологий

| Компонент | Технология |
|-----------|------------|
| Runtime | Node.js 20+ / Python 3.11 (для Whisper) |
| Framework | grammy (Telegram Bot API) |
| AI | Anthropic Claude API |
| Speech-to-Text | Self-hosted Whisper (faster-whisper) |
| Database | Supabase (PostgreSQL) |
| Equipment API | Google Apps Script |
| File Storage | Google Drive API |
| Hosting | Railway |
| Language | TypeScript / Python |

### Структура проекта

```
telegram-bot/
├── src/                         # TypeScript (основной бот)
│   ├── index.ts                 # Точка входа
│   ├── bot.ts                   # Конфигурация бота
│   ├── config/
│   │   └── env.ts               # Переменные окружения
│   ├── handlers/
│   │   ├── commands/
│   │   │   ├── start.ts         # /start
│   │   │   ├── help.ts          # /help
│   │   │   ├── equipment.ts     # /equipment, /search
│   │   │   ├── maintenance.ts   # /maintenance, /add
│   │   │   └── settings.ts      # /settings
│   │   ├── messages/
│   │   │   ├── text.ts          # Обработка текста → AI
│   │   │   ├── voice.ts         # Голосовые сообщения
│   │   │   └── photo.ts         # Фото с подписями
│   │   └── callbacks/
│   │       ├── equipment.ts     # Inline кнопки оборудования
│   │       ├── maintenance.ts   # Кнопки журнала
│   │       └── confirm.ts       # Подтверждения действий
│   ├── services/
│   │   ├── anthropic.ts         # Claude AI
│   │   ├── whisper.ts           # Клиент для Whisper сервиса
│   │   ├── gas.ts               # GAS API клиент
│   │   ├── supabase.ts          # Supabase клиент
│   │   └── drive.ts             # Google Drive API
│   ├── tools/
│   │   ├── index.ts             # Регистрация tools
│   │   ├── equipmentTools.ts    # Tools для оборудования
│   │   ├── maintenanceTools.ts  # Tools для журнала
│   │   └── driveTools.ts        # Tools для файлов
│   ├── middleware/
│   │   ├── auth.ts              # Проверка авторизации
│   │   ├── access.ts            # Проверка доступа
│   │   └── logger.ts            # Логирование
│   ├── utils/
│   │   ├── keyboard.ts          # Генерация клавиатур
│   │   ├── format.ts            # Форматирование сообщений
│   │   └── session.ts           # Управление сессиями
│   └── types/
│       ├── context.ts           # Типы контекста бота
│       ├── session.ts           # Типы сессии
│       └── api.ts               # Типы API
│
├── whisper/                     # Python (Whisper сервис)
│   ├── main.py                  # FastAPI сервер
│   ├── transcribe.py            # Логика транскрипции
│   ├── requirements.txt         # Python зависимости
│   └── Dockerfile               # Docker для Whisper
│
├── package.json
├── tsconfig.json
├── Dockerfile                   # Docker для основного бота
├── docker-compose.yml           # Оркестрация сервисов
├── railway.toml
└── .env.example
```

### Архитектура сервисов на Railway

```
┌─────────────────────────────────────────────────────────┐
│                      Railway                            │
│  ┌─────────────────┐      ┌─────────────────────────┐  │
│  │   Bot Service   │      │   Whisper Service       │  │
│  │   (Node.js)     │─────▶│   (Python + FastAPI)    │  │
│  │   Port 3000     │      │   Port 8000             │  │
│  └─────────────────┘      └─────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

**Вариант деплоя:**
- **Monorepo** — оба сервиса в одном репозитории, Railway разворачивает оба
- **Один контейнер** — Node.js + Python в одном Dockerfile (проще)

### Модель данных (Supabase)

**Новые поля в таблице `profiles`:**
```sql
ALTER TABLE profiles ADD COLUMN telegram_id BIGINT UNIQUE;
ALTER TABLE profiles ADD COLUMN telegram_username VARCHAR(255);
ALTER TABLE profiles ADD COLUMN bot_notifications_enabled BOOLEAN DEFAULT true;
ALTER TABLE profiles ADD COLUMN bot_notification_time TIME DEFAULT '09:00';
```

**Новая таблица для сессий бота:**
```sql
CREATE TABLE bot_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  telegram_id BIGINT NOT NULL UNIQUE,
  user_id UUID REFERENCES profiles(id),
  state JSONB DEFAULT '{}',
  context JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API Endpoints (GAS)

Существующие endpoints используются без изменений:
- `getEquipment` — получить оборудование
- `getAllEquipment` — список оборудования
- `getMaintenanceLog` — журнал обслуживания
- `addMaintenanceEntry` — добавить запись

**Новый endpoint для фото:**
```javascript
// В Code.gs добавить:
case 'uploadMaintenancePhoto':
  return handleUploadMaintenancePhoto(data);
```

### Tools для Claude

```typescript
const tools = [
  {
    name: "get_all_equipment",
    description: "Получить список всего оборудования. Используй когда пользователь хочет увидеть все оборудование или найти что-то.",
    input_schema: {
      type: "object",
      properties: {
        search: { type: "string", description: "Поисковый запрос (опционально)" },
        type: { type: "string", description: "Тип оборудования (опционально)" },
        status: { type: "string", enum: ["active", "inactive", "archived"] }
      }
    }
  },
  {
    name: "get_equipment_details",
    description: "Получить детальную информацию об одном оборудовании по ID",
    input_schema: {
      type: "object",
      properties: {
        equipment_id: { type: "string", description: "ID оборудования" }
      },
      required: ["equipment_id"]
    }
  },
  {
    name: "get_maintenance_log",
    description: "Получить журнал обслуживания оборудования",
    input_schema: {
      type: "object",
      properties: {
        equipment_id: { type: "string", description: "ID оборудования" },
        limit: { type: "number", description: "Количество записей (по умолчанию 10)" }
      },
      required: ["equipment_id"]
    }
  },
  {
    name: "add_maintenance_entry",
    description: "Добавить новую запись в журнал обслуживания. Используй когда пользователь сообщает о проведенных работах.",
    input_schema: {
      type: "object",
      properties: {
        equipment_id: { type: "string", description: "ID оборудования" },
        date: { type: "string", description: "Дата в формате YYYY-MM-DD" },
        type: { type: "string", description: "Тип работ" },
        description: { type: "string", description: "Описание выполненных работ" },
        performed_by: { type: "string", description: "Кто выполнил работы" }
      },
      required: ["equipment_id", "date", "type", "description", "performed_by"]
    }
  },
  {
    name: "search_equipment",
    description: "Поиск оборудования по названию или характеристикам",
    input_schema: {
      type: "object",
      properties: {
        query: { type: "string", description: "Поисковый запрос" }
      },
      required: ["query"]
    }
  }
];
```

---

## Этапы разработки

### Этап 1: Базовая инфраструктура (1-2 дня)
- [ ] Создать бота через @BotFather
- [ ] Настроить проект (TypeScript, grammy)
- [ ] Настроить деплой на Railway
- [ ] Реализовать webhook
- [ ] Базовые команды `/start`, `/help`

### Этап 2: Авторизация (1 день)
- [ ] Добавить поля в Supabase (`telegram_id`)
- [ ] Реализовать flow авторизации по email
- [ ] Middleware проверки доступа
- [ ] Команда `/logout`

### Этап 3: Работа с оборудованием (1-2 дня)
- [ ] Интеграция с GAS API
- [ ] Команда `/equipment` — список с пагинацией
- [ ] Команда `/search` — поиск
- [ ] Inline кнопки для навигации
- [ ] Детальная информация об оборудовании

### Этап 4: Журнал обслуживания (1-2 дня)
- [ ] Команда `/maintenance` — просмотр журнала
- [ ] Команда `/add` — интерактивное добавление записи
- [ ] Подтверждение перед сохранением
- [ ] Отображение истории записей

### Этап 5: AI-ассистент (2-3 дня)
- [ ] Интеграция с Anthropic API
- [ ] Определение tools
- [ ] Обработка свободного текста
- [ ] Контекст диалога (помнит выбранное оборудование)
- [ ] Красивое форматирование ответов

### Этап 6: Голосовые сообщения (1-2 дня)
- [ ] Интеграция с Whisper API
- [ ] Обработка voice messages
- [ ] Транскрипция → AI → действие
- [ ] Подтверждение распознанного текста

### Этап 7: Работа с фото (1-2 дня)
- [ ] Google Drive API интеграция
- [ ] Загрузка фото в папку оборудования
- [ ] Привязка фото к записям журнала
- [ ] Просмотр фото из журнала

### Этап 8: Уведомления (1 день)
- [ ] Cron job для проверки плановых ТО
- [ ] Настройки уведомлений `/settings`
- [ ] Отправка напоминаний

### Этап 9: Тестирование и polish (2-3 дня)
- [ ] Тестирование всех сценариев
- [ ] Обработка ошибок
- [ ] Улучшение UX
- [ ] Документация

**Общая оценка: 12-18 дней разработки**

---

## Переменные окружения

```env
# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_WEBHOOK_URL=https://your-app.railway.app/webhook

# Anthropic
ANTHROPIC_API_KEY=sk-ant-...

# Whisper (self-hosted, без API ключа)
WHISPER_MODEL=small  # tiny, base, small, medium
WHISPER_LANGUAGE=ru

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_KEY=eyJ...

# GAS API
GAS_API_URL=https://script.google.com/macros/s/.../exec

# Google Drive (Service Account)
GOOGLE_SERVICE_ACCOUNT_EMAIL=...@...iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n..."
GOOGLE_DRIVE_ROOT_FOLDER_ID=...
```

---

## Примеры диалогов

### Пример 1: Авторизация
```
Пользователь: /start
Бот: 👋 Добро пожаловать в бот управления оборудованием!
     Для начала работы введите ваш email:

Пользователь: ivanov@company.com
Бот: ✅ Авторизация успешна!
     Добро пожаловать, Иванов Иван!

     Используйте /help для списка команд или просто напишите что вам нужно.
```

### Пример 2: Голосовое сообщение
```
Пользователь: [Голосовое сообщение]
             "Сегодня заменили фильтрующий элемент на втором фильтре,
              работы проводил Сидорович"

Бот: 🎤 Распознано:
     "Сегодня заменили фильтрующий элемент на втором фильтре,
      работы проводил Сидорович"

     📝 Создать запись?

     🔧 Оборудование: Фильтр обезжелезивания №2
     📅 Дата: 2024-01-15
     📋 Тип работ: Замена фильтрующего элемента
     📝 Описание: Заменили фильтрующий элемент
     👷 Исполнитель: Сидорович

     [✅ Подтвердить] [✏️ Изменить] [❌ Отмена]

Пользователь: [Нажимает "✅ Подтвердить"]
Бот: ✅ Запись добавлена в журнал обслуживания!
```

### Пример 3: Фото с описанием
```
Пользователь: [Фото]
             Подпись: "Состояние фильтра после очистки, фильтр №1"

Бот: 📷 Фото получено!

     Добавить к записи обслуживания?

     🔧 Оборудование: Фильтр обезжелезивания №1
     📝 Описание: Состояние фильтра после очистки

     [✅ Добавить запись с фото] [📁 Только сохранить фото] [❌ Отмена]

Пользователь: [Нажимает "✅ Добавить запись с фото"]
Бот: ✅ Запись добавлена!
     📷 Фото сохранено: [Ссылка на Google Drive]
```

### Пример 4: Свободный запрос
```
Пользователь: Покажи что обслуживали на прошлой неделе

Бот: 📊 Обслуживание за последнюю неделю:

     🔧 Фильтр обезжелезивания №1
     └─ 12.01: Замена фильтрующего элемента (Петров)

     🔧 Котел КВГМ-50
     └─ 10.01: Плановое ТО (Сидорович)
     └─ 11.01: Проверка автоматики (Иванов)

     🔧 Насос Grundfos
     └─ 09.01: Замена сальника (Петров)

     Всего: 4 записи
```

---

## Безопасность

1. **Авторизация** — только пользователи из Supabase с доступом к equipment
2. **Webhook секрет** — проверка подписи от Telegram
3. **Rate limiting** — ограничение запросов
4. **Логирование** — все действия записываются
5. **Валидация** — проверка всех входных данных
6. **API ключи** — хранятся в переменных окружения Railway

---

## Мониторинг

- **Railway Logs** — логи приложения
- **Sentry** — отслеживание ошибок (опционально)
- **Telegram Admin** — уведомления об ошибках админу

---

---

## Стоимость эксплуатации

| Компонент | Стоимость | Примечание |
|-----------|-----------|------------|
| Railway (Bot + Whisper) | ~$5-10/мес | Зависит от нагрузки |
| Anthropic Claude API | ~$0.01-0.03/диалог | Sonnet для сложных, Haiku для простых |
| Whisper | Бесплатно | Self-hosted на Railway |
| Supabase | Бесплатно | Free tier достаточно |
| Google Drive | Бесплатно | Существующий аккаунт |

**Итого: ~$5-15/месяц** (зависит от количества пользователей и диалогов)

---

## Дальнейшее развитие

1. **Групповые чаты** — бот в рабочих группах
2. **Расписание ТО** — автоматическое создание задач
3. **Статистика** — отчеты по обслуживанию
4. **Интеграция с календарем** — синхронизация с Google Calendar
5. **Мультиязычность** — поддержка других языков
