# üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Multi-Provider Architecture

Multi-provider –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞**! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ Gemini (–±–µ—Å–ø–ª–∞—Ç–Ω–æ), —Ç–∞–∫ –∏ Claude API.

## ‚úÖ –ß—Ç–æ –≥–æ—Ç–æ–≤–æ

- ‚úÖ **Claude Provider** - —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞
- ‚úÖ **Gemini Provider** - –Ω–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º tier
- ‚úÖ **Provider Factory** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∏ fallback
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –æ–±–Ω–æ–≤–ª—ë–Ω `/api/chat` —ç–Ω–¥–ø–æ–∏–Ω—Ç
- ‚úÖ **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `.env` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

## üìã –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á Gemini (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)

‚ö†Ô∏è **–í–ê–ñ–ù–û:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ Google –∞–∫–∫–∞—É–Ω—Ç, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–∞—à–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Google Sheets —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º)!

1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)
2. **–í–æ–π—Ç–∏ —Å Google –∞–∫–∫–∞—É–Ω—Ç–æ–º**, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è Google Sheets —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
3. –ù–∞–∂–∞—Ç—å **"Create API Key"**
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á (—Ñ–æ—Ä–º–∞—Ç: `AIzaSy...`)

**–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç:** 15 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!

**–ü–æ—á–µ–º—É —Ç–æ—Ç –∂–µ –∞–∫–∫–∞—É–Ω—Ç?** Gemini API –∏ Google Apps Script (GAS API) –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –æ–¥–Ω–æ–≥–æ Google workspace –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º.

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `.env`

–û—Ç–∫—Ä–æ–π—Ç–µ `ai-consultant-api/.env` –∏ –¥–æ–±–∞–≤—å—Ç–µ:

```env
# –í—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (gemini | claude)
AI_PROVIDER=gemini

# Gemini API (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
GEMINI_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXX
GEMINI_MODEL=gemini-2.0-flash-exp

# Claude API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ–Ω—å–≥–∏)
ANTHROPIC_API_KEY=sk-ant-api03-xxxxx
CLAUDE_MODEL=claude-sonnet-4-20250514
```

**–í–∞–∂–Ω–æ:** –ù—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã **–æ–¥–∏–Ω** API –∫–ª—é—á (Gemini –∏–ª–∏ Claude).

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
cd ai-consultant-api
npm install  # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç @google/generative-ai
npm run dev
```

–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ `http://localhost:3001`

## üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏

### –ß–µ—Ä–µ–∑ `.env` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ò–∑–º–µ–Ω–∏—Ç–µ `AI_PROVIDER` –≤ `.env`:

```env
AI_PROVIDER=gemini   # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Gemini
AI_PROVIDER=claude   # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Claude
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä.

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Fallback

–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç API –∫–ª—é—á–∞ –∏–ª–∏ API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç), —Å–∏—Å—Ç–µ–º–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è** –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä.

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:

```
[ProviderFactory] Preferred provider claude is not configured, using fallback...
[ProviderFactory] Fallback to gemini provider
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

```bash
cd ai-consultant-api
node -e "
const { ProviderFactory } = require('./dist/services/ai/index.js');
const available = ProviderFactory.getAvailableProviders();
console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:', available);
"
```

### –¢–µ—Å—Ç —á–µ—Ä–µ–∑ API

```bash
curl -X POST http://localhost:3001/api/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "messages": [
      {"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç! –ù–∞–π–¥–∏ –≤—Å—ë –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"}
    ]
  }'
```

–û—Ç–≤–µ—Ç –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:

```json
{
  "success": true,
  "data": {
    "message": "–ù–∞–π–¥–µ–Ω–æ 5 –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...",
    "toolsUsed": ["get_all_equipment"],
    "provider": "Gemini",
    "tokensUsed": {
      "input": 1234,
      "output": 567
    }
  }
}
```

–ü–æ–ª–µ `provider` –ø–æ–∫–∞–∂–µ—Ç –∫–∞–∫–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | –°—Ç–æ–∏–º–æ—Å—Ç—å | –õ–∏–º–∏—Ç—ã (–±–µ—Å–ø–ª–∞—Ç–Ω–æ) | –ú–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –°–∫–æ—Ä–æ—Å—Ç—å |
|-----------|-----------|-------------------|---------------------|----------|
| **Gemini** | üü¢ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ | 15 req/min | gemini-2.0-flash-exp | ‚ö°‚ö°‚ö° –ë—ã—Å—Ç—Ä–æ |
| **Claude** | üî¥ –ü–ª–∞—Ç–Ω–æ | - | claude-sonnet-4-5 | ‚ö°‚ö° –°—Ä–µ–¥–Ω–µ |
| OpenAI | üî¥ –ü–ª–∞—Ç–Ω–æ | - | (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω) | - |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Gemini –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, Claude –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å).

## üõ†Ô∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  POST /api/chat                                     ‚îÇ
‚îÇ         ‚Üì                                           ‚îÇ
‚îÇ  ProviderFactory.create()                           ‚îÇ
‚îÇ         ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ AI_PROVIDER –≤ .env              ‚îÇ
‚îÇ         ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ isAvailable()                   ‚îÇ
‚îÇ         ‚îî‚îÄ Fallback –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä          ‚îÇ
‚îÇ         ‚Üì                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ ClaudeProvider   ‚îÇ  ‚îÇ GeminiProvider   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ (anthropic SDK)  ‚îÇ  ‚îÇ (generative-ai)  ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ         ‚Üì                      ‚Üì                    ‚îÇ
‚îÇ  –ê–≥–µ–Ω—Ç–Ω—ã–π —Ü–∏–∫–ª —Å tool calling                       ‚îÇ
‚îÇ         ‚Üì                                           ‚îÇ
‚îÇ  –í–æ–∑–≤—Ä–∞—Ç { message, toolsUsed, provider }           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (–æ–¥–Ω–∞ –∏–∑ –≥—Ä—É–ø–ø)

**Gemini:**
- `GEMINI_API_KEY` - API –∫–ª—é—á Google AI Studio

**Claude:**
- `ANTHROPIC_API_KEY` - API –∫–ª—é—á Anthropic

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ

- `AI_PROVIDER` - –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä (default: `gemini`)
- `GEMINI_MODEL` - –ú–æ–¥–µ–ª—å Gemini (default: `gemini-2.0-flash-exp`)
- `CLAUDE_MODEL` - –ú–æ–¥–µ–ª—å Claude (default: `claude-sonnet-4-20250514`)

### –û—Å—Ç–∞–ª—å–Ω—ã–µ (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)

- `SUPABASE_URL`, `SUPABASE_SERVICE_KEY` - –î–ª—è JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `GAS_API_URL` - URL Google Apps Script –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
- `PORT`, `NODE_ENV`, `ALLOWED_ORIGINS` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞: "No AI providers available"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∏ –æ–¥–∏–Ω API –∫–ª—é—á.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤—å—Ç–µ `GEMINI_API_KEY` –∏–ª–∏ `ANTHROPIC_API_KEY` –≤ `.env`.

---

### –û—à–∏–±–∫–∞: "API_KEY_INVALID" (Gemini)

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π API –∫–ª—é—á.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ (–¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `AIzaSy`)
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á –Ω–∞ [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)

---

### –û—à–∏–±–∫–∞: "RESOURCE_EXHAUSTED" (Gemini)

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç 15 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É.

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É
- –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Claude API –∫–∞–∫ fallback

---

### –ü—Ä–æ–≤–∞–π–¥–µ—Ä –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ fallback

**–ü—Ä–∏—á–∏–Ω–∞:** –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É `isAvailable()`.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `[ProviderFactory] ...`

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

- **–ü–æ–ª–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** `doc/multi-provider-implementation-plan.md`
- **–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤:** `ai-consultant-api/src/services/ai/providers/`
- **–ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è tool calling:** `ai-consultant-api/src/services/ai/adapters/`

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å:
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä (Gemini)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (OpenAI, Ollama)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å—Ç–∞—Ä—ã–π –∫–æ–¥ (anthropic.ts) –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–∫–∞—Ç–∞

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –∏ –Ω–∞—á–∏–Ω–∞–π—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É!** üöÄ
