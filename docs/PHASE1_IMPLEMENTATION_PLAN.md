# План реализации Фазы 1: База данных на Google Sheets

## Цель
Создать систему хранения данных об оборудовании в Google Sheets с возможностью чтения и записи через API.

---

## Шаг 1: Создание структуры Google Sheets таблицы

### 1.1. Создать новую таблицу "База данных оборудования"

**Название листа:** `Оборудование`

**Структура таблицы (заголовки в первой строке):**

| A | B | C | D | E | F | G | H | I | J | K |
|---|---|---|---|---|---|---|---|---|---|---|
| ID | Название | Тип | Характеристики | Google Drive URL | QR Code URL | Дата ввода | Последнее обслуживание | Статус | Создано | Обновлено |

**Детальное описание колонок:**

| Колонка | Название | Тип данных | Описание | Пример |
|---------|----------|------------|----------|--------|
| A | ID | Текст | Уникальный идентификатор | `550e8400-e29b-41d4-a716-446655440000` |
| B | Название | Текст | Полное название оборудования | `Фильтр обезжелезивания ФО-0,8-1,5 №1` |
| C | Тип | Текст | Тип оборудования | `filter`, `pump`, `tank` |
| D | Характеристики | Текст (JSON) | JSON строка с характеристиками | `{"height":"1,5 м","diameter":"0,8 м",...}` |
| E | Google Drive URL | Текст | Ссылка на папку в Google Drive | `https://drive.google.com/...` |
| F | QR Code URL | Текст | URL для QR-кода | `https://drive.google.com/...` |
| G | Дата ввода | Дата | Дата ввода в эксплуатацию | `2024-01-15` |
| H | Последнее обслуживание | Дата | Дата последнего обслуживания | `2024-01-20` |
| I | Статус | Текст | Статус оборудования | `active`, `inactive`, `archived` |
| J | Создано | Дата и время | Дата создания записи | `2024-01-15 10:30:00` |
| K | Обновлено | Дата и время | Дата последнего обновления | `2024-01-20 14:00:00` |

### 1.2. Настройка форматов

- **Колонка A (ID):** Текст
- **Колонка D (Характеристики):** Текст (для JSON)
- **Колонка G, H (Даты):** Формат → Число → Дата
- **Колонка J, K (Временные метки):** Формат → Число → Дата и время

### 1.3. Защита заголовков

1. Выделите первую строку
2. Вид → Зафиксировать → 1 строку
3. (Опционально) Защитить строку от редактирования

---

## Шаг 2: Создание Google Apps Script для API

### 2.1. Структура проекта

**Создать папку:** `backend/equipment-db/`

Эта папка будет содержать код Google Apps Script для API базы данных оборудования.

### 2.2. Создать новый проект Google Apps Script

1. В таблице Google Sheets: **Расширения → Apps Script**
2. Назвать проект: **"API для базы данных оборудования"**
3. Скопировать код из `backend/equipment-db/Code.gs` в проект

### 2.2. Функции для реализации

#### 2.2.1. doGet() - обработка GET запросов
- `?action=getAll` - получить все оборудование
- `?action=getById&id=XXX` - получить по ID
- `?action=getByType&type=filter` - получить по типу

#### 2.2.2. doPost() - обработка POST запросов
- `action=add` - добавить новое оборудование
- `action=update` - обновить существующее
- `action=delete` - удалить (мягкое удаление)

#### 2.2.3. Вспомогательные функции
- `getAllEquipment()` - чтение всех записей
- `getEquipmentById(id)` - чтение по ID
- `addEquipment(data)` - добавление записи
- `updateEquipment(id, data)` - обновление записи
- `deleteEquipment(id)` - удаление записи
- `generateId()` - генерация UUID

### 2.3. Структура ответов API

**Успешный ответ:**
```json
{
  "success": true,
  "data": { ... }
}
```

**Ошибка:**
```json
{
  "success": false,
  "error": "Описание ошибки"
}
```

---

## Шаг 3: Обновление типов TypeScript

### 3.1. Расширить интерфейс Equipment

**Файл:** `src/types/equipment.ts`

**Изменения:**
- Добавить поля для базы данных
- Добавить типы для статуса и типа оборудования
- Создать интерфейсы для API запросов/ответов

### 3.2. Новые типы

```typescript
export type EquipmentType = 'filter' | 'pump' | 'tank' | 'valve' | 'other';
export type EquipmentStatus = 'active' | 'inactive' | 'archived';

export interface Equipment {
  id: string;
  name: string;
  type: EquipmentType;
  specs: EquipmentSpecs;
  googleDriveUrl: string;
  qrCodeUrl: string;
  commissioningDate?: string;
  lastMaintenanceDate?: string;
  status: EquipmentStatus;
  createdAt: string;
  updatedAt: string;
}

export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
}
```

---

## Шаг 4: Создание сервиса для работы с API

### 4.1. Создать файл сервиса

**Файл:** `src/services/equipmentApi.ts`

**Функции:**
- `getAllEquipment()` - получить все оборудование
- `getEquipmentById(id)` - получить по ID
- `getEquipmentByType(type)` - получить по типу
- `addEquipment(equipment)` - добавить оборудование
- `updateEquipment(id, equipment)` - обновить оборудование
- `deleteEquipment(id)` - удалить оборудование

### 4.2. Обработка ошибок

- Try-catch блоки
- Валидация данных
- Логирование ошибок

---

## Шаг 5: Обновление компонентов

### 5.1. Обновить App.tsx

**Изменения:**
- Заменить localStorage на вызовы API
- Добавить загрузку списка оборудования
- Добавить состояние загрузки и ошибок

### 5.2. Создать компонент EquipmentList

**Файл:** `src/components/EquipmentList.tsx`

**Функциональность:**
- Отображение списка оборудования
- Поиск по названию
- Фильтрация по типу и статусу
- Переход к редактированию

### 5.3. Обновить EquipmentPlate

**Изменения:**
- Принимать объект Equipment вместо отдельных пропсов
- Использовать данные из базы
- Динамический QR-код на основе данных

---

## Шаг 6: Миграция существующих данных

### 6.1. Скрипт миграции

**Создать:** `src/utils/migrateData.ts`

**Функциональность:**
- Чтение данных из localStorage
- Конвертация в формат Equipment
- Отправка в Google Sheets через API

### 6.2. Процесс миграции

1. Проверить наличие данных в localStorage
2. Если есть - предложить миграцию
3. Конвертировать данные
4. Отправить в базу данных
5. Очистить localStorage после успешной миграции

---

## Шаг 7: Тестирование

### 7.1. Тестовые сценарии

1. **Создание записи:**
   - Добавить новое оборудование
   - Проверить появление в таблице
   - Проверить корректность данных

2. **Чтение данных:**
   - Загрузить список оборудования
   - Проверить отображение
   - Проверить фильтрацию

3. **Обновление:**
   - Изменить данные оборудования
   - Проверить обновление в таблице

4. **Удаление:**
   - Удалить оборудование
   - Проверить изменение статуса

### 7.2. Проверка ошибок

- Неверный формат данных
- Отсутствие интернета
- Ошибки API
- Валидация полей

---

## Пошаговая инструкция реализации

### День 1: Настройка Google Sheets и Apps Script

1. ✅ Создать таблицу "База данных оборудования"
2. ✅ Настроить структуру (заголовки, форматы)
3. ✅ Создать проект Google Apps Script
4. ✅ Реализовать базовые функции (getAll, getById)

### День 2: Реализация API

1. ✅ Реализовать doGet() и doPost()
2. ✅ Добавить функции CRUD
3. ✅ Настроить обработку ошибок
4. ✅ Опубликовать как веб-приложение
5. ✅ Протестировать API

### День 3: Интеграция с React

1. ✅ Обновить типы TypeScript
2. ✅ Создать сервис equipmentApi.ts
3. ✅ Обновить App.tsx для работы с API
4. ✅ Протестировать загрузку данных

### День 4: Компоненты и UI

1. ✅ Создать EquipmentList компонент
2. ✅ Обновить EquipmentPlate
3. ✅ Добавить поиск и фильтрацию
4. ✅ Улучшить UI

### День 5: Миграция и финализация

1. ✅ Создать скрипт миграции
2. ✅ Мигрировать существующие данные
3. ✅ Финальное тестирование
4. ✅ Документация

---

## Технические детали

### URL веб-приложения Google Apps Script

После публикации получите URL вида:
```
https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
```

Этот URL нужно будет добавить в конфигурацию приложения.

### Конфигурация

**Создать файл:** `src/config/api.ts`

```typescript
export const API_CONFIG = {
  // URL веб-приложения Google Apps Script для базы данных оборудования
  EQUIPMENT_API_URL: 'YOUR_EQUIPMENT_SCRIPT_URL_HERE',
  
  // URL веб-приложения для журнала обслуживания (существующий)
  MAINTENANCE_API_URL: 'YOUR_MAINTENANCE_SCRIPT_URL_HERE',
  
  TIMEOUT: 10000 // 10 секунд
};
```

**Важно:** После развертывания Google Apps Script скопируйте URL веб-приложения в этот файл.

### Обработка CORS

Google Apps Script автоматически обрабатывает CORS, но нужно убедиться, что:
- Доступ настроен как "Все"
- Правильные заголовки в ответах

---

## Риски и решения

### Риск 1: Лимиты Google Apps Script
**Решение:** Кэширование данных, батчинг запросов

### Риск 2: Производительность при большом количестве записей
**Решение:** Пагинация, фильтрация на стороне сервера

### Риск 3: Потеря данных
**Решение:** Регулярное резервное копирование, валидация перед записью

---

## Критерии готовности Фазы 1

- ✅ Таблица Google Sheets создана и настроена
- ✅ Google Apps Script API работает
- ✅ Все CRUD операции реализованы
- ✅ React приложение интегрировано с API
- ✅ Существующие данные мигрированы
- ✅ Тестирование пройдено
- ✅ Документация обновлена

---

## Следующие шаги после Фазы 1

После завершения Фазы 1 можно переходить к:
- Фазе 2: Административная панель для управления оборудованием
- Фазе 3: Интеграция с Google Drive API
- Фазе 4: Генерация QR-кодов

---

## Вопросы для уточнения

1. Где будет храниться URL Google Apps Script? (конфиг файл, переменные окружения)
2. Нужна ли валидация данных на стороне Google Apps Script?
3. Какой формат дат использовать? (ISO 8601, локальный формат)
4. Нужна ли пагинация сразу или можно без неё на начальном этапе?

