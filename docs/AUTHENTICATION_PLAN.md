# План реализации системы аутентификации и авторизации

## Обзор

Реализация системы регистрации и аутентификации с двумя уровнями доступа:
- **Администратор** (email привязан к Google Drive) - полный доступ ко всему приложению
- **Обычный пользователь** - доступ только к журналу обслуживания (заполнение) и документации (чтение)

---

## Этап 1: Проектирование и подготовка инфраструктуры

### 1.1. Определение структуры данных пользователя

**Файлы для создания:**
- `src/types/user.ts` - типы для пользователей и ролей
- `src/types/auth.ts` - типы для аутентификации

**Структура данных:**
```typescript
// Роли пользователей
type UserRole = 'admin' | 'user';

// Интерфейс пользователя
interface User {
  id: string;
  email: string;
  name?: string;
  role: UserRole;
  createdAt: string;
  lastLoginAt?: string;
}

// Сессия пользователя
interface UserSession {
  user: User;
  token: string;
  expiresAt: string;
}
```

### 1.2. Настройка Google Apps Script для аутентификации

**Файлы для модификации:**
- `backend/equipment-db/Code.gs` - добавить функции для работы с пользователями

**Новые функции в Code.gs:**
- `registerUser(email, name)` - регистрация нового пользователя
- `loginUser(email)` - вход пользователя (с записью в историю)
- `logoutUser(email)` - выход пользователя
- `checkUserRole(email)` - проверка роли пользователя
- `verifyAdminAccess(email)` - проверка доступа администратора (Google Drive + резервный список)
- `getUserByEmail(email)` - получение данных пользователя
- `checkSessionTimeout(email)` - проверка таймаута сессии (1 час бездействия)
- `updateLastActivity(email)` - обновление времени последней активности
- `addLoginHistory(email, success)` - добавление записи в историю входов
- `getLoginHistory(email, limit)` - получение истории входов пользователя
- `addAdminManually(email)` - ручное добавление администратора
- `removeAdminManually(email)` - удаление администратора
- `getAllAdmins()` - получение списка всех администраторов

**Новая таблица в Google Sheets:**
- Лист "Пользователи" с колонками:
  - ID (UUID)
  - Email (уникальный)
  - Имя
  - Роль (admin/user)
  - Дата создания
  - Последний вход
  - Дата последней активности (для проверки таймаута)

**Новая таблица для истории входов:**
- Лист "История входов" с колонками:
  - ID записи (UUID)
  - Email пользователя
  - Дата и время входа
  - IP адрес (опционально, если будет доступен)
  - Успешный/Неуспешный вход

### 1.3. Создание API endpoints для аутентификации

**Файлы для создания:**
- `src/services/api/authApi.ts` - API функции для аутентификации

**Endpoints:**
- `POST /register` - регистрация
- `POST /login` - вход (с записью в историю)
- `POST /logout` - выход
- `GET /me` - получение текущего пользователя (с проверкой таймаута)
- `GET /verify-admin` - проверка прав администратора
- `GET /login-history` - получение истории входов (для администраторов)
- `POST /check-session` - проверка активности сессии

---

## Этап 2: Реализация бэкенда (Google Apps Script)

### 2.1. Создание таблицы пользователей

**Задачи:**
1. Добавить функцию `getUsersSheet()` для получения/создания листа "Пользователи"
2. Настроить заголовки таблицы
3. Реализовать валидацию email

### 2.2. Реализация регистрации

**Функция `registerUser(email, name)`:**
- Проверка уникальности email
- Создание записи пользователя с ролью 'user' по умолчанию
- Генерация UUID для ID
- Возврат данных пользователя

### 2.3. Реализация проверки прав администратора

**Функция `verifyAdminAccess(email)`:**
- **Уровень 1:** Проверка через Google Drive API (получение владельцев папки)
- **Уровень 2:** Проверка по резервному списку в листе "Администраторы"
- Если email найден хотя бы в одном источнике - возврат роли 'admin'
- Если не найден - возврат роли 'user'
- Обновление роли пользователя в таблице

**Структура листа "Администраторы":**
- Email (уникальный)
- Дата добавления
- Добавлен вручную (true/false)
- Приоритет (основной/резервный)
- Примечание

**Функции управления администраторами:**
- `addAdminManually(email)` - добавление в резервный список
- `removeAdminManually(email)` - удаление из резервного списка
- `getAllAdmins()` - получение всех администраторов (из обоих источников)

### 2.4. Реализация входа

**Функция `loginUser(email)`:**
- Проверка существования пользователя
- Автоматическая проверка прав администратора
- Обновление даты последнего входа
- Обновление времени последней активности (текущее время)
- Запись в историю входов (успешный вход)
- Генерация токена сессии (для отслеживания активности)
- Возврат данных пользователя с ролью и временем сессии

**Функция `checkSessionTimeout(email)`:**
- Получение времени последней активности пользователя
- Проверка, прошло ли более 1 часа (3600 секунд)
- Если прошло - возврат false (сессия истекла)
- Если не прошло - возврат true (сессия активна)

**Функция `updateLastActivity(email)`:**
- Обновление времени последней активности на текущее время
- Вызывается при каждом запросе к API от авторизованного пользователя

### 2.5. Обработка в doPost и doGet

**Модификация `doPost`:**
- Добавить обработку действий: 
  - `register` - регистрация
  - `login` - вход
  - `logout` - выход
  - `verify-admin` - проверка прав администратора
  - `check-session` - проверка активности сессии
  - `add-admin` - добавление администратора (только для админов)
  - `remove-admin` - удаление администратора (только для админов)
- Валидация входных данных
- Проверка таймаута сессии для защищенных действий
- Обработка ошибок

**Модификация `doGet`:**
- Добавить обработку действий:
  - `getCurrentUser` - получение текущего пользователя (с проверкой таймаута)
  - `getLoginHistory` - получение истории входов
  - `getAllAdmins` - получение списка администраторов (только для админов)
- Проверка таймаута сессии перед возвратом данных
- Автоматическое обновление времени активности при успешном запросе

---

## Этап 3: Реализация фронтенда - инфраструктура

### 3.1. Создание контекста аутентификации

**Файлы для создания:**
- `src/contexts/AuthContext.tsx` - контекст для управления состоянием аутентификации
- `src/providers/AuthProvider.tsx` - провайдер для обертки приложения

**Функциональность:**
- Хранение текущего пользователя
- Хранение времени последней активности
- Функции: `login`, `logout`, `register`
- Проверка авторизации
- Автоматическая проверка сессии при загрузке
- Автоматическая проверка таймаута (1 час бездействия)
- Периодическая проверка активности (каждые 5-10 минут)
- Обновление времени активности при действиях пользователя (клики, навигация)
- Автоматический выход при истечении таймаута

### 3.2. Создание хуков для аутентификации

**Файлы для создания:**
- `src/hooks/useAuth.ts` - хук для доступа к контексту аутентификации
- `src/hooks/useRequireAuth.ts` - хук для защиты маршрутов
- `src/hooks/useRequireRole.ts` - хук для проверки роли

**Функциональность:**
- `useAuth()` - доступ к текущему пользователю и функциям
- `useRequireAuth()` - редирект на логин, если не авторизован
- `useRequireRole(role)` - редирект, если нет нужной роли

### 3.3. Создание утилит для работы с сессией

**Файлы для создания:**
- `src/utils/sessionStorage.ts` - работа с sessionStorage для хранения сессии
- `src/utils/authHelpers.ts` - вспомогательные функции
- `src/utils/sessionTimeout.ts` - управление таймаутом сессии

**Функциональность:**
- Сохранение/загрузка сессии из sessionStorage
- Сохранение времени последней активности
- Проверка истечения сессии (1 час бездействия)
- Автоматическая проверка активности при каждом действии пользователя
- Очистка сессии при истечении таймаута
- Периодическая проверка таймаута (через setInterval или при событиях)

---

## Этап 4: Реализация UI компонентов

### 4.1. Страница входа (Login)

**Файлы для создания:**
- `src/pages/LoginPage.tsx` - страница входа
- `src/pages/LoginPage.css` - стили

**Функциональность:**
- Форма с полями: Email
- Кнопка "Войти"
- Ссылка на регистрацию
- Обработка ошибок
- Валидация email

### 4.2. Страница регистрации (Register)

**Файлы для создания:**
- `src/pages/RegisterPage.tsx` - страница регистрации
- `src/pages/RegisterPage.css` - стили

**Функциональность:**
- Форма с полями: Email, Имя (опционально)
- Кнопка "Зарегистрироваться"
- Ссылка на вход
- Обработка ошибок
- Валидация email

### 4.3. Компонент навигации с информацией о пользователе

**Файлы для модификации:**
- `src/App.tsx` - добавить информацию о пользователе в header
- `src/components/UserMenu.tsx` - компонент меню пользователя (новый)
- `src/components/UserMenu.css` - стили (новый)

**Функциональность:**
- Отображение email пользователя
- Отображение роли (Администратор/Пользователь)
- Индикатор времени до истечения сессии (опционально)
- Кнопка "Выйти"
- Выпадающее меню (опционально)
- Для администраторов: ссылка на управление администраторами (если нужно)

### 4.4. Страница истории входов (для администраторов)

**Файлы для создания:**
- `src/pages/LoginHistoryPage.tsx` - страница истории входов
- `src/pages/LoginHistoryPage.css` - стили

**Функциональность:**
- Таблица с историей входов
- Фильтрация по email пользователя
- Фильтрация по дате
- Показ успешных/неуспешных входов
- Пагинация (если записей много)
- Доступ только для администраторов

---

## Этап 5: Защита маршрутов

### 5.1. Создание защищенных компонентов маршрутов

**Файлы для создания:**
- `src/components/ProtectedRoute.tsx` - компонент для защиты маршрутов
- `src/components/RoleProtectedRoute.tsx` - компонент для защиты по ролям

**Функциональность:**
- `ProtectedRoute` - редирект на логин, если не авторизован
- `RoleProtectedRoute` - редирект, если нет нужной роли

### 5.2. Модификация маршрутизации

**Файлы для модификации:**
- `src/App.tsx` - обернуть маршруты в защиту
- `src/utils/routes.ts` - добавить новые маршруты

**Новые маршруты:**
- `/login` - страница входа
- `/register` - страница регистрации

**Защита маршрутов:**
- `/` (HomePage) - только для администраторов
- `/equipment/new` - только для администраторов
- `/equipment/:id/edit` - только для администраторов
- `/equipment/:id` - для всех авторизованных (но с разными правами)
- `/login` - только для неавторизованных
- `/register` - только для неавторизованных

### 5.3. Логика доступа к функциям

**Модификация компонентов:**

**HomePage:**
- Показывать только администраторам
- Обычные пользователи не видят список оборудования

**EquipmentPage:**
- Для администраторов: полный доступ (редактирование, удаление, все кнопки)
- Для обычных пользователей: только просмотр документации и журнал обслуживания
- Скрыть кнопки: "Редактировать", "Удалить", "Экспорт в PDF"
- Показать только: "Журнал обслуживания", "Документация"

**EquipmentFormPage:**
- Доступ только для администраторов
- Редирект на главную, если нет прав

**EquipmentSidebar:**
- Условное отображение кнопок в зависимости от роли
- Скрыть секцию "Действия" для обычных пользователей

---

## Этап 6: Интеграция с Google Drive для проверки прав

### 6.1. Настройка проверки владельцев Google Drive

**Файлы для модификации:**
- `backend/equipment-db/Code.gs` - функция `verifyAdminAccess`

**Логика:**
1. Получить ID корневой папки Google Drive (из конфигурации)
2. Получить список владельцев папки через Drive API
3. Проверить, есть ли email пользователя в списке владельцев
4. Если есть - вернуть роль 'admin', иначе 'user'
5. Обновить роль в таблице пользователей

**Альтернативный подход:**
- Создать лист "Администраторы" с email адресами
- Проверять email пользователя против этого списка

### 6.2. Автоматическая проверка при входе

**Модификация:**
- При каждом входе автоматически проверять права администратора
- Обновлять роль пользователя, если она изменилась

---

## Этап 7: Ограничение доступа к API

### 7.1. Проверка прав в бэкенде

**Модификация функций в Code.gs:**

**Только для администраторов:**
- `addEquipment` - создание оборудования
- `updateEquipment` - обновление оборудования
- `deleteEquipment` - удаление оборудования
- `getAllEquipment` - получение списка всего оборудования

**Для всех авторизованных:**
- `getEquipmentById` - просмотр оборудования
- `getMaintenanceLog` - просмотр журнала обслуживания
- `addMaintenanceEntry` - добавление записи в журнал
- `updateMaintenanceEntry` - обновление записи (только для администраторов?)
- `deleteMaintenanceEntry` - удаление записи (только для администраторов?)
- `getDriveFiles` - просмотр документации

**Логика проверки:**
- Добавить функцию `checkPermission(action, userEmail)`
- Проверять права перед выполнением действия
- Возвращать ошибку, если нет прав

### 7.2. Передача информации о пользователе в API

**Модификация:**
- Добавить передачу email пользователя в каждом запросе
- Или использовать токен сессии (если будет реализован)

---

## Этап 8: Улучшение UX

### 8.1. Обработка состояний загрузки

**Задачи:**
- Показывать индикатор загрузки при проверке авторизации
- Обрабатывать ошибки аутентификации
- Показывать понятные сообщения об ошибках

### 8.2. Автоматический редирект

**Логика:**
- После входа редирект на страницу, с которой пришел пользователь
- После выхода редирект на страницу входа
- При попытке доступа к защищенной странице - сохранение URL для редиректа после входа

### 8.3. Сообщения для пользователей

**Задачи:**
- Показывать сообщение, если пользователь пытается получить доступ к недоступной функции
- Информативные сообщения о правах доступа
- Уведомление о приближающемся истечении сессии (за 5-10 минут до таймаута)
- Модальное окно при истечении сессии с предложением войти заново
- Информация о времени последней активности (опционально)

---

## Этап 9: Тестирование и отладка

### 9.1. Тестирование сценариев

**Сценарии для тестирования:**
1. Регистрация нового пользователя
2. Вход администратора (email в Google Drive)
3. Вход обычного пользователя
4. Попытка доступа к защищенным маршрутам
5. Проверка ограничений функционала
6. Проверка обновления роли при изменении прав в Google Drive
7. Проверка таймаута сессии (1 час бездействия)
8. Проверка обновления времени активности при действиях
9. Проверка истории входов
10. Ручное добавление/удаление администратора
11. Восстановление доступа администратора через резервный список
12. Выход из системы
13. Повторный вход после истечения сессии

### 9.2. Обработка edge cases

**Проверка:**
- Дублирование email при регистрации
- Неверный email при входе
- Истечение сессии
- Потеря соединения с сервером
- Ошибки API

---

## Этап 10: Документация и финализация

### 10.1. Документация

**Создать:**
- `docs/AUTHENTICATION.md` - описание системы аутентификации
- Обновить `README.md` с информацией о входе
- Инструкции для администраторов

### 10.2. Настройка для продакшена

**Задачи:**
- Настройка переменных окружения (если нужно)
- Конфигурация Google Apps Script
- Настройка списка администраторов

---

## Порядок реализации (рекомендуемый)

1. **Этап 1** - Проектирование и подготовка инфраструктуры
2. **Этап 2** - Реализация бэкенда (Google Apps Script)
3. **Этап 3** - Реализация фронтенда - инфраструктура
4. **Этап 4** - Реализация UI компонентов
5. **Этап 5** - Защита маршрутов
6. **Этап 6** - Интеграция с Google Drive
7. **Этап 7** - Ограничение доступа к API
8. **Этап 8** - Улучшение UX
9. **Этап 9** - Тестирование
10. **Этап 10** - Документация

---

## Дополнительные соображения

### Безопасность

- Хранение сессий (sessionStorage vs localStorage)
- Защита от CSRF атак
- Валидация на стороне сервера
- Ограничение попыток входа

### Масштабируемость

- Возможность добавления новых ролей в будущем
- Гибкая система прав доступа
- Кэширование информации о пользователе

### Производительность

- Минимизация запросов к Google Apps Script
- Кэширование проверки прав администратора
- Оптимизация загрузки данных

---

## Уточненные требования

### Аутентификация
- **Пока достаточно email** - без пароля (упрощенная система для начала)
- **Таймаут сессии: 1 час** - если пользователь бездействует 1 час, требуется повторный вход
- **Смена пароля** - будет реализована в будущем (когда будет добавлена система паролей)
- **История входов** - необходима, сохранять дату и время каждого входа

### Обработка потери доступа администратора к Google Drive

**Решение: Система резервных администраторов и ручное управление**

1. **Резервный список администраторов:**
   - Создать лист "Администраторы" в Google Sheets с колонками:
     - Email
     - Дата добавления
     - Добавлен вручную (true/false)
     - Приоритет (основной/резервный)
   
2. **Двухуровневая проверка прав:**
   - **Уровень 1:** Проверка через Google Drive API (владельцы папки)
   - **Уровень 2:** Проверка по списку в листе "Администраторы"
   - Если пользователь есть хотя бы в одном из источников - он администратор
   
3. **Ручное управление администраторами:**
   - Функция `addAdminManually(email)` - добавление администратора вручную
   - Функция `removeAdminManually(email)` - удаление администратора
   - Функция `getAllAdmins()` - получение списка всех администраторов
   - Доступ к этим функциям только для существующих администраторов
   
4. **Автоматическое уведомление:**
   - При потере доступа к Google Drive (проверка не прошла) - сохранить в лог
   - Администратор может быть добавлен вручную другим администратором
   
5. **Восстановление доступа:**
   - Если администратор был удален из Google Drive, но есть в резервном списке - доступ сохраняется
   - Если администратор восстановил доступ к Google Drive - автоматически получает права обратно
   
6. **Аварийный доступ:**
   - Создать специальную функцию `emergencyAddAdmin(email)` с дополнительной проверкой
   - Или использовать переменную в скрипте с email суперадминистратора (для экстренных случаев)

**Альтернативное решение (более простое):**
- Использовать только список в Google Sheets "Администраторы"
- Администраторы добавляются вручную в этот список
- Проверка Google Drive используется только как дополнительная информация, но не как основной источник прав
- Это упрощает управление и делает систему более предсказуемой

