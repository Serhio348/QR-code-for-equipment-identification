# Расчет объема данных для 20 счетчиков

## Параметры системы

- **Количество устройств**: 20 шт.
- **Частота сбора**: Каждый час (GitHub Actions cron: `50 * * * *`)
- **Период сбора**: Последние 24 часа
- **Тип данных**: Почасовые показания (`reading_type = 'hourly'`)

## Структура записи в таблице `beliot_device_readings`

```sql
CREATE TABLE public.beliot_device_readings (
  id UUID,                    -- 16 байт
  device_id TEXT,             -- ~10-20 байт (например, "11013")
  reading_date TIMESTAMPTZ,   -- 8 байт
  reading_value NUMERIC(12,3), -- ~8 байт
  unit TEXT,                  -- ~4 байт ("м³")
  reading_type TEXT,          -- ~8 байт ("hourly")
  source TEXT,                -- ~4 байт ("api")
  period TEXT,                -- ~8 байт ("current")
  created_at TIMESTAMPTZ,     -- 8 байт
  updated_at TIMESTAMPTZ,     -- 8 байт
  -- Overhead PostgreSQL: ~24 байт на строку
);
```

### Детальный расчет размера одной записи

| Поле | Тип | Размер (байт) | Примечание |
|------|-----|---------------|------------|
| `id` | UUID | 16 | Фиксированный размер |
| `device_id` | TEXT | 10-20 | Зависит от длины ID (в среднем ~15) |
| `reading_date` | TIMESTAMPTZ | 8 | Фиксированный размер |
| `reading_value` | NUMERIC(12,3) | ~8 | Фиксированный размер |
| `unit` | TEXT | ~4 | "м³" (3 байта + overhead) |
| `reading_type` | TEXT | ~8 | "hourly" (6 байт + overhead) |
| `source` | TEXT | ~4 | "api" (3 байта + overhead) |
| `period` | TEXT | ~8 | "current" (7 байт + overhead) |
| `created_at` | TIMESTAMPTZ | 8 | Фиксированный размер |
| `updated_at` | TIMESTAMPTZ | 8 | Фиксированный размер |
| **Overhead PostgreSQL** | - | ~24 | Заголовок строки, выравнивание |
| **ИТОГО на запись** | - | **~110-120 байт** | Среднее: ~115 байт |

## Расчет объема данных

### Ежедневный объем

- **20 устройств** × **24 показания/день** = **480 записей/день**
- **480 записей** × **115 байт** = **55,200 байт/день** = **~54 КБ/день**

### Ежемесячный объем

- **480 записей/день** × **30 дней** = **14,400 записей/месяц**
- **14,400 записей** × **115 байт** = **1,656,000 байт/месяц** = **~1.58 МБ/месяц**

### Годовой объем

- **480 записей/день** × **365 дней** = **175,200 записей/год**
- **175,200 записей** × **115 байт** = **20,148,000 байт/год** = **~19.2 МБ/год**

## Учет индексов

PostgreSQL создает индексы для оптимизации запросов. Обычно индексы добавляют **20-30%** к размеру таблицы.

### Индексы в таблице `beliot_device_readings`:

1. **idx_beliot_readings_device_date** (device_id, reading_date DESC)
   - Размер: ~(15 + 8) × 175,200 = ~4 МБ

2. **idx_beliot_readings_date** (reading_date DESC)
   - Размер: ~8 × 175,200 = ~1.4 МБ

3. **idx_beliot_readings_device_type** (device_id, reading_type)
   - Размер: ~(15 + 8) × 175,200 = ~4 МБ

**Общий размер индексов**: ~9.4 МБ/год

## Итоговый расчет

| Компонент | Размер за год |
|-----------|---------------|
| Данные таблицы | ~19.2 МБ |
| Индексы | ~9.4 МБ |
| **ИТОГО** | **~28.6 МБ/год** |

## Прогноз на несколько лет

| Период | Количество записей | Размер данных | Размер с индексами |
|--------|-------------------|---------------|-------------------|
| 1 месяц | 14,400 | ~1.58 МБ | ~2.0 МБ |
| 3 месяца | 43,200 | ~4.7 МБ | ~6.0 МБ |
| 6 месяцев | 86,400 | ~9.5 МБ | ~12.0 МБ |
| 1 год | 175,200 | ~19.2 МБ | ~28.6 МБ |
| 2 года | 350,400 | ~38.4 МБ | ~57.2 МБ |
| 3 года | 525,600 | ~57.6 МБ | ~85.8 МБ |

## Выводы и рекомендации

### ✅ Для 20 устройств объем данных очень небольшой:

- **За год**: ~28.6 МБ (с индексами)
- **За 3 года**: ~85.8 МБ (с индексами)

### Рекомендации:

1. **Архивация не критична** для такого объема данных
   - Даже за 5 лет будет всего ~143 МБ
   - Supabase Free tier предоставляет 500 МБ базы данных

2. **Можно хранить данные без архивации** до 10-15 лет
   - При текущем объеме это будет ~286-429 МБ

3. **Архивация имеет смысл** только если:
   - Планируется увеличение количества устройств
   - Нужна оптимизация производительности запросов
   - Требуется соответствие политикам хранения данных

4. **Рекомендуемый период хранения без архивации**: **5-10 лет**
   - Это даст ~143-286 МБ данных
   - Остается запас для других таблиц в базе

### Оптимизация (опционально):

Если все же решите использовать архивацию для оптимизации:

- **Период хранения активных данных**: 12-24 месяца
- **Частота архивации**: Раз в полгода или раз в год
- **Архивные данные**: Агрегировать в дневные значения (уменьшение в 24 раза)

## Сравнение с другими системами

| Количество устройств | Данные за год (с индексами) |
|---------------------|----------------------------|
| 10 устройств | ~14.3 МБ |
| **20 устройств** | **~28.6 МБ** |
| 50 устройств | ~71.5 МБ |
| 100 устройств | ~143 МБ |
| 500 устройств | ~715 МБ |

## Заключение

Для системы с **20 счетчиками** объем данных за год составляет всего **~28.6 МБ** (с учетом индексов). Это очень небольшой объем, и архивация данных не является критически необходимой. Можно безопасно хранить данные за 5-10 лет без каких-либо проблем с местом в базе данных.
