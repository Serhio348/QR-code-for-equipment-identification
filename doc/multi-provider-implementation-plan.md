# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Multi-Provider –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–ª—è AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞

> **–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â—É—é –Ω–µ—Å–∫–æ–ª—å–∫–æ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (Claude, Gemini, OpenAI, Ollama) —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

**–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–π Claude!** –ù–µ –Ω—É–∂–Ω–æ –≤—Å—ë –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å —Å –Ω—É–ª—è.

### –ß—Ç–æ –¥–µ–ª–∞–µ–º:
1. ‚úÖ **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–º** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `anthropic.ts` ‚Üí –∫–ª–∞—Å—Å `ClaudeProvider` (1-2 —á–∞—Å–∞)
2. ‚úÖ **–î–æ–±–∞–≤–ª—è–µ–º** Gemini –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (2-3 —á–∞—Å–∞)
3. ‚úÖ **–°–æ–∑–¥–∞—ë–º** —Ñ–∞–±—Ä–∏–∫—É –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ (30 –º–∏–Ω—É—Ç)
4. ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º** –∏ –¥–µ–ø–ª–æ–∏–º –Ω–∞ Railway (1 —á–∞—Å)

**–ò—Ç–æ–≥–æ:** 4-6 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã, 90% –∫–æ–¥–∞ —É–∂–µ –≥–æ—Ç–æ–≤!

### –° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å:
üëâ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ —Ä–∞–∑–¥–µ–ª—É ["–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞ Claude"](#–º–∏–≥—Ä–∞—Ü–∏—è-—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ-–∫–æ–¥–∞-claude)

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
2. [–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞ Claude](#–º–∏–≥—Ä–∞—Ü–∏—è-—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ-–∫–æ–¥–∞-claude) ‚≠ê **–ù–ê–ß–ù–ò–¢–ï –ó–î–ï–°–¨**
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ñ–∞–π–ª–æ–≤)
4. [–ü–æ—à–∞–≥–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](#–ø–æ—à–∞–≥–æ–≤–∞—è-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
5. [–ê–¥–∞–ø—Ç–∞—Ü–∏—è Tool Calling](#–∞–¥–∞–ø—Ç–∞—Ü–∏—è-tool-calling)
6. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-–∏-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
7. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
8. [–î–µ–ø–ª–æ–π –Ω–∞ Railway](#–¥–µ–ø–ª–æ–π-–Ω–∞-railway)
9. [–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)

---

## üèóÔ∏è –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Ç–æ–ª—å–∫–æ Claude)

```
chat.ts ‚Üí anthropic.ts ‚Üí Claude API
                ‚Üì
            tools/index.ts
```

### –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Multi-Provider)

```
chat.ts ‚Üí ProviderFactory ‚Üí AIProvider (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
                               ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚Üì                ‚Üì                ‚Üì
         ClaudeProvider   GeminiProvider   OpenAIProvider
              ‚Üì                ‚Üì                ‚Üì
         Claude API       Gemini API       OpenAI API
              ‚Üì                ‚Üì                ‚Üì
                    tools/index.ts
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **AIProvider (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)** - –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
2. **–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã** - –∞–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ AI —Å–µ—Ä–≤–∏—Å–∞
3. **ProviderFactory** - —Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
4. **Tool Adapters** - –∞–¥–∞–ø—Ç–∞—Ü–∏—è tool calling –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

---

## ‚≠ê –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞ Claude

> **–í–ê–ñ–ù–û:** –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Claude –≤ —Ñ–∞–π–ª–µ `ai-consultant-api/src/services/anthropic.ts`. –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –µ–≥–æ —Å –Ω—É–ª—è - –ø—Ä–æ—Å—Ç–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–º –ø–æ–¥ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É!

### –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å (–Ω–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ):

‚úÖ **–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Claude API** –≤ `anthropic.ts`
‚úÖ **–ê–≥–µ–Ω—Ç–Ω—ã–π —Ü–∏–∫–ª (agentic loop)** —Å tool calling
‚úÖ **–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç** —Å —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º
‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞** (—Ç–µ–∫—Å—Ç + —Ñ–æ—Ç–æ)
‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–∞—à–∏–º–∏ tools** —á–µ—Ä–µ–∑ `executeToolCall`

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `AIProvider` (–Ω–æ–≤—ã–π)
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–µ—Ä `claudeToolAdapter.ts` (–Ω–æ–≤—ã–π, –Ω–æ –ª–æ–≥–∏–∫–∞ —É–∂–µ –µ—Å—Ç—å –≤ `anthropic.ts`)
3. ‚úÖ **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å** `anthropic.ts` ‚Üí `ClaudeProvider.ts` (90% –∫–æ–¥–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å)
4. ‚úÖ –°–æ–∑–¥–∞—Ç—å `GeminiProvider.ts` (–Ω–æ–≤—ã–π)
5. ‚úÖ –°–æ–∑–¥–∞—Ç—å `OpenAIProvider.ts` (–Ω–æ–≤—ã–π, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
6. ‚úÖ –°–æ–∑–¥–∞—Ç—å `ProviderFactory.ts` (–Ω–æ–≤—ã–π)
7. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `chat.ts` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∞–±—Ä–∏–∫–∏

### –ë—ã—Å—Ç—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –≤ 3 —à–∞–≥–∞:

#### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (5 –º–∏–Ω—É—Ç)

```bash
cd ai-consultant-api/src/services
mkdir ai
cd ai
mkdir providers adapters
```

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª—ã:
- `types.ts` - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã –∏–∑ `anthropic.ts`
- `AIProvider.ts` - –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

#### –®–∞–≥ 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ Claude (10 –º–∏–Ω—É—Ç)

**–ë—ã–ª–æ:** `anthropic.ts` (370 —Å—Ç—Ä–æ–∫)
**–°—Ç–∞–Ω–µ—Ç:** `providers/ClaudeProvider.ts` + `adapters/claudeToolAdapter.ts`

**–ß—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è:**
1. –û–±–µ—Ä–Ω—É—Ç—å –∫–æ–¥ –≤ –∫–ª–∞—Å—Å `ClaudeProvider implements AIProvider`
2. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `processChatMessage()` ‚Üí `chat()`
3. –í—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ tools –≤ –∞–¥–∞–ø—Ç–µ—Ä
4. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `isAvailable()`

**–ß—Ç–æ –ù–ï –º–µ–Ω—è–µ—Ç—Å—è:**
- ‚úÖ –ê–≥–µ–Ω—Ç–Ω—ã–π —Ü–∏–∫–ª –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
- ‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
- ‚úÖ Tool calling –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å

**–ü—Ä–∏–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π:**

```typescript
// –ë–´–õ–û –≤ anthropic.ts:
export async function processChatMessage(request: ChatRequest): Promise<ChatResponse> {
  const anthropic = new Anthropic({ apiKey: config.anthropicApiKey });
  // ... 300+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ ...
}

// –°–¢–ê–õ–û –≤ ClaudeProvider.ts:
export class ClaudeProvider extends BaseAIProvider {
  readonly name = 'Claude';
  private client: Anthropic;

  constructor(apiKey: string, model: string) {
    super();
    this.client = new Anthropic({ apiKey });
    this.model = model;
  }

  async chat(messages: ChatMessage[], tools: ToolDefinition[], userId: string): Promise<ChatResponse> {
    // ‚¨áÔ∏è –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–Æ–î–ê –í–°–Æ –õ–û–ì–ò–ö–£ –ò–ó processChatMessage()
    // (90% –∫–æ–¥–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  }
}
```

#### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (15-20 –º–∏–Ω—É—Ç –∫–∞–∂–¥—ã–π)

–°–æ–∑–¥–∞—Ç—å `GeminiProvider.ts` –∏ `OpenAIProvider.ts` –ø–æ –ø—Ä–∏–º–µ—Ä—É –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞.

### –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É Claude

#### 1. –°–æ–∑–¥–∞—Ç—å `adapters/claudeToolAdapter.ts`

–í—ã–Ω–µ—Å—Ç–∏ 3 —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ `anthropic.ts`:

```typescript
// –ò–∑ anthropic.ts —Å—Ç—Ä–æ–∫–∏ 262-264:
const toolUseBlocks = response.content.filter(
  (block): block is Anthropic.ToolUseBlock => block.type === 'tool_use'
);

// –°—Ç–∞–Ω–æ–≤–∏—Ç—Å—è:
export function extractClaudeToolCalls(content: Anthropic.ContentBlock[]) {
  return content
    .filter((block): block is Anthropic.ToolUseBlock => block.type === 'tool_use')
    .map(block => ({
      id: block.id,
      name: block.name,
      input: block.input as Record<string, unknown>,
    }));
}
```

```typescript
// –ò–∑ anthropic.ts —Å—Ç—Ä–æ–∫–∏ 282-296:
toolResults.push({
  type: 'tool_result',
  tool_use_id: toolUse.id,
  content: JSON.stringify(result),
  is_error: isError,
});

// –°—Ç–∞–Ω–æ–≤–∏—Ç—Å—è:
export function formatClaudeToolResults(results) {
  return results.map(({ id, result, isError }) => ({
    type: 'tool_result' as const,
    tool_use_id: id,
    content: JSON.stringify(result),
    is_error: isError,
  }));
}
```

#### 2. –°–æ–∑–¥–∞—Ç—å `providers/ClaudeProvider.ts`

**–®–∞–±–ª–æ–Ω:**

```typescript
import Anthropic from '@anthropic-ai/sdk';
import { BaseAIProvider } from '../AIProvider.js';
import { ChatMessage, ChatResponse, ToolDefinition } from '../types.js';
import {
  extractClaudeToolCalls,
  formatClaudeToolResults,
} from '../adapters/claudeToolAdapter.js';
import { executeToolCall } from '../../../tools/index.js';

export class ClaudeProvider extends BaseAIProvider {
  readonly name = 'Claude';
  private client: Anthropic;
  private model: string;

  constructor(apiKey: string, model: string = 'claude-sonnet-4-20250514') {
    super();
    this.client = new Anthropic({ apiKey });
    this.model = model;
  }

  async chat(
    messages: ChatMessage[],
    tools: ToolDefinition[],
    userId: string
  ): Promise<ChatResponse> {
    // ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–Æ–î–ê –ö–û–î –ò–ó processChatMessage() ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
    // –°—Ç—Ä–æ–∫–∏ 200-346 –∏–∑ anthropic.ts
    // –ó–∞–º–µ–Ω–∏—Ç—å:
    // - config.claudeModel ‚Üí this.model
    // - anthropic.messages.create ‚Üí this.client.messages.create
    // - extractClaudeToolCalls(response.content) –≤–º–µ—Å—Ç–æ filter()
    // - formatClaudeToolResults(toolResults) –≤–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
  }

  async isAvailable(): Promise<boolean> {
    try {
      await this.client.messages.create({
        model: this.model,
        max_tokens: 10,
        messages: [{ role: 'user', content: 'test' }],
      });
      return true;
    } catch {
      return false;
    }
  }

  private getSystemPrompt(): string {
    // ‚¨áÔ∏è –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–ù–°–¢–ê–ù–¢–£ SYSTEM_PROMPT –∏–∑ anthropic.ts (—Å—Ç—Ä–æ–∫–∏ 76-104)
    return `–¢—ã ‚Äî AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...`;
  }
}
```

#### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è `ClaudeProvider` - –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ:

```typescript
// test-claude.ts
import { ClaudeProvider } from './services/ai/providers/ClaudeProvider.js';
import { tools } from './tools/index.js';

const provider = new ClaudeProvider('your-api-key');

const response = await provider.chat(
  [{ role: 'user', content: '–ù–∞–π–¥–∏ –≤—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' }],
  tools,
  'test-user'
);

console.log(response.message);
```

–ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç - –∑–Ω–∞—á–∏—Ç –º–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! ‚úÖ

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–∞–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ –≤–µ—Å—å —Ä–∞–±–æ—á–∏–π –∫–æ–¥** - –Ω–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å —Å –Ω—É–ª—è
‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - 90% –∫–æ–¥–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
‚úÖ **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - —Å–Ω–∞—á–∞–ª–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç–µ Claude, –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—Ç–∞—Ä—ã–π `anthropic.ts` –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ —Ä–∞–±–æ—Ç—ã:

| –ü–æ–¥—Ö–æ–¥ | –í—Ä–µ–º—è | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|--------|-------|-----------|
| **–° –Ω—É–ª—è (–≤—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã)** | 2-3 –¥–Ω—è | üî¥ –í—ã—Å–æ–∫–∞—è |
| **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Claude ‚Üí –¥–æ–±–∞–≤–∏—Ç—å Gemini** | 4-6 —á–∞—Å–æ–≤ | üü° –°—Ä–µ–¥–Ω—è—è |
| **–¢–æ–ª—å–∫–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Claude** | 1-2 —á–∞—Å–∞ | üü¢ –ù–∏–∑–∫–∞—è |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–Ω–∏—Ç–µ —Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ Claude (1-2 —á–∞—Å–∞), –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ, –ø–æ—Ç–æ–º –¥–æ–±–∞–≤—å—Ç–µ Gemini (2-3 —á–∞—Å–∞).

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ `ai-consultant-api/src/`:

```
src/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ ai/                              # –ù–æ–≤–∞—è –ø–∞–ø–∫–∞ –¥–ª—è AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts                     # –û–±—â–∏–µ —Ç–∏–ø—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AIProvider.ts                # –ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ClaudeProvider.ts        # Anthropic Claude
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GeminiProvider.ts        # Google Gemini
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OpenAIProvider.ts        # OpenAI GPT
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OllamaProvider.ts        # Ollama (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ claudeToolAdapter.ts     # –ê–¥–∞–ø—Ç–µ—Ä tools –¥–ª—è Claude
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geminiToolAdapter.ts     # –ê–¥–∞–ø—Ç–µ—Ä tools –¥–ª—è Gemini
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openaiToolAdapter.ts     # –ê–¥–∞–ø—Ç–µ—Ä tools –¥–ª—è OpenAI
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ollamaToolAdapter.ts     # –ê–¥–∞–ø—Ç–µ—Ä tools –¥–ª—è Ollama
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProviderFactory.ts           # –§–∞–±—Ä–∏–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                     # –≠–∫—Å–ø–æ—Ä—Ç
‚îÇ   ‚îú‚îÄ‚îÄ anthropic.ts                     # –°–¢–ê–†–´–ô (—É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏)
‚îÇ   ‚îî‚îÄ‚îÄ gasClient.ts
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ env.ts                           # –û–±–Ω–æ–≤–∏—Ç—å –¥–ª—è multi-provider
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ chat.ts                          # –û–±–Ω–æ–≤–∏—Ç—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∞–±—Ä–∏–∫–∏
‚îî‚îÄ‚îÄ tools/
    ‚îî‚îÄ‚îÄ index.ts                         # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```

---

## üî® –ü–æ—à–∞–≥–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –æ–±—â–∏–µ —Ç–∏–ø—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å AIProvider

**–§–∞–π–ª:** `src/services/ai/types.ts`

```typescript
/**
 * –û–±—â–∏–µ —Ç–∏–ø—ã –¥–ª—è –≤—Å–µ—Ö AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
 */

// –ë–ª–æ–∫ —Ç–µ–∫—Å—Ç–∞ –≤ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
export interface TextContentBlock {
  type: 'text';
  text: string;
}

// –ë–ª–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
export interface ImageContentBlock {
  type: 'image';
  source: {
    type: 'base64';
    media_type: 'image/jpeg' | 'image/png' | 'image/gif' | 'image/webp';
    data: string; // Base64 –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞
  };
}

// –°–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
export interface ChatMessage {
  role: 'user' | 'assistant';
  content: string | Array<TextContentBlock | ImageContentBlock>;
}

// –ó–∞–ø—Ä–æ—Å –∫ AI
export interface ChatRequest {
  messages: ChatMessage[];
  userId: string;
}

// –û—Ç–≤–µ—Ç –æ—Ç AI
export interface ChatResponse {
  message: string;
  toolsUsed?: string[];
  provider?: string; // –ù–æ–≤–æ–µ: –∫–∞–∫–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è
  tokensUsed?: {     // –ù–æ–≤–æ–µ: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
    input: number;
    output: number;
  };
}

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ tool (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
export interface ToolDefinition {
  name: string;
  description: string;
  input_schema: {
    type: 'object';
    properties: Record<string, any>;
    required?: string[];
  };
}

// –í—ã–∑–æ–≤ tool –æ—Ç AI
export interface ToolCall {
  id: string;
  name: string;
  input: Record<string, unknown>;
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è tool
export interface ToolResult {
  id: string;
  result: unknown;
  isError?: boolean;
}
```

**–§–∞–π–ª:** `src/services/ai/AIProvider.ts`

```typescript
import {
  ChatMessage,
  ChatResponse,
  ToolDefinition,
  ToolCall,
  ToolResult,
} from './types.js';

/**
 * –ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.
 *
 * –ö–∞–∂–¥—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä (Claude, Gemini, OpenAI) –¥–æ–ª–∂–µ–Ω —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
 */
export interface AIProvider {
  /**
   * –ò–º—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   */
  readonly name: string;

  /**
   * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–∞—Ç–∞.
   * –†–µ–∞–ª–∏–∑—É–µ—Ç –∞–≥–µ–Ω—Ç–Ω—ã–π —Ü–∏–∫–ª (agentic loop) —Å tool calling.
   *
   * @param messages - –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
   * @param tools - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
   * @param userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
   * @returns –û—Ç–≤–µ—Ç –æ—Ç AI
   */
  chat(
    messages: ChatMessage[],
    tools: ToolDefinition[],
    userId: string
  ): Promise<ChatResponse>;

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
   * (–µ—Å—Ç—å –ª–∏ API –∫–ª—é—á, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ API endpoint)
   */
  isAvailable(): Promise<boolean>;
}

/**
 * –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å –æ–±—â–µ–π –ª–æ–≥–∏–∫–æ–π.
 * –£–ø—Ä–æ—â–∞–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.
 */
export abstract class BaseAIProvider implements AIProvider {
  abstract readonly name: string;

  abstract chat(
    messages: ChatMessage[],
    tools: ToolDefinition[],
    userId: string
  ): Promise<ChatResponse>;

  async isAvailable(): Promise<boolean> {
    try {
      // –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–ª–∞—Å—Å–∞—Ö
      return true;
    } catch {
      return false;
    }
  }

  /**
   * –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –≤ –∞–≥–µ–Ω—Ç–Ω–æ–º —Ü–∏–∫–ª–µ
   */
  protected readonly MAX_ITERATIONS = 10;

  /**
   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏–º–µ–Ω–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
   */
  protected log(message: string, ...args: any[]): void {
    console.log(`[${this.name}]`, message, ...args);
  }

  protected logError(message: string, error: unknown): void {
    console.error(`[${this.name}] ${message}:`, error);
  }
}
```

---

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è Tool Calling

> **–í–∞–∂–Ω–æ:** –ö–∞–∂–¥—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è tool calling. –ê–¥–∞–ø—Ç–µ—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç –Ω–∞—à —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

#### –®–∞–≥ 2.1: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è Claude (Anthropic)

**–§–∞–π–ª:** `src/services/ai/adapters/claudeToolAdapter.ts`

```typescript
import Anthropic from '@anthropic-ai/sdk';
import { ToolDefinition } from '../types.js';

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç tool –≤ —Ñ–æ—Ä–º–∞—Ç Anthropic API.
 *
 * Anthropic –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JSON Schema –Ω–∞–ø—Ä—è–º—É—é –≤ input_schema.
 */
export function convertToClaudeTools(tools: ToolDefinition[]): Anthropic.Tool[] {
  return tools.map(tool => ({
    name: tool.name,
    description: tool.description,
    input_schema: tool.input_schema,
  }));
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç tool calls –∏–∑ –æ—Ç–≤–µ—Ç–∞ Claude
 */
export function extractClaudeToolCalls(
  content: Anthropic.ContentBlock[]
): Array<{ id: string; name: string; input: Record<string, unknown> }> {
  return content
    .filter((block): block is Anthropic.ToolUseBlock => block.type === 'tool_use')
    .map(block => ({
      id: block.id,
      name: block.name,
      input: block.input as Record<string, unknown>,
    }));
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã tool –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ Claude
 */
export function formatClaudeToolResults(
  results: Array<{ id: string; result: unknown; isError?: boolean }>
): Anthropic.ToolResultBlockParam[] {
  return results.map(({ id, result, isError }) => ({
    type: 'tool_result' as const,
    tool_use_id: id,
    content: JSON.stringify(result),
    is_error: isError,
  }));
}
```

#### –®–∞–≥ 2.2: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è Gemini (Google)

**–§–∞–π–ª:** `src/services/ai/adapters/geminiToolAdapter.ts`

```typescript
import { ToolDefinition } from '../types.js';

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç tool –≤ —Ñ–æ—Ä–º–∞—Ç Gemini API.
 *
 * Gemini –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "functionDeclarations" –≤–º–µ—Å—Ç–æ "tools".
 * –§–æ—Ä–º–∞—Ç parameters –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç JSON Schema.
 */
export function convertToGeminiTools(tools: ToolDefinition[]) {
  return tools.map(tool => ({
    name: tool.name,
    description: tool.description,
    parameters: {
      type: 'object',
      properties: tool.input_schema.properties,
      required: tool.input_schema.required || [],
    },
  }));
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç function calls –∏–∑ –æ—Ç–≤–µ—Ç–∞ Gemini
 */
export function extractGeminiFunctionCalls(
  candidates: any[]
): Array<{ id: string; name: string; input: Record<string, unknown> }> {
  const calls: Array<{ id: string; name: string; input: Record<string, unknown> }> = [];

  for (const candidate of candidates) {
    const functionCalls = candidate.content?.parts?.filter(
      (part: any) => part.functionCall
    );

    if (functionCalls) {
      functionCalls.forEach((call: any, index: number) => {
        calls.push({
          id: `call_${Date.now()}_${index}`, // Gemini –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç ID, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
          name: call.functionCall.name,
          input: call.functionCall.args || {},
        });
      });
    }
  }

  return calls;
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã function –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ Gemini
 */
export function formatGeminiFunctionResults(
  results: Array<{ id: string; result: unknown; isError?: boolean }>
) {
  return results.map(({ result, isError }) => ({
    functionResponse: {
      name: 'function_result',
      response: {
        success: !isError,
        data: result,
      },
    },
  }));
}
```

#### –®–∞–≥ 2.3: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è OpenAI (GPT)

**–§–∞–π–ª:** `src/services/ai/adapters/openaiToolAdapter.ts`

```typescript
import { ToolDefinition } from '../types.js';

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç tool –≤ —Ñ–æ—Ä–º–∞—Ç OpenAI API.
 *
 * OpenAI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "functions" –∏ JSON Schema –≤ parameters.
 */
export function convertToOpenAITools(tools: ToolDefinition[]) {
  return tools.map(tool => ({
    type: 'function' as const,
    function: {
      name: tool.name,
      description: tool.description,
      parameters: tool.input_schema,
    },
  }));
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç tool calls –∏–∑ –æ—Ç–≤–µ—Ç–∞ OpenAI
 */
export function extractOpenAIToolCalls(
  message: any
): Array<{ id: string; name: string; input: Record<string, unknown> }> {
  if (!message.tool_calls) {
    return [];
  }

  return message.tool_calls.map((call: any) => ({
    id: call.id,
    name: call.function.name,
    input: JSON.parse(call.function.arguments),
  }));
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã tool –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ OpenAI
 */
export function formatOpenAIToolResults(
  results: Array<{ id: string; result: unknown; isError?: boolean }>
) {
  return results.map(({ id, result }) => ({
    role: 'tool' as const,
    tool_call_id: id,
    content: JSON.stringify(result),
  }));
}
```

---

### –®–∞–≥ 3: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

#### –®–∞–≥ 3.1: ClaudeProvider

> ‚ö†Ô∏è **–í–ê–ñ–ù–û:** –ë–æ–ª—å—à—É—é —á–∞—Å—Ç—å –∫–æ–¥–∞ –¥–ª—è ClaudeProvider –º–æ–∂–Ω–æ **—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞** `anthropic.ts` (—Å—Ç—Ä–æ–∫–∏ 200-370)! –ù–µ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å –Ω—É–ª—è - –ø—Ä–æ—Å—Ç–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥.

**–§–∞–π–ª:** `src/services/ai/providers/ClaudeProvider.ts`

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
1. –°–æ–∑–¥–∞—ë–º –∫–ª–∞—Å—Å `ClaudeProvider`
2. **–ö–æ–ø–∏—Ä—É–µ–º** –≤—Å—é –ª–æ–≥–∏–∫—É –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ `processChatMessage()` –≤ –º–µ—Ç–æ–¥ `chat()`
3. **–ó–∞–º–µ–Ω—è–µ–º** –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
   - `config.claudeModel` ‚Üí `this.model`
   - `anthropic.messages.create` ‚Üí `this.client.messages.create`
4. **–ò—Å–ø–æ–ª—å–∑—É–µ–º** –∞–¥–∞–ø—Ç–µ—Ä—ã –≤–º–µ—Å—Ç–æ inline –∫–æ–¥–∞
5. –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥ `isAvailable()`

```typescript
import Anthropic from '@anthropic-ai/sdk';
import { BaseAIProvider } from '../AIProvider.js';
import { ChatMessage, ChatResponse, ToolDefinition } from '../types.js';
import {
  convertToClaudeTools,
  extractClaudeToolCalls,
  formatClaudeToolResults,
} from '../adapters/claudeToolAdapter.js';
import { executeToolCall } from '../../../tools/index.js';

export class ClaudeProvider extends BaseAIProvider {
  readonly name = 'Claude';
  private client: Anthropic;
  private model: string;

  constructor(apiKey: string, model: string = 'claude-sonnet-4-20250514') {
    super();
    this.client = new Anthropic({ apiKey });
    this.model = model;
  }

  async chat(
    messages: ChatMessage[],
    tools: ToolDefinition[],
    userId: string
  ): Promise<ChatResponse> {
    try {
      const toolsUsed: string[] = [];
      let iteration = 0;

      // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
      const systemPrompt = this.getSystemPrompt();

      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º tools –≤ —Ñ–æ—Ä–º–∞—Ç Claude
      const claudeTools = convertToClaudeTools(tools);

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç Claude
      const claudeMessages: Anthropic.MessageParam[] = messages.map(msg => ({
        role: msg.role,
        content: msg.content,
      }));

      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ Claude
      let response = await this.client.messages.create({
        model: this.model,
        max_tokens: 4096,
        system: systemPrompt,
        tools: claudeTools,
        messages: claudeMessages,
      });

      // –ê–≥–µ–Ω—Ç–Ω—ã–π —Ü–∏–∫–ª (tool calling loop)
      while (response.stop_reason === 'tool_use' && iteration < this.MAX_ITERATIONS) {
        iteration++;

        // –ò–∑–≤–ª–µ–∫–∞–µ–º tool calls
        const toolCalls = extractClaudeToolCalls(response.content);

        // –í—ã–ø–æ–ª–Ω—è–µ–º tools
        const toolResults = [];
        for (const call of toolCalls) {
          this.log(`Executing tool: ${call.name}`);
          toolsUsed.push(call.name);

          try {
            const result = await executeToolCall(call.name, call.input);
            toolResults.push({ id: call.id, result, isError: false });
          } catch (error) {
            const errorMessage = error instanceof Error ? error.message : 'Unknown error';
            toolResults.push({ id: call.id, result: errorMessage, isError: true });
          }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç Claude –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã tools –≤ –∏—Å—Ç–æ—Ä–∏—é
        claudeMessages.push({
          role: 'assistant',
          content: response.content,
        });

        claudeMessages.push({
          role: 'user',
          content: formatClaudeToolResults(toolResults),
        });

        // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        response = await this.client.messages.create({
          model: this.model,
          max_tokens: 4096,
          system: systemPrompt,
          tools: claudeTools,
          messages: claudeMessages,
        });
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
      const textBlock = response.content.find(
        (block): block is Anthropic.TextBlock => block.type === 'text'
      );

      return {
        message: textBlock?.text || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç',
        toolsUsed: toolsUsed.length > 0 ? toolsUsed : undefined,
        provider: this.name,
        tokensUsed: {
          input: response.usage.input_tokens,
          output: response.usage.output_tokens,
        },
      };
    } catch (error) {
      this.logError('Chat error', error);
      throw error;
    }
  }

  async isAvailable(): Promise<boolean> {
    try {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
      await this.client.messages.create({
        model: this.model,
        max_tokens: 10,
        messages: [{ role: 'user', content: 'test' }],
      });
      return true;
    } catch {
      return false;
    }
  }

  private getSystemPrompt(): string {
    return `–¢—ã ‚Äî AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.

–¢—ã –º–æ–∂–µ—à—å:
1. –ò—Å–∫–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º
2. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏
3. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∂—É—Ä–Ω–∞–ª –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
4. –î–æ–±–∞–≤–ª—è—Ç—å –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª
5. –ß–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (PDF —Ñ–∞–π–ª—ã)
6. –ò—Å–∫–∞—Ç—å —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–∞—Ö Google Drive
7. –†–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–æ—Ç–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–æ—Ç–æ:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π:
- –í—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: YYYY-MM-DD

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.
–Ø–∑—ã–∫ –æ–±—â–µ–Ω–∏—è: —Ä—É—Å—Å–∫–∏–π.

–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: ${new Date().toISOString().split('T')[0]}`;
  }
}
```

**üìù –ú–∞–ø–ø–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ `anthropic.ts`:**

| –ë—ã–ª–æ –≤ anthropic.ts | –°—Ç–∞–ª–æ –≤ ClaudeProvider.ts | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---------------------|---------------------------|-------------|
| `const anthropic = new Anthropic(...)` | `this.client = new Anthropic(...)` | –í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ |
| `config.claudeModel` | `this.model` | –ü–∞—Ä–∞–º–µ—Ç—Ä –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ |
| `config.anthropicApiKey` | `apiKey` –ø–∞—Ä–∞–º–µ—Ç—Ä | –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä |
| `SYSTEM_PROMPT` –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ | `this.getSystemPrompt()` | –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ |
| `export async function processChatMessage(...)` | `async chat(...)` | –ú–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞ |
| –°—Ç—Ä–æ–∫–∏ 262-264 (filter tool_use) | `extractClaudeToolCalls()` | –ê–¥–∞–ø—Ç–µ—Ä |
| –°—Ç—Ä–æ–∫–∏ 282-296 (—Å–æ–∑–¥–∞–Ω–∏–µ tool_result) | `formatClaudeToolResults()` | –ê–¥–∞–ø—Ç–µ—Ä |
| `return { message, toolsUsed }` | `return { message, toolsUsed, provider: this.name, tokensUsed }` | –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è |

**–ö–æ–ø–∏—Ä—É–π—Ç–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- ‚úÖ –í–µ—Å—å –∞–≥–µ–Ω—Ç–Ω—ã–π —Ü–∏–∫–ª (`while (response.stop_reason === 'tool_use')`)
- ‚úÖ –õ–æ–≥–∏–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è tools (`for (const toolUse of toolUseBlocks)`)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (`try/catch` –±–ª–æ–∫–∏)
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (`response.content.find`)

#### –®–∞–≥ 3.2: GeminiProvider

**–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SDK:**
```bash
cd ai-consultant-api
npm install @google/generative-ai
```

**–§–∞–π–ª:** `src/services/ai/providers/GeminiProvider.ts`

```typescript
import { GoogleGenerativeAI } from '@google/generative-ai';
import { BaseAIProvider } from '../AIProvider.js';
import { ChatMessage, ChatResponse, ToolDefinition } from '../types.js';
import {
  convertToGeminiTools,
  extractGeminiFunctionCalls,
  formatGeminiFunctionResults,
} from '../adapters/geminiToolAdapter.js';
import { executeToolCall } from '../../../tools/index.js';

export class GeminiProvider extends BaseAIProvider {
  readonly name = 'Gemini';
  private client: GoogleGenerativeAI;
  private model: string;

  constructor(apiKey: string, model: string = 'gemini-1.5-pro') {
    super();
    this.client = new GoogleGenerativeAI(apiKey);
    this.model = model;
  }

  async chat(
    messages: ChatMessage[],
    tools: ToolDefinition[],
    userId: string
  ): Promise<ChatResponse> {
    try {
      const toolsUsed: string[] = [];
      let iteration = 0;

      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º tools –≤ —Ñ–æ—Ä–º–∞—Ç Gemini
      const geminiTools = convertToGeminiTools(tools);

      // –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å —Å tools
      const model = this.client.getGenerativeModel({
        model: this.model,
        tools: [{ functionDeclarations: geminiTools }],
        systemInstruction: this.getSystemPrompt(),
      });

      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç Gemini
      const geminiHistory = this.convertMessagesToGeminiFormat(messages.slice(0, -1));

      // –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const lastMessage = messages[messages.length - 1];
      const userMessage = typeof lastMessage.content === 'string'
        ? lastMessage.content
        : this.convertContentToGeminiParts(lastMessage.content);

      // –ù–∞—á–∏–Ω–∞–µ–º —á–∞—Ç
      const chat = model.startChat({ history: geminiHistory });

      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
      let result = await chat.sendMessage(userMessage);

      // –ê–≥–µ–Ω—Ç–Ω—ã–π —Ü–∏–∫–ª
      while (iteration < this.MAX_ITERATIONS) {
        iteration++;

        const functionCalls = extractGeminiFunctionCalls(result.response.candidates || []);

        if (functionCalls.length === 0) {
          // –ù–µ—Ç tool calls - –ø–æ–ª—É—á–∏–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
          break;
        }

        // –í—ã–ø–æ–ª–Ω—è–µ–º function calls
        const functionResults = [];
        for (const call of functionCalls) {
          this.log(`Executing function: ${call.name}`);
          toolsUsed.push(call.name);

          try {
            const result = await executeToolCall(call.name, call.input);
            functionResults.push({ id: call.id, result, isError: false });
          } catch (error) {
            const errorMessage = error instanceof Error ? error.message : 'Unknown error';
            functionResults.push({ id: call.id, result: errorMessage, isError: true });
          }
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ
        const formattedResults = formatGeminiFunctionResults(functionResults);
        result = await chat.sendMessage(formattedResults);
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
      const responseText = result.response.text();

      return {
        message: responseText || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç',
        toolsUsed: toolsUsed.length > 0 ? toolsUsed : undefined,
        provider: this.name,
        tokensUsed: {
          input: result.response.usageMetadata?.promptTokenCount || 0,
          output: result.response.usageMetadata?.candidatesTokenCount || 0,
        },
      };
    } catch (error) {
      this.logError('Chat error', error);
      throw error;
    }
  }

  async isAvailable(): Promise<boolean> {
    try {
      const model = this.client.getGenerativeModel({ model: this.model });
      await model.generateContent('test');
      return true;
    } catch {
      return false;
    }
  }

  private getSystemPrompt(): string {
    return `–¢—ã ‚Äî AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.

–¢—ã –º–æ–∂–µ—à—å:
1. –ò—Å–∫–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º
2. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏
3. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∂—É—Ä–Ω–∞–ª –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
4. –î–æ–±–∞–≤–ª—è—Ç—å –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª
5. –ß–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (PDF —Ñ–∞–π–ª—ã)
6. –ò—Å–∫–∞—Ç—å —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–∞—Ö Google Drive
7. –†–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–æ—Ç–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–æ—Ç–æ:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π:
- –í—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: YYYY-MM-DD

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.
–Ø–∑—ã–∫ –æ–±—â–µ–Ω–∏—è: —Ä—É—Å—Å–∫–∏–π.

–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: ${new Date().toISOString().split('T')[0]}`;
  }

  private convertMessagesToGeminiFormat(messages: ChatMessage[]) {
    return messages.map(msg => ({
      role: msg.role === 'assistant' ? 'model' : 'user',
      parts: typeof msg.content === 'string'
        ? [{ text: msg.content }]
        : this.convertContentToGeminiParts(msg.content),
    }));
  }

  private convertContentToGeminiParts(content: any[]) {
    return content.map(block => {
      if (block.type === 'text') {
        return { text: block.text };
      } else if (block.type === 'image') {
        return {
          inlineData: {
            mimeType: block.source.media_type,
            data: block.source.data,
          },
        };
      }
      return { text: '' };
    });
  }
}
```

#### –®–∞–≥ 3.3: OpenAIProvider

**–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SDK:**
```bash
cd ai-consultant-api
npm install openai
```

**–§–∞–π–ª:** `src/services/ai/providers/OpenAIProvider.ts`

```typescript
import OpenAI from 'openai';
import { BaseAIProvider } from '../AIProvider.js';
import { ChatMessage, ChatResponse, ToolDefinition } from '../types.js';
import {
  convertToOpenAITools,
  extractOpenAIToolCalls,
  formatOpenAIToolResults,
} from '../adapters/openaiToolAdapter.js';
import { executeToolCall } from '../../../tools/index.js';

export class OpenAIProvider extends BaseAIProvider {
  readonly name = 'OpenAI';
  private client: OpenAI;
  private model: string;

  constructor(apiKey: string, model: string = 'gpt-4o') {
    super();
    this.client = new OpenAI({ apiKey });
    this.model = model;
  }

  async chat(
    messages: ChatMessage[],
    tools: ToolDefinition[],
    userId: string
  ): Promise<ChatResponse> {
    try {
      const toolsUsed: string[] = [];
      let iteration = 0;

      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º tools –≤ —Ñ–æ—Ä–º–∞—Ç OpenAI
      const openaiTools = convertToOpenAITools(tools);

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const openaiMessages: any[] = [
        { role: 'system', content: this.getSystemPrompt() },
        ...this.convertMessagesToOpenAIFormat(messages),
      ];

      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
      let response = await this.client.chat.completions.create({
        model: this.model,
        messages: openaiMessages,
        tools: openaiTools,
        tool_choice: 'auto',
      });

      // –ê–≥–µ–Ω—Ç–Ω—ã–π —Ü–∏–∫–ª
      while (iteration < this.MAX_ITERATIONS) {
        iteration++;

        const message = response.choices[0].message;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ tool calls
        if (!message.tool_calls || message.tool_calls.length === 0) {
          // –ù–µ—Ç tool calls - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
          break;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
        openaiMessages.push(message);

        // –ò–∑–≤–ª–µ–∫–∞–µ–º tool calls
        const toolCalls = extractOpenAIToolCalls(message);

        // –í—ã–ø–æ–ª–Ω—è–µ–º tools
        const toolResults = [];
        for (const call of toolCalls) {
          this.log(`Executing tool: ${call.name}`);
          toolsUsed.push(call.name);

          try {
            const result = await executeToolCall(call.name, call.input);
            toolResults.push({ id: call.id, result, isError: false });
          } catch (error) {
            const errorMessage = error instanceof Error ? error.message : 'Unknown error';
            toolResults.push({ id: call.id, result: errorMessage, isError: true });
          }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∏—Å—Ç–æ—Ä–∏—é
        openaiMessages.push(...formatOpenAIToolResults(toolResults));

        // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        response = await this.client.chat.completions.create({
          model: this.model,
          messages: openaiMessages,
          tools: openaiTools,
          tool_choice: 'auto',
        });
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
      const finalMessage = response.choices[0].message.content;

      return {
        message: finalMessage || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç',
        toolsUsed: toolsUsed.length > 0 ? toolsUsed : undefined,
        provider: this.name,
        tokensUsed: {
          input: response.usage?.prompt_tokens || 0,
          output: response.usage?.completion_tokens || 0,
        },
      };
    } catch (error) {
      this.logError('Chat error', error);
      throw error;
    }
  }

  async isAvailable(): Promise<boolean> {
    try {
      await this.client.chat.completions.create({
        model: this.model,
        messages: [{ role: 'user', content: 'test' }],
        max_tokens: 5,
      });
      return true;
    } catch {
      return false;
    }
  }

  private getSystemPrompt(): string {
    return `–¢—ã ‚Äî AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.

–¢—ã –º–æ–∂–µ—à—å:
1. –ò—Å–∫–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º
2. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏
3. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∂—É—Ä–Ω–∞–ª –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
4. –î–æ–±–∞–≤–ª—è—Ç—å –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª
5. –ß–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (PDF —Ñ–∞–π–ª—ã)
6. –ò—Å–∫–∞—Ç—å —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–∞—Ö Google Drive
7. –†–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–æ—Ç–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–æ—Ç–æ:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π:
- –í—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: YYYY-MM-DD

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.
–Ø–∑—ã–∫ –æ–±—â–µ–Ω–∏—è: —Ä—É—Å—Å–∫–∏–π.

–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: ${new Date().toISOString().split('T')[0]}`;
  }

  private convertMessagesToOpenAIFormat(messages: ChatMessage[]) {
    return messages.map(msg => {
      if (typeof msg.content === 'string') {
        return { role: msg.role, content: msg.content };
      }

      // –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
      const content = msg.content.map(block => {
        if (block.type === 'text') {
          return { type: 'text', text: block.text };
        } else if (block.type === 'image') {
          return {
            type: 'image_url',
            image_url: {
              url: `data:${block.source.media_type};base64,${block.source.data}`,
            },
          };
        }
        return null;
      }).filter(Boolean);

      return { role: msg.role, content };
    });
  }
}
```

---

### –®–∞–≥ 4: –°–æ–∑–¥–∞—Ç—å —Ñ–∞–±—Ä–∏–∫—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

**–§–∞–π–ª:** `src/services/ai/ProviderFactory.ts`

```typescript
import { AIProvider } from './AIProvider.js';
import { ClaudeProvider } from './providers/ClaudeProvider.js';
import { GeminiProvider } from './providers/GeminiProvider.js';
import { OpenAIProvider } from './providers/OpenAIProvider.js';
import { config } from '../../config/env.js';

export type ProviderType = 'claude' | 'gemini' | 'openai' | 'ollama';

/**
 * –§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
 *
 * –ß–∏—Ç–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é AI_PROVIDER –∏–∑ .env –∏ —Å–æ–∑–¥–∞—ë—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä.
 * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç fallback: –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–ø–∞—Å–Ω–æ–π.
 */
export class ProviderFactory {
  /**
   * –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   */
  static async create(): Promise<AIProvider> {
    const primaryProvider = config.aiProvider as ProviderType;
    const fallbackProvider = config.fallbackProvider as ProviderType | undefined;

    console.log(`[ProviderFactory] Creating primary provider: ${primaryProvider}`);

    // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
    let provider = this.createProvider(primaryProvider);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
    const isAvailable = await provider.isAvailable();

    if (!isAvailable && fallbackProvider) {
      console.warn(
        `[ProviderFactory] Primary provider ${primaryProvider} unavailable, using fallback: ${fallbackProvider}`
      );
      provider = this.createProvider(fallbackProvider);
    }

    return provider;
  }

  /**
   * –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –ø–æ —Ç–∏–ø—É
   */
  private static createProvider(type: ProviderType): AIProvider {
    switch (type) {
      case 'claude':
        if (!config.anthropicApiKey) {
          throw new Error('ANTHROPIC_API_KEY not configured');
        }
        return new ClaudeProvider(config.anthropicApiKey, config.claudeModel);

      case 'gemini':
        if (!config.geminiApiKey) {
          throw new Error('GEMINI_API_KEY not configured');
        }
        return new GeminiProvider(config.geminiApiKey, config.geminiModel);

      case 'openai':
        if (!config.openaiApiKey) {
          throw new Error('OPENAI_API_KEY not configured');
        }
        return new OpenAIProvider(config.openaiApiKey, config.openaiModel);

      case 'ollama':
        throw new Error('Ollama provider not implemented yet');

      default:
        throw new Error(`Unknown provider type: ${type}`);
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
   */
  static getAvailableProviders(): ProviderType[] {
    const available: ProviderType[] = [];

    if (config.anthropicApiKey) available.push('claude');
    if (config.geminiApiKey) available.push('gemini');
    if (config.openaiApiKey) available.push('openai');

    return available;
  }
}
```

**–§–∞–π–ª:** `src/services/ai/index.ts`

```typescript
export * from './types.js';
export * from './AIProvider.js';
export * from './ProviderFactory.js';
export * from './providers/ClaudeProvider.js';
export * from './providers/GeminiProvider.js';
export * from './providers/OpenAIProvider.js';
```

---

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

**–§–∞–π–ª:** `src/config/env.ts`

–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```typescript
import dotenv from 'dotenv';

dotenv.config();

interface Config {
  // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
  supabaseUrl: string;
  supabaseServiceKey: string;
  gasApiUrl: string;
  port: number;
  allowedOrigins: string[];
  maxAgentIterations: number;

  // AI Provider Configuration
  aiProvider: string;                    // claude | gemini | openai | ollama
  fallbackProvider?: string;             // –ó–∞–ø–∞—Å–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä

  // API Keys –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
  anthropicApiKey?: string;              // Claude
  geminiApiKey?: string;                 // Gemini
  openaiApiKey?: string;                 // OpenAI

  // –ú–æ–¥–µ–ª–∏
  claudeModel: string;
  geminiModel: string;
  openaiModel: string;
}

function validateEnv(): Config {
  const supabaseUrl = process.env.SUPABASE_URL;
  const supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY;
  const gasApiUrl = process.env.GAS_API_URL;

  if (!supabaseUrl) {
    throw new Error('SUPABASE_URL is required');
  }

  if (!supabaseServiceKey) {
    throw new Error('SUPABASE_SERVICE_KEY is required');
  }

  if (!gasApiUrl) {
    throw new Error('GAS_API_URL is required');
  }

  // –ü—Ä–æ–≤–∞–π–¥–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const aiProvider = process.env.AI_PROVIDER || 'gemini';

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ API –∫–ª—é—á–∞
  const hasAnthropicKey = !!process.env.ANTHROPIC_API_KEY;
  const hasGeminiKey = !!process.env.GEMINI_API_KEY;
  const hasOpenAIKey = !!process.env.OPENAI_API_KEY;

  if (!hasAnthropicKey && !hasGeminiKey && !hasOpenAIKey) {
    throw new Error(
      'At least one AI provider API key is required: ANTHROPIC_API_KEY, GEMINI_API_KEY, or OPENAI_API_KEY'
    );
  }

  return {
    supabaseUrl,
    supabaseServiceKey,
    gasApiUrl,
    port: parseInt(process.env.PORT || '3001', 10),
    allowedOrigins: process.env.ALLOWED_ORIGINS?.split(',') || [],
    maxAgentIterations: parseInt(process.env.MAX_AGENT_ITERATIONS || '10', 10),

    // AI Provider
    aiProvider,
    fallbackProvider: process.env.FALLBACK_PROVIDER,

    // API Keys
    anthropicApiKey: process.env.ANTHROPIC_API_KEY,
    geminiApiKey: process.env.GEMINI_API_KEY,
    openaiApiKey: process.env.OPENAI_API_KEY,

    // Models
    claudeModel: process.env.CLAUDE_MODEL || 'claude-sonnet-4-20250514',
    geminiModel: process.env.GEMINI_MODEL || 'gemini-1.5-pro',
    openaiModel: process.env.OPENAI_MODEL || 'gpt-4o',
  };
}

export const config = validateEnv();
```

---

### –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç —á–∞—Ç–∞

**–§–∞–π–ª:** `src/routes/chat.ts`

–ó–∞–º–µ–Ω–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `processChatMessage` –∏–∑ `anthropic.ts` –Ω–∞ —Ñ–∞–±—Ä–∏–∫—É:

```typescript
import { Router, Request, Response } from 'express';
import { authenticateUser } from '../middleware/auth.js';
import { ProviderFactory } from '../services/ai/index.js';
import { tools } from '../tools/index.js';
import type { ChatRequest } from '../services/ai/types.js';

const router = Router();

/**
 * POST /api/chat
 *
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞.
 * –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç multi-provider –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.
 */
router.post('/', authenticateUser, async (req: Request, res: Response) => {
  try {
    const { messages } = req.body as ChatRequest;
    const userId = (req as any).userId;

    if (!messages || !Array.isArray(messages)) {
      return res.status(400).json({ error: 'Messages array is required' });
    }

    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä —á–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏–∫—É
    const provider = await ProviderFactory.create();

    console.log(`[Chat] Using provider: ${provider.name}`);

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    const response = await provider.chat(messages, tools, userId);

    // –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
    if (response.tokensUsed) {
      console.log(
        `[Chat] Tokens: ${response.tokensUsed.input} in, ${response.tokensUsed.output} out`
      );
    }

    res.json(response);
  } catch (error) {
    console.error('Chat error:', error);

    if (error instanceof Error) {
      res.status(500).json({ error: error.message });
    } else {
      res.status(500).json({ error: 'Internal server error' });
    }
  }
});

export default router;
```

---

### –®–∞–≥ 7: –û–±–Ω–æ–≤–∏—Ç—å .env —Ñ–∞–π–ª

**–§–∞–π–ª:** `ai-consultant-api/.env`

```env
# Supabase
SUPABASE_URL=https://wslcojroanewczgqtfuk.supabase.co
SUPABASE_SERVICE_KEY=your_service_key_here

# GAS API
GAS_API_URL=https://script.google.com/macros/s/your_gas_id/exec

# Server
PORT=3001
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173

# ============================================
# AI Provider Configuration
# ============================================

# –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: claude | gemini | openai
AI_PROVIDER=gemini

# –ó–∞–ø–∞—Å–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
FALLBACK_PROVIDER=claude

# ============================================
# API Keys (–¥–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤)
# ============================================

# Claude (Anthropic) - https://console.anthropic.com/settings/keys
ANTHROPIC_API_KEY=sk-ant-api03-...

# Gemini (Google) - https://ai.google.dev/
GEMINI_API_KEY=AIza...

# OpenAI - https://platform.openai.com/api-keys
OPENAI_API_KEY=sk-proj-...

# ============================================
# Models (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
# ============================================

# Claude models: claude-sonnet-4-20250514, claude-opus-4-20250514
CLAUDE_MODEL=claude-sonnet-4-20250514

# Gemini models: gemini-1.5-pro, gemini-1.5-flash
GEMINI_MODEL=gemini-1.5-pro

# OpenAI models: gpt-4o, gpt-4-turbo, gpt-3.5-turbo
OPENAI_MODEL=gpt-4o

# ============================================
# Other
# ============================================

MAX_AGENT_ITERATIONS=10
```

---

## üîß –ê–¥–∞–ø—Ç–∞—Ü–∏—è Tool Calling

### –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏

| –ê—Å–ø–µ–∫—Ç | Claude (Anthropic) | Gemini (Google) | OpenAI (GPT) |
|--------|-------------------|-----------------|--------------|
| **–ù–∞–∑–≤–∞–Ω–∏–µ** | Tools | Function Declarations | Functions/Tools |
| **–§–æ—Ä–º–∞—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è** | `tools[]` —Å `input_schema` | `functionDeclarations[]` —Å `parameters` | `tools[]` —Å `function.parameters` |
| **–í—ã–∑–æ–≤** | `tool_use` –±–ª–æ–∫–∏ | `functionCall` –≤ `parts` | `tool_calls[]` –≤ message |
| **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã** | `tool_result` –±–ª–æ–∫–∏ | `functionResponse` –≤ `parts` | –°–æ–æ–±—â–µ–Ω–∏—è —Å `role: "tool"` |
| **ID –≤—ã–∑–æ–≤–∞** | –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è API | –ù—É–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é | –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è API |

### –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–≤–∞—à —Ç–µ–∫—É—â–∏–π)

```typescript
{
  name: "get_equipment_details",
  description: "–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏",
  input_schema: {
    type: "object",
    properties: {
      id: {
        type: "string",
        description: "ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
      }
    },
    required: ["id"]
  }
}
```

–ê–¥–∞–ø—Ç–µ—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç –≤ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –§–∞–π–ª .env

```env
# ===== –û–°–ù–û–í–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
AI_PROVIDER=gemini                    # claude | gemini | openai
FALLBACK_PROVIDER=claude              # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

# ===== API –ö–õ–Æ–ß–ò =====
# –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ

# Claude (–ø–ª–∞—Ç–Ω—ã–π, –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
ANTHROPIC_API_KEY=sk-ant-api03-...   # https://console.anthropic.com/settings/keys

# Gemini (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π tier)
GEMINI_API_KEY=AIza...                # https://ai.google.dev/

# OpenAI (–ø–ª–∞—Ç–Ω—ã–π)
OPENAI_API_KEY=sk-proj-...            # https://platform.openai.com/api-keys

# ===== –ú–û–î–ï–õ–ò =====
# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

CLAUDE_MODEL=claude-sonnet-4-20250514
GEMINI_MODEL=gemini-1.5-pro
OPENAI_MODEL=gpt-4o
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π

#### Gemini (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://ai.google.dev/
2. –ù–∞–∂–∞—Ç—å "Get API key in Google AI Studio"
3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
4. –°–æ–∑–¥–∞—Ç—å API –∫–ª—é—á
5. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á (—Ñ–æ—Ä–º–∞—Ç: `AIza...`)

**–õ–∏–º–∏—Ç—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ tier:**
- 15 requests/minute (gemini-1.5-pro)
- 60 requests/minute (gemini-1.5-flash)

#### Claude (–ø–ª–∞—Ç–Ω—ã–π)
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ https://console.anthropic.com
2. –î–æ–±–∞–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å ($5-10)
3. –°–æ–∑–¥–∞—Ç—å API –∫–ª—é—á –≤ Settings ‚Üí API Keys
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á (—Ñ–æ—Ä–º–∞—Ç: `sk-ant-api03-...`)

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**
- ~$0.05 –∑–∞ –∑–∞–ø—Ä–æ—Å (Sonnet 4.5)
- $10 = ~200 –∑–∞–ø—Ä–æ—Å–æ–≤

#### OpenAI (–ø–ª–∞—Ç–Ω—ã–π)
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ https://platform.openai.com
2. –î–æ–±–∞–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å ($5-20)
3. –°–æ–∑–¥–∞—Ç—å API –∫–ª—é—á
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á (—Ñ–æ—Ä–º–∞—Ç: `sk-proj-...`)

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**
- ~$0.03 –∑–∞ –∑–∞–ø—Ä–æ—Å (GPT-4o)
- $10 = ~300 –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –í ai-consultant-api/
npm run dev
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

–î–æ–±–∞–≤—å—Ç–µ endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

**–§–∞–π–ª:** `src/routes/health.ts`

```typescript
import { Router } from 'express';
import { ProviderFactory } from '../services/ai/index.js';

const router = Router();

router.get('/', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    providers: ProviderFactory.getAvailableProviders(),
    activeProvider: process.env.AI_PROVIDER || 'gemini',
  });
});

export default router;
```

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

–ò–∑–º–µ–Ω—è–π—Ç–µ `AI_PROVIDER` –≤ `.env` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Å–µ—Ä–≤–µ—Ä:

```bash
# –¢–µ—Å—Ç —Å Gemini
AI_PROVIDER=gemini npm run dev

# –¢–µ—Å—Ç —Å Claude
AI_PROVIDER=claude npm run dev

# –¢–µ—Å—Ç —Å OpenAI
AI_PROVIDER=openai npm run dev
```

### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç:

```
"–ù–∞–π–¥–∏ —Ñ–∏–ª—å—Ç—Ä –§–û-0,8"
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ backend:
```
[ProviderFactory] Creating primary provider: gemini
[Gemini] Executing function: get_all_equipment
[Chat] Using provider: Gemini
[Chat] Tokens: 1234 in, 567 out
```

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ fallback

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π:

```env
AI_PROVIDER=claude
ANTHROPIC_API_KEY=invalid_key
FALLBACK_PROVIDER=gemini
```

–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –≤ –ª–æ–≥–∞—Ö:
```
[ProviderFactory] Primary provider claude unavailable, using fallback: gemini
```

---

## üöÄ –î–µ–ø–ª–æ–π –Ω–∞ Railway

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å backend

–í Railway –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ ai-consultant-api —Å–µ—Ä–≤–∏—Å ‚Üí Variables:

```env
AI_PROVIDER=gemini
FALLBACK_PROVIDER=claude

GEMINI_API_KEY=AIza...
ANTHROPIC_API_KEY=sk-ant-api03-...  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

GEMINI_MODEL=gemini-1.5-pro
```

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `package.json` –µ—Å—Ç—å:

```json
{
  "dependencies": {
    "@anthropic-ai/sdk": "^0.30.0",
    "@google/generative-ai": "^0.21.0",
    "openai": "^4.70.0"
  }
}
```

### –®–∞–≥ 3: Push –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
git add .
git commit -m "feat: multi-provider AI architecture"
git push
```

Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –û–±–Ω–∞—Ä—É–∂–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –Ω–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
3. –ü–µ—Ä–µ—Å–æ–±–µ—Ä—ë—Ç –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç backend

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ production

```bash
curl https://your-backend.railway.app/api/health
```

–û—Ç–≤–µ—Ç:
```json
{
  "status": "ok",
  "timestamp": "2025-01-15T10:30:00.000Z",
  "providers": ["gemini", "claude"],
  "activeProvider": "gemini"
}
```

### –®–∞–≥ 5: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–í Railway ‚Üí Logs —Å–º–æ—Ç—Ä–∏—Ç–µ:
```
[ProviderFactory] Creating primary provider: gemini
[Gemini] Chat completed
[Chat] Tokens: 1500 in, 800 out
```

---

## üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. Smart Routing (—É–º–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è)

–í—ã–±–∏—Ä–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞:

**–§–∞–π–ª:** `src/services/ai/SmartRouter.ts`

```typescript
import { AIProvider } from './AIProvider.js';
import { ChatMessage } from './types.js';
import { ClaudeProvider } from './providers/ClaudeProvider.js';
import { GeminiProvider } from './providers/GeminiProvider.js';
import { config } from '../../config/env.js';

export class SmartRouter {
  private claudeProvider?: ClaudeProvider;
  private geminiProvider: GeminiProvider;

  constructor() {
    if (config.anthropicApiKey) {
      this.claudeProvider = new ClaudeProvider(config.anthropicApiKey);
    }
    this.geminiProvider = new GeminiProvider(config.geminiApiKey!);
  }

  /**
   * –í—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞
   */
  selectProvider(messages: ChatMessage[]): AIProvider {
    const lastMessage = messages[messages.length - 1];

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º Claude (–ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)
    if (this.hasImages(lastMessage)) {
      return this.claudeProvider || this.geminiProvider;
    }

    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º Gemini (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
    if (this.isSimpleQuery(lastMessage)) {
      return this.geminiProvider;
    }

    // –°–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å - Claude
    return this.claudeProvider || this.geminiProvider;
  }

  private hasImages(message: ChatMessage): boolean {
    if (typeof message.content === 'string') return false;
    return message.content.some(block => block.type === 'image');
  }

  private isSimpleQuery(message: ChatMessage): boolean {
    const text = typeof message.content === 'string'
      ? message.content
      : message.content.find(b => b.type === 'text')?.text || '';

    // –ü—Ä–æ—Å—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    const simplePatterns = [
      /^–Ω–∞–π–¥–∏/i,
      /^–ø–æ–∫–∞–∂–∏ —Å–ø–∏—Å–æ–∫/i,
      /^–∫–∞–∫–∏–µ –µ—Å—Ç—å/i,
    ];

    return simplePatterns.some(pattern => pattern.test(text));
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ chat.ts:**

```typescript
const router = new SmartRouter();
const provider = router.selectProvider(messages);
```

### 2. Cost Tracking (—É—á—ë—Ç –∑–∞—Ç—Ä–∞—Ç)

**–§–∞–π–ª:** `src/services/ai/CostTracker.ts`

```typescript
interface CostConfig {
  claude: { input: number; output: number };  // $ per 1M tokens
  gemini: { input: number; output: number };
  openai: { input: number; output: number };
}

const COST_PER_MILLION: CostConfig = {
  claude: { input: 3.0, output: 15.0 },
  gemini: { input: 0, output: 0 },  // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π tier
  openai: { input: 2.5, output: 10.0 },
};

export class CostTracker {
  static calculateCost(
    provider: string,
    inputTokens: number,
    outputTokens: number
  ): number {
    const costs = COST_PER_MILLION[provider as keyof CostConfig];
    if (!costs) return 0;

    const inputCost = (inputTokens / 1_000_000) * costs.input;
    const outputCost = (outputTokens / 1_000_000) * costs.output;

    return inputCost + outputCost;
  }

  static logCost(
    provider: string,
    inputTokens: number,
    outputTokens: number
  ): void {
    const cost = this.calculateCost(provider, inputTokens, outputTokens);
    console.log(
      `[CostTracker] ${provider}: ${inputTokens} in + ${outputTokens} out = $${cost.toFixed(4)}`
    );
  }
}
```

### 3. Rate Limiting (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤)

**–§–∞–π–ª:** `src/services/ai/RateLimiter.ts`

```typescript
export class RateLimiter {
  private requests: Map<string, number[]> = new Map();

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å
   * @param provider - –∏–º—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
   * @param limit - –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
   */
  canMakeRequest(provider: string, limit: number): boolean {
    const now = Date.now();
    const minute = 60 * 1000;

    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤
    let timestamps = this.requests.get(provider) || [];

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ (–±–æ–ª–µ–µ –º–∏–Ω—É—Ç—ã –Ω–∞–∑–∞–¥)
    timestamps = timestamps.filter(ts => now - ts < minute);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
    if (timestamps.length >= limit) {
      console.warn(`[RateLimiter] ${provider} rate limit reached (${limit}/min)`);
      return false;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
    timestamps.push(now);
    this.requests.set(provider, timestamps);

    return true;
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```typescript
const rateLimiter = new RateLimiter();

// Gemini: 15 req/min
if (!rateLimiter.canMakeRequest('gemini', 15)) {
  // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
  provider = fallbackProvider;
}
```

### 4. Fallback Chain (—Ü–µ–ø–æ—á–∫–∞ –∑–∞–ø–∞—Å–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤)

**–§–∞–π–ª:** `src/services/ai/FallbackChain.ts`

```typescript
export class FallbackChain {
  private providers: AIProvider[];

  constructor(providers: AIProvider[]) {
    this.providers = providers;
  }

  /**
   * –ü—Ä–æ–±—É–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –ø–æ –æ—á–µ—Ä–µ–¥–∏, –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏—Ç —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
   */
  async chat(
    messages: ChatMessage[],
    tools: ToolDefinition[],
    userId: string
  ): Promise<ChatResponse> {
    let lastError: Error | null = null;

    for (const provider of this.providers) {
      try {
        console.log(`[FallbackChain] Trying ${provider.name}...`);
        const response = await provider.chat(messages, tools, userId);
        console.log(`[FallbackChain] Success with ${provider.name}`);
        return response;
      } catch (error) {
        console.warn(`[FallbackChain] ${provider.name} failed:`, error);
        lastError = error as Error;
        // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ
      }
    }

    throw new Error(
      `All providers failed. Last error: ${lastError?.message}`
    );
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```typescript
const chain = new FallbackChain([
  geminiProvider,    // –ü—Ä–æ–±—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Gemini
  claudeProvider,    // –ï—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ - Claude
  openaiProvider,    // –ï—Å–ª–∏ –∏ Claude –Ω–µ –≤—ã—à–µ–ª - OpenAI
]);

const response = await chain.chat(messages, tools, userId);
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [ ] –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `src/services/ai/`
- [ ] –°–æ–∑–¥–∞—Ç—å `types.ts` —Å –æ–±—â–∏–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏
- [ ] –°–æ–∑–¥–∞—Ç—å `AIProvider.ts` —Å –±–∞–∑–æ–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- [ ] –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `adapters/`
- [ ] –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `providers/`

### –≠—Ç–∞–ø 2: –ê–¥–∞–ø—Ç–µ—Ä—ã
- [ ] **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å** –ª–æ–≥–∏–∫—É –∏–∑ `anthropic.ts` ‚Üí `claudeToolAdapter.ts` ‚≠ê (–≤—ã–Ω–µ—Å—Ç–∏ 3 —Ñ—É–Ω–∫—Ü–∏–∏)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `geminiToolAdapter.ts` (–Ω–æ–≤—ã–π)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `openaiToolAdapter.ts` (–Ω–æ–≤—ã–π, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –≠—Ç–∞–ø 3: –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `@google/generative-ai`
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `openai`
- [ ] **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å** `anthropic.ts` ‚Üí `ClaudeProvider.ts` ‚≠ê (–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `GeminiProvider.ts` (–Ω–æ–≤—ã–π)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `OpenAIProvider.ts` (–Ω–æ–≤—ã–π, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –≠—Ç–∞–ø 4: –§–∞–±—Ä–∏–∫–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `ProviderFactory.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `create()`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `getAvailableProviders()`
- [ ] –°–æ–∑–¥–∞—Ç—å `index.ts` —Å —ç–∫—Å–ø–æ—Ä—Ç–∞–º–∏

### –≠—Ç–∞–ø 5: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `env.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `AI_PROVIDER`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `FALLBACK_PROVIDER`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `.env` —Ñ–∞–π–ª

### –≠—Ç–∞–ø 6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `chat.ts` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∞–±—Ä–∏–∫–∏
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `health.ts` –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- [ ] –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π `anthropic.ts` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –≠—Ç–∞–ø 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Å Gemini
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Å Claude
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Å OpenAI
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å fallback –º–µ—Ö–∞–Ω–∏–∑–º
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ñ–æ—Ç–æ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å tool calling

### –≠—Ç–∞–ø 8: –î–µ–ø–ª–æ–π
- [ ] Push –≤ Git
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Railway
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–ø–ª–æ–π
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ production
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

### –≠—Ç–∞–ø 9: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Smart Router
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Cost Tracker
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Rate Limiter
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Fallback Chain
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

- **Claude (Anthropic)**: https://docs.anthropic.com/claude/reference/messages_post
- **Gemini (Google)**: https://ai.google.dev/api/generate-content
- **OpenAI (GPT)**: https://platform.openai.com/docs/api-reference/chat

### –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π

- **Gemini**: https://ai.google.dev/ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- **Claude**: https://console.anthropic.com/settings/keys (–ø–ª–∞—Ç–Ω–æ)
- **OpenAI**: https://platform.openai.com/api-keys (–ø–ª–∞—Ç–Ω–æ)

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | –ö–∞—á–µ—Å—Ç–≤–æ | –°–∫–æ—Ä–æ—Å—Ç—å | –°—Ç–æ–∏–º–æ—Å—Ç—å | –õ–∏–º–∏—Ç—ã |
|-----------|----------|----------|-----------|--------|
| Claude Sonnet 4.5 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | $0.05/–∑–∞–ø—Ä–æ—Å | –ü–ª–∞—Ç–Ω–æ |
| Gemini 1.5 Pro | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ | 15 req/min |
| GPT-4o | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | $0.03/–∑–∞–ø—Ä–æ—Å | –ü–ª–∞—Ç–Ω–æ |

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É –≤–∞—Å –±—É–¥–µ—Ç:

‚úÖ –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π 3+ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `.env` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Gemini –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
‚úÖ –ì–æ—Ç–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ä—Ç–∞:**
```env
AI_PROVIDER=gemini              # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
FALLBACK_PROVIDER=claude        # –ï—Å–ª–∏ Gemini –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
```

**–£–¥–∞—á–∏ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏! üöÄ**

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2025-02-08*
*–í–µ—Ä—Å–∏—è: 1.0*
